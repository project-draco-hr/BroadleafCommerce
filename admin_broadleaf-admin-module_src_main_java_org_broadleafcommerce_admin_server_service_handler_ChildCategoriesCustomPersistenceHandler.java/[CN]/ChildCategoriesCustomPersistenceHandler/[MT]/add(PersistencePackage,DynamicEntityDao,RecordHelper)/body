{
  JoinStructure joinStructure=(JoinStructure)persistencePackage.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.JOINSTRUCTURE);
  String targetPath=joinStructure.getTargetObjectPath() + "." + joinStructure.getTargetIdProperty();
  String linkedPath=joinStructure.getLinkedObjectPath() + "." + joinStructure.getLinkedIdProperty();
  Long parentId=Long.parseLong(persistencePackage.getEntity().findProperty(linkedPath).getValue());
  Long childId=Long.parseLong(persistencePackage.getEntity().findProperty(targetPath).getValue());
  Category parent=(Category)dynamicEntityDao.retrieve(CategoryImpl.class,parentId);
  Category child=(Category)dynamicEntityDao.retrieve(CategoryImpl.class,childId);
  if (parent.getAllChildCategories().contains(child)) {
    throw new ServiceException("Add unsuccessful. Cannot add a duplicate child category.");
  }
  checkParents(child,parent);
  return helper.getCompatibleModule(OperationType.JOINSTRUCTURE).add(persistencePackage);
}
