{
  try {
    if (StringUtils.isNotEmpty(query)) {
      query=exploitProtectionService.cleanString(query);
    }
  }
 catch (  ServiceException e) {
    query=null;
  }
  if (StringUtils.isNotEmpty(query)) {
    List<SearchFacetDTO> availableFacets=productSearchService.getSearchFacets();
    ProductSearchCriteria searchCriteria=facetService.buildSearchCriteria(request,availableFacets);
    ProductSearchResult result=productSearchService.findProductsByQuery(query,searchCriteria);
    facetService.setActiveFacetResults(result.getFacets(),request);
    model.addAttribute(PRODUCTS_ATTRIBUTE_NAME,result.getProducts());
    model.addAttribute(FACETS_ATTRIBUTE_NAME,result.getFacets());
    model.addAttribute(ORIGINAL_QUERY_ATTRIBUTE_NAME,query);
  }
  return getSearchView();
}
