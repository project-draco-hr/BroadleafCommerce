{
  FieldMetadata fmd=field.getMetadata();
  PersistencePackageRequest ppr=PersistencePackageRequest.fromMetadata(fmd);
  ClassMetadata cmd=adminEntityService.getClassMetadata(ppr);
  List<Field> headerFields=new ArrayList<Field>();
  ListGrid.Type type=null;
  boolean editable=false;
  boolean sortable=false;
  boolean readOnly=false;
  String idProperty="id";
  if (fmd instanceof BasicFieldMetadata) {
    readOnly=((BasicFieldMetadata)fmd).getReadOnly();
    for (    Property p : cmd.getProperties()) {
      if (p.getMetadata() instanceof BasicFieldMetadata) {
        BasicFieldMetadata md=(BasicFieldMetadata)p.getMetadata();
        if (SupportedFieldType.ID.equals(md.getFieldType())) {
          idProperty=md.getName();
        }
        if (md.isProminent() != null && md.isProminent() && !VisibilityEnum.HIDDEN_ALL.equals(md.getVisibility()) && !VisibilityEnum.GRID_HIDDEN.equals(md.getVisibility())) {
          Field hf=createHeaderField(p,md);
          headerFields.add(hf);
        }
      }
    }
    type=ListGrid.Type.TO_ONE;
  }
 else   if (fmd instanceof BasicCollectionMetadata) {
    readOnly=!((BasicCollectionMetadata)fmd).isMutable();
    for (    Property p : cmd.getProperties()) {
      if (p.getMetadata() instanceof BasicFieldMetadata) {
        BasicFieldMetadata md=(BasicFieldMetadata)p.getMetadata();
        if (md.isProminent() != null && md.isProminent() && !VisibilityEnum.HIDDEN_ALL.equals(md.getVisibility()) && !VisibilityEnum.GRID_HIDDEN.equals(md.getVisibility())) {
          Field hf=createHeaderField(p,md);
          headerFields.add(hf);
        }
      }
    }
    type=ListGrid.Type.BASIC;
    if (((BasicCollectionMetadata)fmd).getAddMethodType().equals(AddMethodType.PERSIST)) {
      editable=true;
    }
  }
 else   if (fmd instanceof AdornedTargetCollectionMetadata) {
    readOnly=!((AdornedTargetCollectionMetadata)fmd).isMutable();
    AdornedTargetCollectionMetadata atcmd=(AdornedTargetCollectionMetadata)fmd;
    for (    String fieldName : atcmd.getGridVisibleFields()) {
      Property p=cmd.getPMap().get(fieldName);
      BasicFieldMetadata md=(BasicFieldMetadata)p.getMetadata();
      Field hf=createHeaderField(p,md);
      headerFields.add(hf);
    }
    type=ListGrid.Type.ADORNED;
    if (atcmd.getMaintainedAdornedTargetFields().length > 0) {
      editable=true;
    }
    AdornedTargetList adornedList=(AdornedTargetList)atcmd.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
    sortable=StringUtils.isNotBlank(adornedList.getSortField());
  }
 else   if (fmd instanceof MapMetadata) {
    readOnly=!((MapMetadata)fmd).isMutable();
    MapMetadata mmd=(MapMetadata)fmd;
    Property p2=cmd.getPMap().get("key");
    BasicFieldMetadata keyMd=(BasicFieldMetadata)p2.getMetadata();
    Field hf=createHeaderField(p2,keyMd);
    headerFields.add(hf);
    for (    Property p : cmd.getProperties()) {
      if (p.getMetadata() instanceof BasicFieldMetadata) {
        BasicFieldMetadata md=(BasicFieldMetadata)p.getMetadata();
        if (md.getTargetClass().equals(mmd.getValueClassName())) {
          if (md.isProminent() != null && md.isProminent() && !VisibilityEnum.HIDDEN_ALL.equals(md.getVisibility()) && !VisibilityEnum.GRID_HIDDEN.equals(md.getVisibility())) {
            hf=createHeaderField(p,md);
            headerFields.add(hf);
          }
        }
      }
    }
    type=ListGrid.Type.MAP;
    editable=true;
  }
  String ceilingType="";
  if (fmd instanceof BasicFieldMetadata) {
    ceilingType=cmd.getCeilingType();
  }
 else   if (fmd instanceof CollectionMetadata) {
    ceilingType=((CollectionMetadata)fmd).getCollectionCeilingEntity();
  }
  ListGrid listGrid=createListGrid(ceilingType,headerFields,type,drs,sectionKey,fmd.getOrder(),idProperty);
  listGrid.setSubCollectionFieldName(field.getName());
  listGrid.setFriendlyName(field.getMetadata().getFriendlyName());
  if (StringUtils.isEmpty(listGrid.getFriendlyName())) {
    listGrid.setFriendlyName(field.getName());
  }
  listGrid.setContainingEntityId(containingEntityId);
  listGrid.setReadOnly(readOnly);
  if (editable) {
    listGrid.getRowActions().add(DefaultListGridActions.UPDATE);
  }
  if (readOnly) {
    listGrid.getRowActions().add(DefaultListGridActions.VIEW);
  }
  if (sortable) {
    listGrid.getToolbarActions().add(DefaultListGridActions.REORDER);
  }
  listGrid.getRowActions().add(DefaultListGridActions.REMOVE);
  return listGrid;
}
