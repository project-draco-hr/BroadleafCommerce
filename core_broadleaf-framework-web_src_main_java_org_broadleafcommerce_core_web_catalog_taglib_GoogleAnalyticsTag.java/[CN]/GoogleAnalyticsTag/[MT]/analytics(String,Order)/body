{
  StringBuffer sb=new StringBuffer();
  sb.append("<script type=\"text/javascript\">");
  sb.append("var _gaq = _gaq || [];");
  sb.append("_gaq.push(['_setAccount', '" + webPropertyId + "']);");
  sb.append("_gaq.push(['_trackPageview']);");
  if (order != null) {
    Address paymentAddress=null;
    for (    OrderPayment payment : order.getPayments()) {
      if (payment.isActive() && PaymentType.CREDIT_CARD.equals(payment.getType())) {
        paymentAddress=payment.getBillingAddress();
      }
    }
    sb.append("_gaq.push(['_addTrans','" + order.getId() + "'");
    sb.append(",'" + order.getName() + "'");
    sb.append(",'" + order.getTotal() + "'");
    sb.append(",'" + order.getTotalTax() + "'");
    sb.append(",'" + order.getTotalShipping() + "'");
    if (paymentAddress != null) {
      sb.append(",'" + paymentAddress.getCity() + "'");
      sb.append(",'" + paymentAddress.getState().getName() + "'");
      sb.append(",'" + paymentAddress.getCountry().getName() + "'");
    }
    sb.append("]);");
    for (    FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
      for (      FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {
        DiscreteOrderItem orderItem=(DiscreteOrderItem)fulfillmentGroupItem.getOrderItem();
        sb.append("_gaq.push(['_addItem','" + order.getId() + "'");
        sb.append(",'" + orderItem.getSku().getId() + "'");
        sb.append(",'" + orderItem.getSku().getName() + "'");
        sb.append(",' " + orderItem.getProduct().getDefaultCategory() + "'");
        sb.append(",'" + orderItem.getPrice() + "'");
        sb.append(",'" + orderItem.getQuantity() + "'");
        sb.append("]);");
      }
    }
    sb.append("_gaq.push(['_trackTrans']);");
  }
  sb.append(" (function() {" + "var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;" + "ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';"+ "var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);"+ "})();");
  sb.append("</script>");
  return sb.toString();
}
