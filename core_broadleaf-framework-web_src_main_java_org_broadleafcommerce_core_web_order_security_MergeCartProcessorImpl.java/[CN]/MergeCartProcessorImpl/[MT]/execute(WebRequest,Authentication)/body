{
  Customer loggedInCustomer=customerService.readCustomerByUsername(authResult.getName());
  Customer anonymousCustomer=(Customer)request.getAttribute(CustomerStateRequestProcessor.ANONYMOUS_CUSTOMER_SESSION_ATTRIBUTE_NAME,WebRequest.SCOPE_GLOBAL_SESSION);
  Order cart=null;
  if (anonymousCustomer != null) {
    cart=orderService.findCartForCustomer(anonymousCustomer);
  }
  MergeCartResponse mergeCartResponse;
  try {
    mergeCartResponse=mergeCartService.mergeCart(loggedInCustomer,cart);
  }
 catch (  PricingException e) {
    throw new RuntimeException(e);
  }
catch (  RemoveFromCartException e) {
    throw new RuntimeException(e);
  }
  request.setAttribute(mergeCartResponseKey,mergeCartResponse,WebRequest.SCOPE_GLOBAL_SESSION);
}
