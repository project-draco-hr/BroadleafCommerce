{
  IdGeneration response;
  Query query=em.createNamedQuery("BC_FIND_NEXT_ID");
  query.setParameter("idType",idType);
  query.setHint(getQueryCacheableKey(),false);
  try {
    IdGeneration idGeneration=(IdGeneration)query.getSingleResult();
    response=(IdGeneration)entityConfiguration.createEntityInstance("org.broadleafcommerce.profile.domain.IdGeneration");
    response.setBatchSize(idGeneration.getBatchSize());
    response.setBatchStart(idGeneration.getBatchStart());
    response.setType(idGeneration.getType());
    idGeneration.setBatchStart(idGeneration.getBatchStart() + idGeneration.getBatchSize());
    em.merge(idGeneration);
    em.flush();
  }
 catch (  NoResultException nre) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("No row found in idGenerator table for " + idType + " creating row.");
    }
    response=(IdGeneration)entityConfiguration.createEntityInstance("org.broadleafcommerce.profile.domain.IdGeneration");
    response.setType(idType);
    response.setBatchStart(getDefaultBatchStart());
    response.setBatchSize(getDefaultBatchSize());
    try {
      em.persist(response);
      em.flush();
    }
 catch (    EntityExistsException e) {
      if (LOG.isWarnEnabled()) {
        LOG.warn("Error inserting row id generation for idType " + idType + ".  Requerying table.");
      }
      return findNextId(idType);
    }
  }
catch (  Exception e) {
    em.clear();
    if (LOG.isWarnEnabled()) {
      LOG.warn("Error saving batch start for " + idType + ".  Requerying table.");
    }
    return findNextId(idType);
  }
  return response;
}
