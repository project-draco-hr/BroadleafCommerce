{
  MergeFileSystemAndClassPathXMLApplicationContext mergeContext;
  try {
    ConfigurationOnlyState state=new ConfigurationOnlyState();
    state.setConfigurationOnly(true);
    ConfigurationOnlyState.setState(state);
    Thread.currentThread().setContextClassLoader(this.getClass().getClassLoader());
    String[] contexts=StandardConfigLocations.retrieveAll(StandardConfigLocations.TESTCONTEXTTYPE);
    LinkedHashMap<String,MergeFileSystemAndClassPathXMLApplicationContext.ResourceType> locations=new LinkedHashMap<String,MergeFileSystemAndClassPathXMLApplicationContext.ResourceType>();
    for (    String context : contexts) {
      locations.put(context,MergeFileSystemAndClassPathXMLApplicationContext.ResourceType.CLASSPATH);
    }
    for (    Task task : appContexts) {
      if (task instanceof ClassPathApplicationContextTask) {
        locations.put(((ClassPathApplicationContextTask)task).getPath(),MergeFileSystemAndClassPathXMLApplicationContext.ResourceType.CLASSPATH);
      }
 else       if (task instanceof FileSystemApplicationContextTask) {
        locations.put(((FileSystemApplicationContextTask)task).getPath(),MergeFileSystemAndClassPathXMLApplicationContext.ResourceType.FILESYSTEM);
      }
    }
    mergeContext=new MergeFileSystemAndClassPathXMLApplicationContext(locations,null);
  }
 catch (  Exception e) {
    throw new BuildException(e,getLocation());
  }
 finally {
    ConfigurationOnlyState.setState(null);
  }
  int count=1;
  ExporterTask generatorTask=null;
  try {
    for (    Object configuration : configurationTasks) {
      JPAConfigurationTask configurationTask=(JPAConfigurationTask)configuration;
      log("Executing Hibernate Tool with a " + configurationTask.getDescription());
      @SuppressWarnings("rawtypes") Iterator iterator=generators.iterator();
      while (iterator.hasNext()) {
        generatorTask=(ExporterTask)iterator.next();
        log(count++ + ". task: " + generatorTask.getName());
        generatorTask.setOutputFileName(configurationTask.getDialect() + "_" + configurationTask.getPersistenceUnit()+ ".sql");
        generatorTask.setDestdir(destDir);
        generatorTask.setConfiguration(configurationTask.createConfiguration(mergeContext));
        generatorTask.execute();
      }
    }
  }
 catch (  RuntimeException re) {
    reportException(re,count,generatorTask);
  }
  try {
    if (combinePersistenceUnits) {
      ArrayList<File> combine=new ArrayList<File>();
      for (      Object configuration : configurationTasks) {
        JPAConfigurationTask configurationTask=(JPAConfigurationTask)configuration;
        File[] sqlFiles=destDir.listFiles(new SqlFileFilter());
        for (        File file : sqlFiles) {
          if (file.getName().startsWith(configurationTask.getDialect())) {
            combine.add(file);
          }
        }
        combineFiles(combine);
        combine.clear();
      }
    }
    if (refineFileNames) {
      File[] sqlFiles=destDir.listFiles(new SqlFileFilter());
      for (      File file : sqlFiles) {
        String filename=file.getName();
        String[] starters={"org.hibernate.dialect.","org.broadleafcommerce.profile.util.sql."};
        for (        String starter : starters) {
          if (filename.startsWith(starter)) {
            String newFileName=filename.substring(starter.length(),filename.length());
            file.renameTo(new File(destDir,newFileName));
          }
        }
      }
    }
  }
 catch (  Exception e) {
    throw new BuildException(e,getLocation());
  }
}
