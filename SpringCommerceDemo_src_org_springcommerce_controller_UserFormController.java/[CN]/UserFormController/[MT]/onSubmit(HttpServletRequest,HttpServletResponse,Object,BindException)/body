{
  CreateUser createUser=(CreateUser)command;
  User userFromDb=userService.readUserByUsername(createUser.getUsername());
  if (userFromDb != null) {
    errors.rejectValue("username","username.used",null,null);
  }
  ModelAndView mav=new ModelAndView(getSuccessView(),errors.getModel());
  if (errors.hasErrors()) {
    logger.debug("Error returning back to the form");
    return showForm(request,response,errors);
  }
  User user=new User();
  user.setUsername(createUser.getUsername());
  user.setFirstName(createUser.getFirstName());
  user.setLastName(createUser.getLastName());
  user.setUnencodedPassword(createUser.getPassword());
  user.setEmailAddress(createUser.getEmailAddress());
  user.setChallengeQuestion(createUser.getChallengeQuestion());
  user.setChallengeAnswer(createUser.getChallengeAnswer());
  Set<UserRole> roles=new HashSet<UserRole>();
  roles.add(new UserRole(user,"ROLE_USER"));
  user.setUserRoles(roles);
  userService.saveUser(user);
  emailService.sendEmail(user,TEMPLATE,EMAIL_FROM,EMAIL_SUBJECT);
  mav.addObject("saved",true);
  return mav;
}
