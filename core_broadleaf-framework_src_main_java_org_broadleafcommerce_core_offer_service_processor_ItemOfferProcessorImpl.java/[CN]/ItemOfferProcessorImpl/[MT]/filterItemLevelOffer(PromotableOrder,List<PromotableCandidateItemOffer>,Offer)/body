{
  boolean isNewFormat=!CollectionUtils.isEmpty(offer.getQualifyingItemCriteria()) || !CollectionUtils.isEmpty(offer.getTargetItemCriteria());
  boolean itemLevelQualification=false;
  boolean offerCreated=false;
  for (  PromotableOrderItem promotableOrderItem : order.getDiscountableDiscreteOrderItems(offer.getApplyDiscountToSalePrice())) {
    if (couldOfferApplyToOrder(offer,order,promotableOrderItem)) {
      if (!isNewFormat) {
        PromotableCandidateItemOffer candidate=createCandidateItemOffer(qualifiedItemOffers,offer,promotableOrderItem);
        if (!candidate.getCandidateTargets().contains(promotableOrderItem)) {
          candidate.getCandidateTargets().add(promotableOrderItem);
        }
        offerCreated=true;
        continue;
      }
      itemLevelQualification=true;
      break;
    }
    for (    PromotableFulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
      if (couldOfferApplyToOrder(offer,order,promotableOrderItem,fulfillmentGroup)) {
        if (!isNewFormat) {
          PromotableCandidateItemOffer candidate=createCandidateItemOffer(qualifiedItemOffers,offer,promotableOrderItem);
          if (!candidate.getCandidateTargets().contains(promotableOrderItem)) {
            candidate.getCandidateTargets().add(promotableOrderItem);
          }
          offerCreated=true;
          continue;
        }
        itemLevelQualification=true;
        break;
      }
    }
  }
  if (itemLevelQualification && !offerCreated) {
    CandidatePromotionItems candidates=couldOfferApplyToOrderItems(offer,order.getDiscountableDiscreteOrderItems(offer.getApplyDiscountToSalePrice()));
    PromotableCandidateItemOffer candidateOffer=null;
    if (candidates.isMatchedQualifier()) {
      candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null);
      candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());
    }
    if (candidates.isMatchedTarget() && candidates.isMatchedQualifier()) {
      if (candidateOffer == null) {
        candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null);
      }
      for (      PromotableOrderItem candidateItem : candidates.getCandidateTargets()) {
        PromotableCandidateItemOffer itemOffer=candidateOffer.clone();
        itemOffer.setOrderItem(candidateItem);
        candidateItem.addCandidateItemOffer(itemOffer);
      }
      candidateOffer.getCandidateTargets().addAll(candidates.getCandidateTargets());
    }
  }
}
