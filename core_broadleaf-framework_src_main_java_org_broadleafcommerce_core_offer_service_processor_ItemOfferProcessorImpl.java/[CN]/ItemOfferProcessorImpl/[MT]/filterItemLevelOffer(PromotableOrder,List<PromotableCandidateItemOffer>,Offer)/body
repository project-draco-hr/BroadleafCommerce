{
  boolean itemLevelQualification=false;
  for (  PromotableOrderItem promotableOrderItem : order.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice())) {
    if (couldOfferApplyToOrder(offer,order,promotableOrderItem)) {
      itemLevelQualification=true;
      break;
    }
    for (    PromotableFulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
      if (couldOfferApplyToOrder(offer,order,promotableOrderItem,fulfillmentGroup)) {
        itemLevelQualification=true;
        break;
      }
    }
  }
  if (itemLevelQualification) {
    CandidatePromotionItems candidates=couldOfferApplyToOrderItems(offer,order.getDiscountableOrderItems(offer.getApplyDiscountToSalePrice()));
    PromotableCandidateItemOffer candidateOffer=null;
    if (candidates.isMatchedQualifier()) {
      candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null,order);
      candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());
    }
    if (candidates.isMatchedTarget() && candidates.isMatchedQualifier()) {
      if (candidateOffer == null) {
        candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null,order);
      }
      candidateOffer.getCandidateTargets().addAll(candidates.getCandidateTargets());
    }
  }
}
