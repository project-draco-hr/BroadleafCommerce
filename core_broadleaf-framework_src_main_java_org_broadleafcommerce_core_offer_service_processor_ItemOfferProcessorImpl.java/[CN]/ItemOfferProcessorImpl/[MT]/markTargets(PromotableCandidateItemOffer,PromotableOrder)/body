{
  Offer promotion=itemOffer.getOffer();
  List<PromotableOrderItem> promotableItems=itemOffer.getCandidateTargets();
  List<PromotableOrderItemPriceDetail> priceDetails=buildPriceDetailListFromOrderItems(promotableItems);
  int receiveQtyNeeded=0;
  for (  OfferItemCriteria targetCriteria : itemOffer.getOffer().getTargetItemCriteria()) {
    receiveQtyNeeded+=targetCriteria.getQuantity();
  }
  Collections.sort(priceDetails,getTargetItemComparator(promotion.getApplyDiscountToSalePrice()));
  for (  PromotableOrderItemPriceDetail priceDetail : priceDetails) {
    if (receiveQtyNeeded > 0) {
      int itemQtyAvailableToBeUsedAsTarget=priceDetail.getQuantityAvailableToBeUsedAsTarget(itemOffer);
      if (itemQtyAvailableToBeUsedAsTarget > 0) {
        if ((promotion.getMaxUses() == 0) || (itemOffer.getUses() < promotion.getMaxUses())) {
          int qtyToMarkAsTarget=Math.min(receiveQtyNeeded,itemQtyAvailableToBeUsedAsTarget);
          receiveQtyNeeded-=qtyToMarkAsTarget;
          priceDetail.addPromotionDiscount(itemOffer,itemOffer.getOffer().getTargetItemCriteria(),qtyToMarkAsTarget);
        }
      }
    }
    if (receiveQtyNeeded == 0) {
      itemOffer.addUse();
      break;
    }
  }
  return (receiveQtyNeeded == 0);
}
