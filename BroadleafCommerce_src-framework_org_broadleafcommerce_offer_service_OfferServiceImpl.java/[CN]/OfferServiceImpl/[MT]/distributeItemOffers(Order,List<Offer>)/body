{
  for (  OrderItem item : order.getOrderItems()) {
    List<Offer> stackableOffersList=null;
    for (    Offer offer : offers) {
      if (OfferType.ORDER_ITEM.equals(offer.getType())) {
        if (couldOfferApplyToOrderItem(offer,order,item)) {
          if (offer.isStackable()) {
            if (stackableOffersList == null) {
              stackableOffersList=new ArrayList<Offer>();
            }
            stackableOffersList.add(offer);
          }
 else {
            CandidateOffer candidateOffer=new CandidateOffer(offer,item.getRetailPrice(),item.getSalePrice());
            item.addCandidateItemOffer(candidateOffer);
          }
        }
      }
    }
    if (stackableOffersList != null) {
      StackedOffer stackedOffer=new StackedOffer(stackableOffersList,item.getRetailPrice(),item.getSalePrice());
      item.addCandidateItemOffer(stackedOffer);
    }
    Collections.sort(item.getCandidateItemOffers(),new BeanComparator("priority",new BeanComparator("discountedPrice")));
  }
}
