{
  List<Offer> qualifiedOrderOffers=new ArrayList<Offer>();
  List<ItemOffer> qualifiedItemOffers=new ArrayList<ItemOffer>();
  order.removeAllOffers();
  order.setCandaditeOffers(new ArrayList<Offer>());
  order=pricingService.calculateOrderTotal(order);
  List<Offer> offersWithValidDates=removeOutOfDateOffers(offers);
  if (offersWithValidDates != null) {
    for (    Offer offer : offersWithValidDates) {
      if (offer.getType().equals(OfferType.ORDER)) {
        offer=calculateAtomOfferDiscount(offer,order.getSubTotal());
        qualifiedOrderOffers.add(offer);
      }
      if (offer.getType().equals(OfferType.ORDER_ITEM)) {
        for (        OrderItem orderItem : order.getOrderItems()) {
          if (couldOfferApplyToOrderItem(offer,order,orderItem))           qualifiedItemOffers.add(new CandidateOffer(offer,orderItem.getRetailPrice(),orderItem.getSalePrice()));
        }
      }
      if (offer.getType().equals(OfferType.FULLFILLMENT_GROUP)) {
      }
    }
    Collections.sort(qualifiedOrderOffers,new BeanComparator("priority",new BeanComparator("discountedPrice")));
    Collections.sort(qualifiedItemOffers,new BeanComparator("priority",new BeanComparator("discountedPrice")));
    order.setCandaditeOffers(qualifiedOrderOffers);
    for (    OrderItem orderItem : order.getOrderItems()) {
      orderItem.setCandidateItemOffers(qualifiedItemOffers);
    }
    for (    OrderItem orderItem : order.getOrderItems()) {
      for (      ItemOffer itemOffer : qualifiedItemOffers) {
        if (orderItem.getSalePrice().greaterThan(itemOffer.getDiscountedPrice())) {
          if (itemOffer.getOffers().size() > 0) {
            for (            Offer offer : itemOffer.getOffers()) {
              if (offer.isStackable()) {
                applyItemOffer(orderItem,itemOffer);
              }
            }
          }
 else {
            applyItemOffer(orderItem,itemOffer);
          }
        }
      }
    }
  }
}
