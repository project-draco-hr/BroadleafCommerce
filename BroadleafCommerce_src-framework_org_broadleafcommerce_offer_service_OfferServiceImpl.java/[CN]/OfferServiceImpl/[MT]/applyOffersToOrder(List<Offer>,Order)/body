{
  List<Offer> qualifiedOrderOffers=new ArrayList<Offer>();
  List<CandidateItemOffer> qualifiedItemOffers=new ArrayList<CandidateItemOffer>();
  order=orderService.removeAllOffersFromOrder(order);
  order.setCandidateOffers(new ArrayList<Offer>());
  List<Offer> offersWithValidDates=removeOutOfDateOffers(offers);
  if (offersWithValidDates != null && !offersWithValidDates.isEmpty()) {
    for (    Offer offer : offersWithValidDates) {
      if (offer.getType().equals(OfferType.ORDER)) {
        if (couldOfferApply(offer,order)) {
          offer=calculateAtomOfferDiscount(offer,order.getSubTotal());
          qualifiedOrderOffers.add(offer);
        }
      }
 else       if (offer.getType().equals(OfferType.ORDER_ITEM)) {
        for (        OrderItem orderItem : order.getOrderItems()) {
          if (couldOfferApply(offer,order,orderItem)) {
            CandidateItemOffer candidateOffer=new CandidateItemOfferImpl(orderItem,offer);
            orderItem.addCandidateItemOffer(candidateOffer);
            qualifiedItemOffers.add(candidateOffer);
          }
        }
      }
 else       if (offer.getType().equals(OfferType.FULFILLMENT_GROUP)) {
      }
    }
    Collections.sort(qualifiedOrderOffers,ComparatorUtils.reversedComparator(new BeanComparator("discountPrice")));
    Collections.sort(qualifiedOrderOffers,new BeanComparator("priority"));
    Collections.sort(qualifiedItemOffers,ComparatorUtils.reversedComparator(new BeanComparator("discountedPrice")));
    Collections.sort(qualifiedItemOffers,new BeanComparator("priority"));
    order.setCandidateOffers(qualifiedOrderOffers);
    for (    CandidateItemOffer itemOffer : qualifiedItemOffers) {
      OrderItem orderItem=itemOffer.getOrderItem();
      if (itemOffer.getDiscountedPrice().lessThan(orderItem.getSalePrice())) {
        if (!orderItem.isAllQuantityMarkedForOffer() || itemOffer.getOffer().isApplyDiscountToMarkedItems()) {
          if (orderItem.getAppliedItemOffers() != null && orderItem.getAppliedItemOffers().size() > 0) {
            if (itemOffer.getOffer().isStackable()) {
              applyItemOffer(itemOffer,order);
            }
          }
 else {
            applyItemOffer(itemOffer,order);
          }
        }
      }
    }
    Money newOrderTotal=pricingService.executePricing(order).getSubTotal();
    for (    Offer offer : qualifiedOrderOffers) {
      if (newOrderTotal.greaterThan(order.getSubTotal())) {
        if (!order.isMarkedForOffer() || (order.isMarkedForOffer() && offer.isApplyDiscountToMarkedItems())) {
          if (order.isMarkedForOffer()) {
            if (offer.isStackable()) {
              applyOrderOffer(order,offer);
            }
          }
 else {
            applyOrderOffer(order,offer);
          }
        }
      }
    }
  }
}
