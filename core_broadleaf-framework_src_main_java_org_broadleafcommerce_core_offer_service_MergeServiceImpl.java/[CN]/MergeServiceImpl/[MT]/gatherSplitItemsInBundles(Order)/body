{
  List<DiscreteOrderItem> itemsToRemove=new ArrayList<DiscreteOrderItem>();
  Map<Long,Map<String,Object[]>> gatherMap=new HashMap<Long,Map<String,Object[]>>();
  for (  FulfillmentGroup group : order.getFulfillmentGroups()) {
    Map<String,Object[]> gatheredItem=gatherMap.get(group.getId());
    if (gatheredItem == null) {
      gatheredItem=new HashMap<String,Object[]>();
      gatherMap.put(group.getId(),gatheredItem);
    }
    for (    FulfillmentGroupItem fgItem : group.getFulfillmentGroupItems()) {
      OrderItem orderItem=fgItem.getOrderItem();
      if (orderItem instanceof DiscreteOrderItem && ((DiscreteOrderItem)orderItem).getBundleOrderItem() != null) {
        gatherFulfillmentGroupLinkedDiscreteOrderItem(itemsToRemove,gatheredItem,fgItem,(DiscreteOrderItem)orderItem,null,orderMultishipOptionService.findOrderMultishipOptions(order.getId()),false);
      }
    }
  }
  for (  Map<String,Object[]> values : gatherMap.values()) {
    for (    Object[] item : values.values()) {
      orderItemService.saveOrderItem((OrderItem)item[0]);
      fulfillmentGroupItemDao.save((FulfillmentGroupItem)item[1]);
    }
  }
  for (  DiscreteOrderItem orderItem : itemsToRemove) {
    if (orderItem.getBundleOrderItem() != null) {
      BundleOrderItem bundleOrderItem=orderItem.getBundleOrderItem();
      fulfillmentGroupService.removeOrderItemFromFullfillmentGroups(order,orderItem);
      bundleOrderItem.getDiscreteOrderItems().remove(orderItem);
      orderItem.setBundleOrderItem(null);
      orderItemService.saveOrderItem(bundleOrderItem);
    }
  }
}
