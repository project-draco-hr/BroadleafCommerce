{
  FileWorkArea tempWorkArea=fileService.initializeWorkArea();
  String tempFilename=FilenameUtils.concat(tempWorkArea.getFilePathLocation(),FilenameUtils.separatorsToSystem(getResourcePath(resource.getDescription())));
  File tempFile=new File(tempFilename);
  if (!tempFile.getParentFile().exists()) {
    if (!tempFile.getParentFile().mkdirs()) {
      if (!tempFile.getParentFile().exists()) {
        throw new RuntimeException("Unable to create parent directories for file: " + tempFilename);
      }
    }
  }
  BufferedOutputStream out=null;
  try {
    out=new BufferedOutputStream(new FileOutputStream(tempFile));
    StreamUtils.copy(resource.getInputStream(),out);
    fileService.addOrUpdateResource(tempWorkArea,tempFile,true);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
 finally {
    if (out != null) {
      try {
        out.close();
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
    fileService.closeWorkArea(tempWorkArea);
  }
}
