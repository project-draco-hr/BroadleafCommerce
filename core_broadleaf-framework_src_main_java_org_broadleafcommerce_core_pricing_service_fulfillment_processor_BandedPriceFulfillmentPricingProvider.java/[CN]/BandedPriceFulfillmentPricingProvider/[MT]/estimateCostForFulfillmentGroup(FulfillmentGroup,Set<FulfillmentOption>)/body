{
  FulfillmentEstimationResponse res=new FulfillmentEstimationResponse();
  HashMap<BandedPriceFulfillmentOption,Money> shippingPrices=new HashMap<BandedPriceFulfillmentOption,Money>();
  res.setFulfillmentOptionPrices(shippingPrices);
  for (  FulfillmentOption option : options) {
    if (canCalculateCostForFulfillmentGroup(fulfillmentGroup,option)) {
      BandedPriceFulfillmentOption bandedPriceFulfillmentOption=(BandedPriceFulfillmentOption)option;
      List<FulfillmentPriceBand> bands=bandedPriceFulfillmentOption.getBands();
      if (bands == null || bands.isEmpty()) {
        throw new IllegalStateException("There were no Fulfillment Price Bands configred for a BandedPriceFulfillmentOption with ID: " + bandedPriceFulfillmentOption.getId());
      }
      BigDecimal retailTotal=new BigDecimal(0D);
      BigDecimal flatTotal=new BigDecimal(0D);
      for (      FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {
        boolean addToRetailTotal=true;
        if (option.getUseFlatRates()) {
          Sku sku=null;
          if (fulfillmentGroupItem.getOrderItem() instanceof DiscreteOrderItem) {
            sku=((DiscreteOrderItem)fulfillmentGroupItem.getOrderItem()).getSku();
          }
 else           if (fulfillmentGroupItem.getOrderItem() instanceof BundleOrderItem) {
            sku=((BundleOrderItem)fulfillmentGroupItem.getOrderItem()).getSku();
          }
          if (sku != null) {
            BigDecimal rate=sku.getFulfillmentFlatRates().get(option);
            if (rate != null) {
              addToRetailTotal=false;
              flatTotal=flatTotal.add(rate);
            }
          }
        }
        if (addToRetailTotal) {
          BigDecimal price=(fulfillmentGroupItem.getRetailPrice() != null) ? fulfillmentGroupItem.getRetailPrice().getAmount().multiply(BigDecimal.valueOf(fulfillmentGroupItem.getQuantity())) : null;
          if (price == null) {
            price=fulfillmentGroupItem.getOrderItem().getRetailPrice().getAmount().multiply(BigDecimal.valueOf(fulfillmentGroupItem.getQuantity()));
          }
          retailTotal=retailTotal.add(price);
        }
      }
      BigDecimal fulfillmentAmount=new BigDecimal(0D);
      for (      FulfillmentPriceBand band : bands) {
        BigDecimal bandRetailPriceMinimumAmount=band.getRetailPriceMinimumAmount();
        if (retailTotal.compareTo(bandRetailPriceMinimumAmount) >= 0) {
          FulfillmentBandResultAmountType resultAmountType=band.getResultAmountType();
          if (FulfillmentBandResultAmountType.RATE.equals(resultAmountType)) {
            if (fulfillmentAmount.compareTo(new BigDecimal(0D)) == 0 || band.getResultAmount().compareTo(fulfillmentAmount) <= 0) {
              fulfillmentAmount=band.getResultAmount();
            }
          }
 else           if (FulfillmentBandResultAmountType.PERCENTAGE.equals(resultAmountType)) {
            BigDecimal resultAmount=retailTotal.multiply(band.getResultAmount());
            if (fulfillmentAmount.compareTo(new BigDecimal(0D)) == 0 || resultAmount.compareTo(fulfillmentAmount) <= 0) {
              fulfillmentAmount=resultAmount;
            }
          }
 else {
            LOG.warn("Unknown FulfillmentBandResultAmountType: " + resultAmountType.getType() + " Should be RATE or PERCENTAGE. Ignoring.");
          }
        }
      }
      fulfillmentAmount=fulfillmentAmount.add(flatTotal);
      shippingPrices.put(bandedPriceFulfillmentOption,new Money(fulfillmentAmount));
    }
  }
  return res;
}
