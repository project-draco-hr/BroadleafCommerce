{
  OrderItem addedItem;
  List<OrderItem> orderItems=order.getOrderItems();
  boolean containsItem=orderItems.contains(newOrderItem);
  if (rollupOrderItems && containsItem) {
    OrderItem itemFromOrder=orderItems.get(orderItems.indexOf(newOrderItem));
    itemFromOrder.setQuantity(itemFromOrder.getQuantity() + newOrderItem.getQuantity());
    addedItem=itemFromOrder;
  }
 else {
    if (containsItem) {
      OrderItem itemFromOrder=orderItems.get(orderItems.indexOf(newOrderItem));
      itemFromOrder.setQuantity(newOrderItem.getQuantity());
      addedItem=itemFromOrder;
    }
 else {
      orderItems.add(newOrderItem);
      newOrderItem.setOrder(order);
      addedItem=newOrderItem;
    }
  }
  order=updateOrder(order);
  return order.getOrderItems().get(order.getOrderItems().indexOf(addedItem));
}
