{
  List<FullfillmentGroup> currentFullfillmentGroups=fullfillmentGroupDao.readFullfillmentGroupsForOrder(order);
  DefaultFullfillmentGroup dfg;
  try {
    dfg=fullfillmentGroupDao.readDefaultFullfillmentGroupForOrder(order);
  }
 catch (  NoResultException nre) {
    return fullfillmentGroupDao.maintainDefaultFullfillmentGroup(createDefaultFulfillmentGroupFromFulfillmentGroup(fullfillmentGroup,order.getId()));
  }
  if (dfg.getId().equals(fullfillmentGroup.getId())) {
    return fullfillmentGroupDao.maintainDefaultFullfillmentGroup(createDefaultFulfillmentGroupFromFulfillmentGroup(fullfillmentGroup,order.getId()));
  }
 else   if (currentFullfillmentGroups.size() == 1) {
    List<OrderItem> orderItems=orderItemDao.readOrderItemsForOrder(order);
    List<FullfillmentGroupItem> fgItems=new ArrayList<FullfillmentGroupItem>();
    for (    OrderItem orderItem : orderItems) {
      fgItems.add(createFulfillmentGroupItemFromOrderItem(orderItem,dfg.getId()));
    }
    for (    FullfillmentGroupItem fullfillmentGroupItem : fullfillmentGroup.getFullfillmentGroupItems()) {
      fgItems.remove(fullfillmentGroupItem);
    }
    dfg.setFullfillmentGroupItems(fgItems);
    fullfillmentGroupDao.maintainDefaultFullfillmentGroup(dfg);
    fullfillmentGroup.setOrderId(order.getId());
    return fullfillmentGroupDao.maintainFullfillmentGroup(fullfillmentGroup);
  }
 else {
    fullfillmentGroup.setOrderId(order.getId());
    for (    FullfillmentGroupItem fgItem : fullfillmentGroup.getFullfillmentGroupItems()) {
      for (      FullfillmentGroup fg : order.getFullfillmentGroups()) {
        for (        FullfillmentGroupItem tempFgi : fg.getFullfillmentGroupItems()) {
          if (tempFgi.getOrderItem().getId().equals(fgItem.getId())) {
            fg.getFullfillmentGroupItems().remove(fg);
            fullfillmentGroupDao.maintainFullfillmentGroup(fg);
          }
        }
      }
    }
    return fullfillmentGroupDao.maintainFullfillmentGroup(fullfillmentGroup);
  }
}
