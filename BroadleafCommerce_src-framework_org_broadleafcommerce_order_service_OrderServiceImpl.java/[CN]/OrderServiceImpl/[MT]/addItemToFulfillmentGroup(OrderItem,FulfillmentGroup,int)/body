{
  FulfillmentGroupItem fgi=null;
  Order order=orderDao.readOrderById(item.getOrderId());
  if (fulfillmentGroup.getId() == null) {
    fulfillmentGroup=addFulfillmentGroupToOrder(order,fulfillmentGroup);
  }
  order=orderDao.readOrderById(item.getOrderId());
  for (Iterator<FulfillmentGroup> fgIterator=order.getFulfillmentGroups().iterator(); fgIterator.hasNext(); ) {
    FulfillmentGroup fg=fgIterator.next();
    if (fg.getFulfillmentGroupItems() != null) {
      List<FulfillmentGroupItem> itemsToRemove=new ArrayList<FulfillmentGroupItem>();
      for (Iterator<FulfillmentGroupItem> fgiIterator=fg.getFulfillmentGroupItems().iterator(); fgiIterator.hasNext(); ) {
        FulfillmentGroupItem tempFgi=fgiIterator.next();
        if (tempFgi.getOrderItem().getId().equals(item.getId())) {
          fgi=tempFgi;
          itemsToRemove.add(fgi);
        }
      }
      if (!itemsToRemove.isEmpty()) {
        fg.getFulfillmentGroupItems().remove(itemsToRemove);
        fulfillmentGroupDao.maintainFulfillmentGroup(fg);
      }
    }
  }
  if (fgi == null) {
    fgi=createFulfillmentGroupItemFromOrderItem(item,fulfillmentGroup.getId());
  }
  if (fulfillmentGroup.getType() == null) {
    fulfillmentGroup.addFulfillmentGroupItem(fgi);
  }
  fulfillmentGroup=fulfillmentGroupDao.maintainFulfillmentGroup(fulfillmentGroup);
  fgi.setFulfillmentGroupId(fulfillmentGroup.getId());
  fgi=fulfillmentGroupItemDao.maintainFulfillmentGroupItem(fgi);
  return fulfillmentGroup;
}
