{
  FulfillmentGroup dfg=findDefaultFulfillmentGroupForOrder(order);
  if (dfg == null) {
    dfg=createDefaultFulfillmentGroup(order,fulfillmentGroup.getAddress());
    order.getFulfillmentGroups().add(dfg);
    order=updateOrder(order);
    return order.getFulfillmentGroups().get(order.getFulfillmentGroups().indexOf(dfg));
  }
  if (dfg.equals(fulfillmentGroup)) {
    fulfillmentGroup.setType(FulfillmentGroupType.DEFAULT);
    order.getFulfillmentGroups().remove(dfg);
    order.getFulfillmentGroups().add(fulfillmentGroup);
    order=updateOrder(order);
    fulfillmentGroupDao.delete(dfg);
    return order.getFulfillmentGroups().get(order.getFulfillmentGroups().indexOf(fulfillmentGroup));
  }
 else {
    fulfillmentGroup.setOrder(order);
    for (    FulfillmentGroupItem fgItem : fulfillmentGroup.getFulfillmentGroupItems()) {
      for (      FulfillmentGroup fg : order.getFulfillmentGroups()) {
        fg.getFulfillmentGroupItems().remove(fgItem);
        fulfillmentGroupItemDao.delete(fgItem);
      }
    }
    order.getFulfillmentGroups().add(fulfillmentGroup);
    order=updateOrder(order);
    return order.getFulfillmentGroups().get(order.getFulfillmentGroups().indexOf(fulfillmentGroup));
  }
}
