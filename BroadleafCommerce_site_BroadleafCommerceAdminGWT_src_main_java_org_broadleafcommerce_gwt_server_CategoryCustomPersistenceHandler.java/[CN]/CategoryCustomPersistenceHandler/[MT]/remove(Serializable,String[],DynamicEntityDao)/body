{
  Category category=(Category)instance;
  CriteriaBuilder criteriaBuilder=dynamicEntityDao.getEntityManager().getCriteriaBuilder();
  CriteriaQuery<Product> query=criteriaBuilder.createQuery(Product.class);
  Root<ProductImpl> root=query.from(ProductImpl.class);
  query.where(criteriaBuilder.equal(root.get("defaultCategory"),category));
  query.select(root);
  TypedQuery<Product> productQuery=dynamicEntityDao.getEntityManager().createQuery(query);
  List<Product> products=productQuery.getResultList();
  if (!products.isEmpty()) {
    StringBuffer sb=new StringBuffer();
    sb.append("Cannot delete category (");
    sb.append(category.getId());
    sb.append(",");
    sb.append(category.getName());
    sb.append("). There are Products that reference it as the default category. These products must first be updated to a different default category before this category can be deleted. ");
    sb.append("\nThe products in question are: ");
    for (    Product product : products) {
      sb.append("\n");
      sb.append("(");
      sb.append(product.getId());
      sb.append(",");
      sb.append(product.getName());
      sb.append(")");
    }
    throw new ServiceException(sb.toString());
  }
  dynamicEntityDao.remove(instance);
}
