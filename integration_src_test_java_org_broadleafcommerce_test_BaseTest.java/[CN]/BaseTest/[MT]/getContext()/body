{
  try {
    if (mergeContext == null) {
      String[] contexts=StandardConfigLocations.retrieveAll(StandardConfigLocations.TESTCONTEXTTYPE);
      List<String> additionalContexts=new ArrayList<String>(moduleContexts);
      additionalContexts.add("bl-open-admin-contentClient-applicationContext.xml");
      additionalContexts.add("bl-open-admin-contentCreator-applicationContext.xml");
      additionalContexts.add("bl-admin-applicationContext.xml");
      additionalContexts.add("bl-applicationContext-test.xml");
      if (ManagementFactory.getRuntimeMXBean().getInputArguments().contains("-Dlegacy=true")) {
        additionalContexts.add("bl-applicationContext-test-legacy.xml");
      }
      String[] strArray=new String[additionalContexts.size()];
      mergeContext=new MergeClassPathXMLApplicationContext(contexts,additionalContexts.toArray(strArray));
      RequestContextHolder.setRequestAttributes(new ServletRequestAttributes(new MockHttpServletRequest()));
      mergeContext.getBeanFactory().registerScope("request",new RequestScope());
      BroadleafRequestContext context=BroadleafRequestContext.getBroadleafRequestContext();
      context.getAdditionalProperties().put(BroadleafRequestProcessor.USE_LEGACY_DEFAULT_CATEGORY_MODE,true);
    }
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  return mergeContext;
}
