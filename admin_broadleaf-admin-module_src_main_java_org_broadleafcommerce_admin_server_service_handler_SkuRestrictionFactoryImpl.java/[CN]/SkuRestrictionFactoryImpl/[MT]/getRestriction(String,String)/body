{
  final Restriction delegateRestriction=delegate.getRestriction(type,propertyId);
  return new Restriction().withFilterValueConverter(delegateRestriction.getFilterValueConverter()).withPredicateProvider(new PredicateProvider(){
    @Override public Predicate buildPredicate(    CriteriaBuilder builder,    FieldPathBuilder fieldPathBuilder,    From root,    String ceilingEntity,    String fullPropertyName,    Path explicitPath,    List directValues){
      FieldPath fieldPath=fieldPathBuilder.getFieldPath(root,fullPropertyName);
      if ((StringUtils.isNotEmpty(skuPropertyPrefix) && fullPropertyName.startsWith(skuPropertyPrefix)) || (StringUtils.isEmpty(skuPropertyPrefix) && CollectionUtils.isEmpty(fieldPath.getAssociationPath()))) {
        Path skuIdPath=fieldPathBuilder.getPath(root,getSkuPropertyPrefix() + "id",builder);
        Subquery<Long> additionalSkusSubQuery=fieldPathBuilder.getCriteria().subquery(Long.class);
        Root<SkuImpl> additionalSkusRoot=additionalSkusSubQuery.from(SkuImpl.class);
        additionalSkusSubQuery.select(additionalSkusRoot.get("id").as(Long.class));
        Path additionalSkusTargetPropertyPath=fieldPathBuilder.getPath(additionalSkusRoot,fullPropertyName.replace(getSkuPropertyPrefix(),""),builder);
        Path defaultSkuPropertyPath=fieldPathBuilder.getPath(additionalSkusRoot,DEFAULT_SKU_PATH_PREFIX + fullPropertyName.replace(getSkuPropertyPrefix(),""),builder);
        Path additionalSkusProductPath=fieldPathBuilder.getPath(additionalSkusRoot,"product",builder);
        Subquery<Long> hardcodedPropertySubquery=fieldPathBuilder.getCriteria().subquery(Long.class);
        Root<SkuImpl> hardcodedPropertyRoot=hardcodedPropertySubquery.from(SkuImpl.class);
        hardcodedPropertySubquery.select(hardcodedPropertyRoot.get("id").as(Long.class));
        Path hardcodedPropertyTargetPath=fieldPathBuilder.getPath(hardcodedPropertyRoot,fullPropertyName.replace(getSkuPropertyPrefix(),""),builder);
        Predicate propertyExpression;
        Predicate defaultSkuExpression;
        if (delegateRestriction.getPredicateProvider() instanceof LikePredicateProvider) {
          propertyExpression=builder.like(builder.lower(hardcodedPropertyTargetPath),((String)directValues.get(0)).toLowerCase());
          defaultSkuExpression=builder.like(builder.lower(defaultSkuPropertyPath),((String)directValues.get(0)).toLowerCase());
        }
 else         if (delegateRestriction.getPredicateProvider() instanceof IsNullPredicateProvider) {
          propertyExpression=builder.isNull(hardcodedPropertyTargetPath);
          defaultSkuExpression=builder.isNull(defaultSkuPropertyPath);
        }
 else         if (delegateRestriction.getPredicateProvider() instanceof BetweenDatePredicateProvider) {
          if (directValues.size() == 2) {
            if (directValues.get(0) == null) {
              propertyExpression=builder.lessThan(hardcodedPropertyTargetPath,(Comparable)directValues.get(1));
              defaultSkuExpression=builder.lessThan(defaultSkuPropertyPath,(Comparable)directValues.get(1));
            }
 else             if (directValues.get(1) == null) {
              propertyExpression=builder.greaterThanOrEqualTo(hardcodedPropertyTargetPath,(Comparable)directValues.get(0));
              defaultSkuExpression=builder.greaterThanOrEqualTo(defaultSkuPropertyPath,(Comparable)directValues.get(0));
            }
 else {
              propertyExpression=builder.between(hardcodedPropertyTargetPath,(Comparable)directValues.get(0),(Comparable)directValues.get(1));
              defaultSkuExpression=builder.between(defaultSkuPropertyPath,(Comparable)directValues.get(0),(Comparable)directValues.get(1));
            }
          }
 else {
            propertyExpression=builder.equal(hardcodedPropertyTargetPath,directValues.get(0));
            defaultSkuExpression=builder.equal(defaultSkuPropertyPath,directValues.get(0));
          }
        }
 else         if (delegateRestriction.getPredicateProvider() instanceof BetweenPredicateProvider) {
          if (directValues.size() > 1) {
            propertyExpression=builder.between(hardcodedPropertyTargetPath,(Comparable)directValues.get(0),(Comparable)directValues.get(1));
            defaultSkuExpression=builder.between(defaultSkuPropertyPath,(Comparable)directValues.get(0),(Comparable)directValues.get(1));
          }
 else {
            propertyExpression=builder.equal(hardcodedPropertyTargetPath,directValues.get(0));
            defaultSkuExpression=builder.equal(defaultSkuPropertyPath,directValues.get(0));
          }
        }
 else         if (delegateRestriction.getPredicateProvider() instanceof CollectionSizeEqualPredicateProvider) {
          propertyExpression=builder.equal(builder.size(hardcodedPropertyTargetPath),directValues.get(0));
          defaultSkuExpression=builder.equal(builder.size(defaultSkuPropertyPath),directValues.get(0));
        }
 else         if (delegateRestriction.getPredicateProvider() instanceof EqPredicateProvider) {
          propertyExpression=hardcodedPropertyTargetPath.in(directValues);
          defaultSkuExpression=defaultSkuPropertyPath.in(directValues);
        }
 else {
          throw new IllegalArgumentException("Unknown PredicateProvider instance: " + delegateRestriction.getPredicateProvider().getClass().getName());
        }
        List<Predicate> subRestrictions=new ArrayList<Predicate>();
        subRestrictions.add(builder.and(builder.isNull(additionalSkusTargetPropertyPath),builder.isNotNull(additionalSkusProductPath),defaultSkuExpression));
        additionalSkusSubQuery.where(subRestrictions.toArray(new Predicate[subRestrictions.size()]));
        List<Predicate> hardcodedPropertyRestrictions=new ArrayList<Predicate>();
        hardcodedPropertyRestrictions.add(builder.and(builder.isNotNull(hardcodedPropertyTargetPath),propertyExpression));
        hardcodedPropertySubquery.where(hardcodedPropertyRestrictions.toArray(new Predicate[hardcodedPropertyRestrictions.size()]));
        return builder.or(skuIdPath.in(additionalSkusSubQuery),skuIdPath.in(hardcodedPropertySubquery));
      }
      return delegateRestriction.getPredicateProvider().buildPredicate(builder,fieldPathBuilder,root,ceilingEntity,fullPropertyName,explicitPath,directValues);
    }
  }
);
}
