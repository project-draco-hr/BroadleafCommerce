{
  if (!environments.contains(defaultEnvironment)) {
    throw new AssertionError("Default environment '" + defaultEnvironment + "' not listed in environment list");
  }
  if (keyResolver == null) {
    keyResolver=new SystemPropertyRuntimeEnvironmentKeyResolver();
  }
  String environment=determineEnvironment();
  Resource[] propertiesLocation=createPropertiesResource(environment);
  Resource[] commonLocation=createCommonResource();
  ArrayList<Resource> allLocations=new ArrayList<Resource>();
  for (  Resource resource : commonLocation) {
    if (resource.exists()) {
      allLocations.add(resource);
    }
  }
  for (  Resource resource : propertiesLocation) {
    if (resource.exists()) {
      allLocations.add(resource);
    }
  }
  setLocations(allLocations.toArray(new Resource[]{}));
  validateProperties();
}
