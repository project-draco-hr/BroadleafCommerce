{
  CartOperationRequest request=context.getSeedData();
  Order order=request.getOrder();
  if (CollectionUtils.isNotEmpty(request.getMultishipOptionsToDelete())) {
    for (    Long[] pack : request.getMultishipOptionsToDelete()) {
      if (pack[1] == null) {
        orderMultishipOptionService.deleteOrderItemOrderMultishipOptions(pack[0]);
      }
 else {
        orderMultishipOptionService.deleteOrderItemOrderMultishipOptions(pack[0],pack[1].intValue());
      }
    }
  }
  if (CollectionUtils.isNotEmpty(request.getFgisToDelete())) {
    for (    FulfillmentGroupItem fgi : request.getFgisToDelete()) {
      for (      FulfillmentGroup fg : order.getFulfillmentGroups()) {
        ListIterator<FulfillmentGroupItem> fgItemIter=fg.getFulfillmentGroupItems().listIterator();
        while (fgItemIter.hasNext()) {
          FulfillmentGroupItem fgi2=fgItemIter.next();
          if (fgi2 == fgi) {
            fgItemIter.remove();
            fgItemDao.delete(fgi2);
          }
        }
      }
    }
  }
  for (  OrderItem oi : request.getOisToDelete()) {
    order.getOrderItems().remove(oi);
    orderItemService.delete(oi);
    if (oi.getParentOrderItem() != null) {
      OrderItem parentItem=oi.getParentOrderItem();
      parentItem.getChildOrderItems().remove(oi);
    }
  }
  Map<OrderItem,List<FulfillmentGroupItem>> oiFgiMap=new HashMap<OrderItem,List<FulfillmentGroupItem>>();
  Map<OrderItem,OrderItem> savedOrderItems=new HashMap<OrderItem,OrderItem>();
  for (  OrderItem oi : order.getOrderItems()) {
    if (oi instanceof BundleOrderItem) {
      for (      OrderItem doi : ((BundleOrderItem)oi).getDiscreteOrderItems()) {
        getOiFgiMap(order,oiFgiMap,doi);
        savedOrderItems.put(doi,orderItemService.saveOrderItem(doi));
      }
    }
 else {
      getOiFgiMap(order,oiFgiMap,oi);
    }
    savedOrderItems.put(oi,orderItemService.saveOrderItem(oi));
  }
  for (  Entry<OrderItem,OrderItem> entry : savedOrderItems.entrySet()) {
    if (entry.getKey() instanceof BundleOrderItem) {
      order.getOrderItems().remove(entry.getKey());
      order.getOrderItems().add(savedOrderItems.get(entry.getKey()));
    }
  }
  for (  Entry<OrderItem,OrderItem> entry : savedOrderItems.entrySet()) {
    if (!(entry.getKey() instanceof BundleOrderItem)) {
      if (entry.getKey() instanceof DiscreteOrderItem && ((DiscreteOrderItem)entry.getKey()).getBundleOrderItem() != null) {
        DiscreteOrderItem doi=(DiscreteOrderItem)entry.getKey();
        DiscreteOrderItem savedDoi=(DiscreteOrderItem)entry.getValue();
        BundleOrderItem containingSavedBundle=(BundleOrderItem)savedOrderItems.get(doi.getBundleOrderItem());
        containingSavedBundle.getDiscreteOrderItems().remove(doi);
        containingSavedBundle.getDiscreteOrderItems().add(savedDoi);
        savedDoi.setBundleOrderItem(containingSavedBundle);
      }
 else {
        order.getOrderItems().remove(entry.getKey());
        order.getOrderItems().add(entry.getValue());
      }
    }
  }
  for (  Entry<OrderItem,List<FulfillmentGroupItem>> entry : oiFgiMap.entrySet()) {
    if (entry.getKey() == request.getOrderItem()) {
      request.setOrderItem(savedOrderItems.get(entry.getKey()));
    }
    for (    FulfillmentGroupItem fgi : entry.getValue()) {
      fgi.setOrderItem(savedOrderItems.get(entry.getKey()));
    }
  }
  for (  OrderItem oi : order.getOrderItems()) {
    if (oi.getId().equals(request.getItemRequest().getParentOrderItemId())) {
      oi.getChildOrderItems().add(request.getOrderItem());
    }
  }
  preSaveOperation(request);
  order=orderService.save(order,request.isPriceOrder());
  request.setOrder(order);
  return context;
}
