{
  WebApplicationContext applicationContext=WebApplicationContextUtils.getWebApplicationContext(request.getSession().getServletContext());
  CustomerState customerState=(CustomerState)applicationContext.getBean("customerState");
  Customer requestCustomer;
  checkSession: {
    Customer sessionCustomer=customerState.getCustomer(request);
    if (sessionCustomer != null) {
      requestCustomer=sessionCustomer;
      break checkSession;
    }
    String cookieCustomerIdVal=CookieUtils.getCookieValue(request,CookieUtils.CUSTOMER_COOKIE_NAME);
    Long cookieCustomerId=null;
    if (cookieCustomerIdVal != null) {
      cookieCustomerId=new Long(cookieCustomerIdVal);
    }
    CustomerService customerService=(CustomerService)applicationContext.getBean("customerService");
    if (cookieCustomerId != null) {
      Customer persistedCookieCustomer=customerService.readCustomerById(cookieCustomerId);
      if (persistedCookieCustomer != null) {
        customerState.setCustomer(persistedCookieCustomer,request);
        requestCustomer=persistedCookieCustomer;
        break checkSession;
      }
 else {
        Customer anonymousCookieCustomer=customerService.createCustomerFromId(cookieCustomerId);
        customerState.setCustomer(anonymousCookieCustomer,request);
        requestCustomer=anonymousCookieCustomer;
        break checkSession;
      }
    }
    Customer firstTimeCustomer=customerService.createCustomerFromId(null);
    CookieUtils.setCookieValue(response,CookieUtils.CUSTOMER_COOKIE_NAME,firstTimeCustomer.getId() + "","/",604800);
    customerState.setCustomer(firstTimeCustomer,request);
    requestCustomer=firstTimeCustomer;
  }
  request.setAttribute(CUSTOMER_REQUEST_ATTR_NAME,requestCustomer);
  return true;
}
