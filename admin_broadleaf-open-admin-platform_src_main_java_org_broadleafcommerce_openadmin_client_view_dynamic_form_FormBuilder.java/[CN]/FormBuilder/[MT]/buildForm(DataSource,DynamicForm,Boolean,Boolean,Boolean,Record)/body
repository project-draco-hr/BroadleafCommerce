{
  String[] recordAttributes=currentRecord == null ? null : currentRecord.getAttributes();
  if (recordAttributes != null) {
    Arrays.sort(recordAttributes);
  }
  form.setDataSource(dataSource);
  Map<String,List<FormItem>> sections=new HashMap<String,List<FormItem>>();
  Map<String,Boolean> sectionCollapsed=new HashMap<String,Boolean>();
  Map<String,Integer> sectionNames=new HashMap<String,Integer>();
  DataSourceField[] fields=dataSource.getFields();
  Boolean originalEdit=canEdit;
  for (  DataSourceField field : fields) {
    if (field.getAttribute("securityLevel") != null && field.getAttribute("uniqueID") != null && !SecurityManager.getInstance().isUserAuthorizedToEditField(field.getAttribute("uniqueID"))) {
      canEdit=false;
    }
    String name=field.getName();
    String fieldType=field.getAttribute("fieldType");
    FormHiddenEnum enumVal=(FormHiddenEnum)field.getAttributeAsObject("formHidden");
    Boolean tempFormHidden=field.getAttribute("tempFormHidden") != null && Boolean.parseBoolean(field.getAttribute("tempFormHidden"));
    boolean isFieldAvailableForRecord=false;
    if (currentRecord != null) {
      int pos=Arrays.binarySearch(recordAttributes,name);
      isFieldAvailableForRecord=pos >= 0;
    }
 else {
      isFieldAvailableForRecord=true;
    }
    if (fieldType != null && (!field.getHidden() || enumVal == FormHiddenEnum.VISIBLE) && enumVal != FormHiddenEnum.HIDDEN && isFieldAvailableForRecord && !tempFormHidden) {
      String group=field.getAttribute("formGroup");
      String temp=field.getAttribute("formGroupOrder");
      if (field.getAttributeAsBoolean("formGroupCollapsed") != null) {
        sectionCollapsed.put(group,field.getAttributeAsBoolean("formGroupCollapsed"));
      }
      Integer groupOrder=null;
      if (temp != null) {
        groupOrder=Integer.valueOf(temp);
      }
      if (group == null) {
        if (fieldType.equals(SupportedFieldType.ID.toString())) {
          group="Primary Key";
        }
 else {
          group="General";
        }
      }
      if (!fieldType.equals(SupportedFieldType.ID.toString()) || (fieldType.equals(SupportedFieldType.ID.toString()) && showId)) {
        Boolean largeEntry=field.getAttributeAsBoolean("largeEntry");
        if (largeEntry == null) {
          largeEntry=false;
        }
        final FormItem formItem=buildField(dataSource,field,fieldType,largeEntry,form);
        final FormItem displayFormItem=buildDisplayField(field,fieldType);
        if (fieldType.equals(SupportedFieldType.ID.toString())) {
          canEdit=false;
          showDisabledState=false;
        }
        setupField(showDisabledState,canEdit,sections,sectionNames,field,group,groupOrder,formItem,displayFormItem);
        checkForPasswordField(showDisabledState,canEdit,sections,sectionNames,field,group,groupOrder,formItem,displayFormItem,form);
      }
    }
    canEdit=originalEdit;
  }
  groupFields(form,sections,sectionNames,sectionCollapsed);
}
