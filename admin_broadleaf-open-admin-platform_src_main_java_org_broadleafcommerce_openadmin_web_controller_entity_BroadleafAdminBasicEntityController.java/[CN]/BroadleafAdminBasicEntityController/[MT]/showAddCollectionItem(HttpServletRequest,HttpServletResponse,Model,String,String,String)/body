{
  String mainClassName=getClassNameForSection(sectionKey);
  ClassMetadata mainMetadata=service.getClassMetadata(mainClassName);
  for (  final Property p : mainMetadata.getProperties()) {
    if (p.getName().equals(collectionField)) {
      p.getMetadata().accept(new MetadataVisitor(){
        @Override public void visit(        BasicFieldMetadata fmd){
          try {
            String collectionClassName=fmd.getForeignKeyClass();
            ClassMetadata collectionMetadata=service.getClassMetadata(collectionClassName);
            Entity[] rows=service.getRecords(collectionClassName,null);
            ListGrid listGrid=formService.buildListGrid(collectionMetadata,rows);
            listGrid.setListGridType("toOne");
            model.addAttribute("listGrid",listGrid);
            model.addAttribute("viewType","modalListGrid");
          }
 catch (          Exception e) {
            throw new RuntimeException(e);
          }
        }
        @Override public void visit(        BasicCollectionMetadata fmd){
          try {
            ForeignKey[] foreignKeys=new ForeignKey[]{(ForeignKey)fmd.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY)};
            ClassMetadata collectionMetadata=service.getClassMetadata(fmd.getCollectionCeilingEntity(),foreignKeys,null);
            if (fmd.getAddMethodType().equals(AddMethodType.PERSIST)) {
              EntityForm entityForm=formService.createEntityForm(collectionMetadata);
              model.addAttribute("entityForm",entityForm);
              model.addAttribute("viewType","modalEntityForm");
            }
 else {
              Entity[] rows=service.getRecords(fmd.getCollectionCeilingEntity(),foreignKeys);
              ListGrid listGrid=formService.buildListGrid(collectionMetadata,rows);
              listGrid.setListGridType("basicCollection");
              model.addAttribute("listGrid",listGrid);
              model.addAttribute("viewType","modalListGrid");
            }
          }
 catch (          Exception e) {
            throw new RuntimeException(e);
          }
        }
        @Override public void visit(        AdornedTargetCollectionMetadata fmd){
          try {
            AdornedTargetList adornedList=(AdornedTargetList)fmd.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
            ClassMetadata collectionMetadata=service.getClassMetadata(fmd.getCollectionCeilingEntity(),adornedList);
            Entity[] rows=service.getRecords(fmd.getCollectionCeilingEntity(),null);
            ListGrid listGrid=formService.buildListGrid(collectionMetadata,rows);
            EntityForm entityForm=formService.buildAdornedListForm(fmd,adornedList,id);
            model.addAttribute("listGrid",listGrid);
            model.addAttribute("entityForm",entityForm);
            if (fmd.getMaintainedAdornedTargetFields().length > 0) {
              listGrid.setListGridType("adornedTargetWithForm");
              model.addAttribute("viewType","modalAdornedListGridForm");
            }
 else {
              listGrid.setListGridType("adornedTarget");
              model.addAttribute("viewType","modalAdornedListGrid");
            }
          }
 catch (          Exception e) {
            throw new RuntimeException(e);
          }
        }
        @Override public void visit(        MapMetadata fmd){
        }
      }
);
    }
  }
  model.addAttribute("currentUrl",request.getRequestURL().toString());
  setModelAttributes(model,sectionKey);
  return "modules/modalContainer";
}
