{
  String sectionKey=getSectionKey(pathVars);
  String sectionClassName=getClassNameForSection(sectionKey);
  PersistencePackageRequest ppr=getSectionPersistencePackageRequest(sectionClassName);
  extractDynamicFormFields(entityForm);
  Entity entity;
  try {
    entity=service.updateEntity(entityForm,getSectionCustomCriteria());
  }
 catch (  ValidationException e) {
    entity=e.getEntity();
  }
  entityFormValidator.validate(entityForm,entity,result);
  if (result.hasErrors()) {
    model.addAttribute("headerFlash","save.unsuccessful");
    model.addAttribute("headerFlashAlert",true);
    Map<String,DynamicResultSet> subRecordsMap=service.getRecordsForAllSubCollections(ppr,entity);
    ClassMetadata cmd=service.getClassMetadata(ppr);
    entityForm.clearFieldsMap();
    formService.populateEntityForm(cmd,entity,subRecordsMap,entityForm);
    model.addAttribute("entity",entity);
    model.addAttribute("currentUrl",request.getRequestURL().toString());
    setModelAttributes(model,sectionKey);
    if (isAjaxRequest(request)) {
      entityForm.setReadOnly();
      model.addAttribute("viewType","modal/entityView");
      model.addAttribute("modalHeaderType","viewEntity");
      return "modules/modalContainer";
    }
 else {
      model.addAttribute("viewType","entityEdit");
      return "modules/defaultContainer";
    }
  }
  ra.addFlashAttribute("headerFlash","save.successful");
  return "redirect:/" + sectionKey + "/"+ id;
}
