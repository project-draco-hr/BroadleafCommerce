{
  CyberSourceTaxResponse taxResponse=new CyberSourceTaxResponse();
  taxResponse.setServiceType(taxRequest.getServiceType());
  RequestMessage request=buildRequestMessage(taxRequest);
  ReplyMessage reply;
  try {
    reply=sendRequest(request);
  }
 catch (  Exception e) {
    incrementFailure();
    throw new TaxException(e);
  }
  clearStatus();
  buildResponse(taxResponse,reply);
  String[] invalidFields=reply.getInvalidField();
  String[] missingFields=reply.getMissingField();
  if ((invalidFields != null && invalidFields.length > 0) || (missingFields != null && missingFields.length > 0)) {
    TaxHostException e=new TaxHostException();
    taxResponse.setErrorDetected(true);
    StringBuffer sb=new StringBuffer();
    if (invalidFields != null && invalidFields.length > 0) {
      sb.append("invalid fields :[ ");
      for (      String invalidField : invalidFields) {
        sb.append(invalidField);
      }
      sb.append(" ]\n");
    }
    if (missingFields != null && missingFields.length > 0) {
      sb.append("missing fields: [ ");
      for (      String missingField : missingFields) {
        sb.append(missingField);
      }
      sb.append(" ]");
    }
    taxResponse.setErrorText(sb.toString());
    e.setTaxResponse(taxResponse);
    throw e;
  }
  return taxResponse;
}
