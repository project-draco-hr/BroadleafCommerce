{
  List<OrderItem> itemsToRemove=new ArrayList<OrderItem>();
  Iterator<OrderItem> finalItems=order.getOrderItems().iterator();
  while (finalItems.hasNext()) {
    OrderItem nextItem=finalItems.next();
    List<OrderItem> mySplits=order.searchSplitItems(nextItem);
    if (!CollectionUtils.isEmpty(mySplits)) {
      if (mySplits.size() == 1 && mySplits.contains(nextItem)) {
        mySplits.remove(nextItem);
        continue;
      }
      OrderItem cloneItem=nextItem.clone();
      cloneItem.clearAllDiscount();
      cloneItem.clearAllQualifiers();
      cloneItem.removeAllAdjustments();
      cloneItem.setQuantity(0);
      Iterator<OrderItem> splitItemIterator=mySplits.iterator();
      while (splitItemIterator.hasNext()) {
        OrderItem splitItem=splitItemIterator.next();
        if (!splitItem.isHasOrderItemAdjustments()) {
          cloneItem.setQuantity(cloneItem.getQuantity() + splitItem.getQuantity());
          splitItemIterator.remove();
        }
      }
      if (cloneItem.getQuantity() > 0) {
        mySplits.add(cloneItem);
      }
      if (mySplits.contains(nextItem)) {
        mySplits.remove(nextItem);
      }
 else {
        itemsToRemove.add(nextItem);
      }
    }
  }
  try {
    for (    OrderItemSplitContainer key : order.getSplitItems()) {
      List<OrderItem> mySplits=key.getSplitItems();
      if (!CollectionUtils.isEmpty(mySplits)) {
        FulfillmentGroup targetGroup=null;
        checkGroups: {
          for (          FulfillmentGroup fg : order.getFulfillmentGroups()) {
            for (            FulfillmentGroupItem fgItem : fg.getFulfillmentGroupItems()) {
              if (fgItem.getOrderItem().equals(key.getKey())) {
                targetGroup=fg;
                break checkGroups;
              }
            }
          }
        }
        for (        OrderItem myItem : mySplits) {
          Money adjustmentPrice=myItem.getAdjustmentPrice();
          myItem=cartService.addOrderItemToOrder(order,myItem,false);
          cartService.addItemToFulfillmentGroup(myItem,targetGroup,false);
          myItem.setAdjustmentPrice(adjustmentPrice);
        }
      }
    }
    for (    OrderItem orderItem : itemsToRemove) {
      cartService.removeItemFromOrder(order,orderItem,false);
    }
  }
 catch (  PricingException e) {
    throw new RuntimeException("Could not propagate the items split by the promotion engine into the order",e);
  }
}
