{
  org.broadleafcommerce.profile.domain.Customer customer=customerService.readCustomerByUsername(username);
  if (customer == null) {
    throw new UsernameNotFoundException("The customer was not found");
  }
  User returnUser=null;
  boolean pwChangeRequired=customer.isPasswordChangeRequired();
  if (pwChangeRequired) {
    if (forcePasswordChange) {
      returnUser=new User(username,customer.getPassword(),true,true,!customer.isPasswordChangeRequired(),true,new GrantedAuthority[]{new GrantedAuthorityImpl("ROLE_USER")});
    }
 else {
      returnUser=new User(username,customer.getPassword(),true,true,true,true,new GrantedAuthority[]{new GrantedAuthorityImpl("ROLE_USER"),new GrantedAuthorityImpl("ROLE_PASSWORD_CHANGE_REQUIRED")});
    }
  }
 else {
    returnUser=new User(username,customer.getPassword(),true,true,!customer.isPasswordChangeRequired(),true,new GrantedAuthority[]{new GrantedAuthorityImpl("ROLE_USER")});
  }
  return returnUser;
}
