{
  org.broadleafcommerce.profile.domain.Customer customer=customerService.readCustomerByUsername(username);
  if (customer == null) {
    throw new UsernameNotFoundException("The customer was not found");
  }
  User returnUser=null;
  boolean pwChangeRequired=customer.isPasswordChangeRequired();
  List<GrantedAuthority> grantedAuthorities=createGrantedAuthorities(roleService.findCustomerRolesByCustomerId(customer.getId()));
  if (pwChangeRequired) {
    if (forcePasswordChange) {
      returnUser=new User(username,customer.getPassword(),true,true,!customer.isPasswordChangeRequired(),true,grantedAuthorities.toArray(new GrantedAuthority[0]));
    }
 else {
      grantedAuthorities.add(new GrantedAuthorityImpl("ROLE_PASSWORD_CHANGE_REQUIRED"));
      returnUser=new User(username,customer.getPassword(),true,true,true,true,grantedAuthorities.toArray(new GrantedAuthority[0]));
    }
  }
 else {
    returnUser=new User(username,customer.getPassword(),true,true,!customer.isPasswordChangeRequired(),true,grantedAuthorities.toArray(new GrantedAuthority[0]));
  }
  return returnUser;
}
