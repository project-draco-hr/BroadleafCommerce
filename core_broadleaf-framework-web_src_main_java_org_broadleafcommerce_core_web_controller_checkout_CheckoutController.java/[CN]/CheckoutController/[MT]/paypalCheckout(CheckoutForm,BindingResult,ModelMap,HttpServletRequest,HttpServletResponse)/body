{
  try {
    final Order order=retrieveCartOrder(request,model);
    Map<PaymentInfo,Referenced> payments=new HashMap<PaymentInfo,Referenced>();
    TotalledPaymentInfoImpl paymentInfo=new TotalledPaymentInfoImpl();
    paymentInfo.setOrder(order);
    paymentInfo.setType(PaymentInfoType.PAYPAL);
    paymentInfo.getAdditionalFields().put("PAYPALMETHODTYPE","CHECKOUT");
    paymentInfo.setReferenceNumber(String.valueOf(order.getId()));
    paymentInfo.setAmount(order.getTotal());
    paymentInfo.setSubTotal(order.getSubTotal());
    paymentInfo.setTotalShipping(order.getTotalShipping());
    paymentInfo.setTotalTax(order.getTotalTax());
    paymentInfo.setShippingDiscount(order.getFulfillmentGroupAdjustmentsValue());
    for (    OrderItem orderItem : order.getOrderItems()) {
      AmountItem amountItem=new AmountItemImpl();
      if (DiscreteOrderItem.class.isAssignableFrom(orderItem.getClass())) {
        amountItem.setDescription(((DiscreteOrderItem)orderItem).getSku().getDescription());
        amountItem.setSystemId(String.valueOf(((DiscreteOrderItem)orderItem).getSku().getId()));
      }
      amountItem.setShortDescription(orderItem.getName());
      amountItem.setPaymentInfo(paymentInfo);
      amountItem.setQuantity((long)orderItem.getQuantity());
      amountItem.setUnitPrice(orderItem.getPrice().getAmount());
      paymentInfo.getAmountItems().add(amountItem);
    }
    payments.put(paymentInfo,paymentInfo.createEmptyReferenced());
    List<PaymentInfo> paymentInfos=new ArrayList<PaymentInfo>();
    paymentInfos.add(paymentInfo);
    order.setPaymentInfos(paymentInfos);
    CompositePaymentResponse compositePaymentResponse=compositePaymentService.executePayment(order,payments);
    PaymentResponseItem responseItem=compositePaymentResponse.getPaymentResponse().getResponseItems().get(paymentInfo);
    if (responseItem.getTransactionSuccess()) {
      order.setOrderNumber(new SimpleDateFormat("yyyyMMddHHmmssS").format(SystemTime.asDate()));
      model.addAttribute("order",retrieveCartOrder(request,model));
      return "redirect:" + responseItem.getAdditionalFields().get("REDIRECTURL");
    }
 else {
      return "";
    }
  }
 catch (  Exception e) {
    System.out.println(e);
    return "";
  }
}
