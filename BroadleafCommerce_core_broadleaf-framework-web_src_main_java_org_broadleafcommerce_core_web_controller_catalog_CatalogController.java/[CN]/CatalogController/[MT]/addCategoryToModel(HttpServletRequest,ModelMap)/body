{
  Category rootCategory=null;
  if (getRootCategoryId() != null) {
    rootCategory=catalogService.findCategoryById(getRootCategoryId());
  }
 else   if (getRootCategoryName() != null) {
    rootCategory=catalogService.findCategoryByName(getRootCategoryName());
  }
  if (rootCategory == null) {
    throw new IllegalStateException("Catalog Controller configured incorrectly - rootId category not found: " + rootCategoryId);
  }
  String url=pathHelper.getRequestUri(request).substring(pathHelper.getContextPath(request).length());
  String categoryId=request.getParameter("categoryId");
  if (categoryId != null) {
    Category category=catalogService.findCategoryById(new Long(categoryId));
    if (category != null) {
      url=category.getUrl();
    }
  }
  List<Long> categoryIdList=catalogService.getChildCategoryURLMapByCategoryId(rootCategory.getId()).get(url);
  List<Category> categoryList=null;
  if (categoryIdList != null) {
    categoryList=new ArrayList<Category>(categoryIdList.size());
    for (    Long id : categoryIdList) {
      categoryList.add(catalogService.findCategoryById(id));
    }
  }
  addCategoryListToModel(categoryList,rootCategory,url,model);
  model.addAttribute("rootCategory",rootCategory);
}
