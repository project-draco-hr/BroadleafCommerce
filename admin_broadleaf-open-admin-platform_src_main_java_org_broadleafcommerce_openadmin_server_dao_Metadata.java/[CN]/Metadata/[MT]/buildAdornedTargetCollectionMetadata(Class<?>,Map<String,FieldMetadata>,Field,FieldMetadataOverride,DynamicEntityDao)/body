{
  AdornedTargetCollectionMetadata serverMetadata=(AdornedTargetCollectionMetadata)attributes.get(field.getName());
  AdornedTargetCollectionMetadata metadata;
  if (serverMetadata != null) {
    metadata=serverMetadata;
  }
 else {
    metadata=new AdornedTargetCollectionMetadata();
  }
  metadata.setTargetClass(targetClass.getName());
  AdminPresentationClass adminPresentationClass=targetClass.getAnnotation(AdminPresentationClass.class);
  if (adminPresentationClass != null) {
    String friendlyName=adminPresentationClass.friendlyName();
    if (!StringUtils.isEmpty(friendlyName)) {
      metadata.setOwningClassFriendlyName(friendlyName);
    }
  }
  metadata.setFieldName(field.getName());
  if (adornedTargetCollectionMetadata.getReadOnly() != null) {
    metadata.setMutable(!adornedTargetCollectionMetadata.getReadOnly());
  }
  if (adornedTargetCollectionMetadata.getShowIfProperty() != null) {
    metadata.setShowIfProperty(adornedTargetCollectionMetadata.getShowIfProperty());
  }
  org.broadleafcommerce.openadmin.client.dto.OperationTypes dtoOperationTypes=new org.broadleafcommerce.openadmin.client.dto.OperationTypes(OperationType.ADORNEDTARGETLIST,OperationType.ADORNEDTARGETLIST,OperationType.ADORNEDTARGETLIST,OperationType.ADORNEDTARGETLIST,OperationType.BASIC);
  if (adornedTargetCollectionMetadata.getAddType() != null) {
    dtoOperationTypes.setAddType(adornedTargetCollectionMetadata.getAddType());
  }
  if (adornedTargetCollectionMetadata.getRemoveType() != null) {
    dtoOperationTypes.setRemoveType(adornedTargetCollectionMetadata.getRemoveType());
  }
  if (adornedTargetCollectionMetadata.getFetchType() != null) {
    dtoOperationTypes.setFetchType(adornedTargetCollectionMetadata.getFetchType());
  }
  if (adornedTargetCollectionMetadata.getInspectType() != null) {
    dtoOperationTypes.setInspectType(adornedTargetCollectionMetadata.getInspectType());
  }
  if (adornedTargetCollectionMetadata.getUpdateType() != null) {
    dtoOperationTypes.setUpdateType(adornedTargetCollectionMetadata.getUpdateType());
  }
  PersistencePerspective persistencePerspective;
  if (serverMetadata != null) {
    persistencePerspective=metadata.getPersistencePerspective();
    persistencePerspective.setOperationTypes(dtoOperationTypes);
  }
 else {
    persistencePerspective=new PersistencePerspective(dtoOperationTypes,new String[]{},new ForeignKey[]{});
    metadata.setPersistencePerspective(persistencePerspective);
  }
  OneToMany oneToMany=field.getAnnotation(OneToMany.class);
  ManyToMany manyToMany=field.getAnnotation(ManyToMany.class);
  String parentObjectProperty=null;
  if (serverMetadata != null) {
    parentObjectProperty=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getLinkedObjectPath();
  }
  if (!StringUtils.isEmpty(adornedTargetCollectionMetadata.getParentObjectProperty())) {
    parentObjectProperty=adornedTargetCollectionMetadata.getParentObjectProperty();
  }
  if (parentObjectProperty == null && oneToMany != null && !StringUtils.isEmpty(oneToMany.mappedBy())) {
    parentObjectProperty=oneToMany.mappedBy();
  }
  if (parentObjectProperty == null && manyToMany != null && !StringUtils.isEmpty(manyToMany.mappedBy())) {
    parentObjectProperty=manyToMany.mappedBy();
  }
  if (StringUtils.isEmpty(parentObjectProperty)) {
    throw new IllegalArgumentException("Unable to infer a parentObjectProperty for the @AdminPresentationAdornedTargetCollection annotated field(" + field.getName() + "). If not using the mappedBy property of @OneToMany or @ManyToMany, please make sure to explicitly define the parentObjectProperty property");
  }
  String sortProperty=null;
  if (serverMetadata != null) {
    sortProperty=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getSortField();
  }
  if (!StringUtils.isEmpty(adornedTargetCollectionMetadata.getSortProperty())) {
    sortProperty=adornedTargetCollectionMetadata.getSortProperty();
  }
  metadata.setParentObjectClass(targetClass.getName());
  if (adornedTargetCollectionMetadata.getMaintainedAdornedTargetFields() != null) {
    metadata.setMaintainedAdornedTargetFields(adornedTargetCollectionMetadata.getMaintainedAdornedTargetFields());
  }
  if (adornedTargetCollectionMetadata.getGridVisibleFields() != null) {
    metadata.setGridVisibleFields(adornedTargetCollectionMetadata.getGridVisibleFields());
  }
  String parentObjectIdProperty=null;
  if (serverMetadata != null) {
    parentObjectIdProperty=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getLinkedIdProperty();
  }
  if (adornedTargetCollectionMetadata.getParentObjectIdProperty() != null) {
    parentObjectIdProperty=adornedTargetCollectionMetadata.getParentObjectIdProperty();
  }
  String targetObjectProperty=null;
  if (serverMetadata != null) {
    targetObjectProperty=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getTargetObjectPath();
  }
  if (adornedTargetCollectionMetadata.getTargetObjectProperty() != null) {
    targetObjectProperty=adornedTargetCollectionMetadata.getTargetObjectProperty();
  }
  Class<?> collectionTarget=null;
  checkCeiling: {
    if (oneToMany != null && oneToMany.targetEntity() != void.class) {
      collectionTarget=oneToMany.targetEntity();
      break checkCeiling;
    }
    if (manyToMany != null && manyToMany.targetEntity() != void.class) {
      collectionTarget=manyToMany.targetEntity();
      break checkCeiling;
    }
  }
  if (collectionTarget == null) {
    throw new IllegalArgumentException("Unable to infer the type of the collection from the targetEntity property of a OneToMany or ManyToMany collection.");
  }
  Field collectionTargetField=dynamicEntityDao.getFieldManager().getField(collectionTarget,targetObjectProperty);
  ManyToOne manyToOne=collectionTargetField.getAnnotation(ManyToOne.class);
  String ceiling=null;
  checkCeiling: {
    if (manyToOne != null && manyToOne.targetEntity() != void.class) {
      ceiling=manyToOne.targetEntity().getName();
      break checkCeiling;
    }
    ceiling=collectionTargetField.getType().getName();
  }
  if (!StringUtils.isEmpty(ceiling)) {
    metadata.setCollectionCeilingEntity(ceiling);
  }
  String targetObjectIdProperty=null;
  if (serverMetadata != null) {
    targetObjectIdProperty=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getTargetIdProperty();
  }
  if (adornedTargetCollectionMetadata.getTargetObjectIdProperty() != null) {
    targetObjectIdProperty=adornedTargetCollectionMetadata.getTargetObjectIdProperty();
  }
  Boolean isAscending=true;
  if (serverMetadata != null) {
    isAscending=((AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST)).getSortAscending();
  }
  if (adornedTargetCollectionMetadata.isSortAscending() != null) {
    isAscending=adornedTargetCollectionMetadata.isSortAscending();
  }
  if (serverMetadata != null) {
    AdornedTargetList adornedTargetList=(AdornedTargetList)serverMetadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST);
    adornedTargetList.setCollectionFieldName(field.getName());
    adornedTargetList.setLinkedObjectPath(parentObjectProperty);
    adornedTargetList.setLinkedIdProperty(parentObjectIdProperty);
    adornedTargetList.setTargetObjectPath(targetObjectProperty);
    adornedTargetList.setTargetIdProperty(targetObjectIdProperty);
    adornedTargetList.setAdornedTargetEntityClassname(collectionTarget.getName());
    adornedTargetList.setSortField(sortProperty);
    adornedTargetList.setSortAscending(isAscending);
  }
 else {
    AdornedTargetList adornedTargetList=new AdornedTargetList(field.getName(),parentObjectProperty,parentObjectIdProperty,targetObjectProperty,targetObjectIdProperty,collectionTarget.getName(),sortProperty,isAscending);
    persistencePerspective.addPersistencePerspectiveItem(PersistencePerspectiveItemType.ADORNEDTARGETLIST,adornedTargetList);
  }
  if (adornedTargetCollectionMetadata.getExcluded() != null) {
    if (LOG.isDebugEnabled()) {
      if (adornedTargetCollectionMetadata.getExcluded()) {
        LOG.debug("buildAdornedTargetCollectionMetadata:Excluding " + field.getName() + " because it was explicitly declared in config");
      }
 else {
        LOG.debug("buildAdornedTargetCollectionMetadata:Showing " + field.getName() + " because it was explicitly declared in config");
      }
    }
    metadata.setExcluded(adornedTargetCollectionMetadata.getExcluded());
  }
  if (adornedTargetCollectionMetadata.getFriendlyName() != null) {
    metadata.setFriendlyName(adornedTargetCollectionMetadata.getFriendlyName());
  }
  if (adornedTargetCollectionMetadata.getSecurityLevel() != null) {
    metadata.setSecurityLevel(adornedTargetCollectionMetadata.getSecurityLevel());
  }
  if (adornedTargetCollectionMetadata.getOrder() != null) {
    metadata.setOrder(adornedTargetCollectionMetadata.getOrder());
  }
  if (!StringUtils.isEmpty(adornedTargetCollectionMetadata.getTargetElementId())) {
    metadata.setTargetElementId(adornedTargetCollectionMetadata.getTargetElementId());
  }
  if (!StringUtils.isEmpty(adornedTargetCollectionMetadata.getDataSourceName())) {
    metadata.setDataSourceName(adornedTargetCollectionMetadata.getDataSourceName());
  }
  if (adornedTargetCollectionMetadata.getCustomCriteria() != null) {
    metadata.setCustomCriteria(adornedTargetCollectionMetadata.getCustomCriteria());
  }
  if (adornedTargetCollectionMetadata.isIgnoreAdornedProperties() != null) {
    metadata.setIgnoreAdornedProperties(adornedTargetCollectionMetadata.isIgnoreAdornedProperties());
  }
  attributes.put(field.getName(),metadata);
}
