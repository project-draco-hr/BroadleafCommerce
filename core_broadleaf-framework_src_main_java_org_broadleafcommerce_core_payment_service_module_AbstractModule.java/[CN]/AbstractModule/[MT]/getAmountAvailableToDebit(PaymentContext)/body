{
  Money amountToDebit=paymentContext.getRemainingTransactionAmount();
  PaymentInfo paymentInfo=findPaymentInfoFromContext(paymentContext);
  Money amountCaptured=paymentInfo.getPaymentCapturedAmount();
  Money amountAlreadyReversed=paymentInfo.getReverseAuthAmount();
  Money amount=paymentInfo.getAmount();
  Money orderTotal=paymentInfo.getOrder().getTotal();
  Money appliedCreditAdjustment=orderTotal.subtract(amount);
  Money adjustedAmountToDebit=amountToDebit.subtract(appliedCreditAdjustment).abs();
  if (adjustedAmountToDebit.lessThan(amountToDebit) && paymentInfo.getOrder().getCapturedTotal().equals(appliedCreditAdjustment)) {
    amountToDebit=adjustedAmountToDebit;
  }
  Money amountAvailableToDebit=amount.subtract(amountCaptured).subtract(amountAlreadyReversed);
  if (amountAvailableToDebit.lessThan(amountToDebit)) {
    return amountAvailableToDebit;
  }
 else {
    return amountToDebit;
  }
}
