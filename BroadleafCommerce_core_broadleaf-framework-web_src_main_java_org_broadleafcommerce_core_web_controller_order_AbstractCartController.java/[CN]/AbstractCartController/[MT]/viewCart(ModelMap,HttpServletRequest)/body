{
  Order cart=retrieveCartOrder(request,model);
  CartSummary cartSummary=new CartSummary();
  if (cart.getOrderItems() != null) {
    for (    OrderItem orderItem : cart.getOrderItems()) {
      CartOrderItem cartOrderItem=new CartOrderItem();
      cartOrderItem.setOrderItem(orderItem);
      cartOrderItem.setQuantity(orderItem.getQuantity());
      cartSummary.getRows().add(cartOrderItem);
    }
  }
  if ((cart.getFulfillmentGroups() != null) && (cart.getFulfillmentGroups().isEmpty() == false)) {
    String cartShippingMethod=cart.getFulfillmentGroups().get(0).getMethod();
    String cartShippingService=cart.getFulfillmentGroups().get(0).getService();
    if (cartShippingMethod != null) {
      if (cartShippingMethod.equals("standard")) {
        cartSummary=createFulfillmentGroup(cartSummary,"standard",cartShippingService,cart);
      }
 else       if (cartShippingMethod.equals("expedited")) {
        cartSummary=createFulfillmentGroup(cartSummary,"expedited",cartShippingService,cart);
      }
    }
  }
  updateFulfillmentGroups(cartSummary,cart);
  cartSummary.setOrderDiscounts(cart.getTotalAdjustmentsValue().getAmount());
  if (cart.getOrderItems() != null) {
    cartSummary.getRows().clear();
    for (    OrderItem orderItem : cart.getOrderItems()) {
      CartOrderItem cartOrderItem=new CartOrderItem();
      cartOrderItem.setOrderItem(orderItem);
      cartOrderItem.setQuantity(orderItem.getQuantity());
      cartSummary.getRows().add(cartOrderItem);
    }
  }
  model.addAttribute("cartSummary",cartSummary);
  return cartViewRedirect ? "redirect:" + cartView : cartView;
}
