{
  Money orderSubtotal=order.getSubTotal();
  for (  FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
    for (    FulfillmentGroupFee fulfillmentGroupFee : fulfillmentGroup.getFulfillmentGroupFees()) {
      if (fulfillmentGroupFee.isTaxable()) {
        orderSubtotal=orderSubtotal.add(fulfillmentGroupFee.getAmount());
      }
    }
  }
  Money totalTax=orderSubtotal.multiply(factor);
  for (  FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
    Money fgTotalTax=fulfillmentGroup.getShippingPrice().multiply(factor);
    fulfillmentGroup.setTotalTax(fgTotalTax);
    fulfillmentGroup.setCityTax(new Money(0D));
    fulfillmentGroup.setCountyTax(new Money(0D));
    fulfillmentGroup.setCountryTax(new Money(0D));
    totalTax=totalTax.add(fgTotalTax);
  }
  order.setTotalTax(totalTax);
  return order;
}
