{
  Order cart=CartState.getCart();
  if (cart == null) {
    throw new WebApplicationException(Response.status(Response.Status.NOT_FOUND).type(MediaType.TEXT_PLAIN).entity("Cart could not be found").build());
  }
  OfferCode offerCode=offerService.lookupOfferCodeByCode(promoCode);
  if (offerCode == null) {
    throw new WebApplicationException(Response.status(Response.Status.NOT_FOUND).type(MediaType.TEXT_PLAIN).entity("Offer Code could not be found").build());
  }
  try {
    cart=orderService.addOfferCode(cart,offerCode,priceOrder);
    OrderWrapper wrapper=(OrderWrapper)context.getBean(OrderWrapper.class.getName());
    wrapper.wrapDetails(cart,request);
    return wrapper;
  }
 catch (  PricingException e) {
    throw new WebApplicationException(e,Response.status(Response.Status.INTERNAL_SERVER_ERROR).type(MediaType.TEXT_PLAIN).entity("An error occured pricing the cart.").build());
  }
catch (  OfferMaxUseExceededException e) {
    throw new WebApplicationException(e,Response.status(Response.Status.BAD_REQUEST).type(MediaType.TEXT_PLAIN).entity("The offer (promo) code provided has exceeded its max usages: " + promoCode).build());
  }
}
