{
  Customer customer=(Customer)request.getAttribute(CustomerStateRequestProcessor.getCustomerRequestAttributeName(),WebRequest.SCOPE_REQUEST);
  if (customer == null) {
    return;
  }
  Order cart=null;
  if (mergeCartNeeded(customer,request)) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Merge cart required, calling mergeCart " + customer.getId());
    }
    cart=mergeCart(customer,request);
  }
 else {
    cart=orderService.findCartForCustomer(customer);
  }
  if (cart == null) {
    cart=orderService.getNullOrder();
  }
 else {
    updateCartService.updateAndValidateCart(cart);
  }
  request.setAttribute(cartRequestAttributeName,cart,WebRequest.SCOPE_REQUEST);
  Map<String,Object> ruleMap=(Map<String,Object>)request.getAttribute(BLC_RULE_MAP_PARAM,WebRequest.SCOPE_REQUEST);
  if (ruleMap == null) {
    ruleMap=new HashMap<String,Object>();
  }
  ruleMap.put("order",cart);
  ruleMap.put("cart",cart);
  request.setAttribute(BLC_RULE_MAP_PARAM,ruleMap,WebRequest.SCOPE_REQUEST);
}
