{
  CandidateOrderOfferAnswer candidateOrderOfferAnswer=new CandidateOrderOfferAnswer();
  OrderAdjustmentAnswer orderAdjustmentAnswer=new OrderAdjustmentAnswer();
  EasyMock.expect(offerDaoMock.createCandidateOrderOffer()).andAnswer(candidateOrderOfferAnswer).atLeastOnce();
  EasyMock.expect(offerDaoMock.createOrderAdjustment()).andAnswer(orderAdjustmentAnswer).atLeastOnce();
  CandidateItemOfferAnswer candidateItemOfferAnswer=new CandidateItemOfferAnswer();
  OrderItemAdjustmentAnswer orderItemAdjustmentAnswer=new OrderItemAdjustmentAnswer();
  EasyMock.expect(offerDaoMock.createCandidateItemOffer()).andAnswer(candidateItemOfferAnswer).atLeastOnce();
  EasyMock.expect(offerDaoMock.createOrderItemAdjustment()).andAnswer(orderItemAdjustmentAnswer).atLeastOnce();
  replay();
  Order order=dataProvider.createBasicOrder();
  List<Offer> offers=dataProvider.createOrderBasedOffer("order.subTotal.getAmount()>126",OfferDiscountType.PERCENT_OFF);
  offerService.applyOffersToOrder(offers,order);
  int adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 1);
  assertTrue(order.getAdjustmentPrice().equals(new Money(116.95D)));
  order=dataProvider.createBasicOrder();
  offers=dataProvider.createOrderBasedOffer("order.subTotal.getAmount()>126",OfferDiscountType.PERCENT_OFF);
  List<Offer> offers2=dataProvider.createItemBasedOfferWithItemCriteria("order.subTotal.getAmount()>20",OfferDiscountType.PERCENT_OFF,"([MVEL.eval(\"toUpperCase()\",\"test1\"), MVEL.eval(\"toUpperCase()\",\"test2\")] contains MVEL.eval(\"toUpperCase()\", discreteOrderItem.category.name))","([MVEL.eval(\"toUpperCase()\",\"test1\"), MVEL.eval(\"toUpperCase()\",\"test2\")] contains MVEL.eval(\"toUpperCase()\", discreteOrderItem.category.name))");
  offers.addAll(offers2);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=0;
  for (  OrderItem item : order.getOrderItems()) {
    if (item.getOrderItemAdjustments() != null) {
      adjustmentCount+=item.getOrderItemAdjustments().size();
    }
  }
  assertTrue(adjustmentCount == 2);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 0);
  assertTrue(order.getSubTotal().equals(new Money(124.95D)));
  order=dataProvider.createBasicOrder();
  OfferRule orderRule=new OfferRuleImpl();
  orderRule.setMatchRule("order.subTotal.getAmount()>124");
  offers.get(0).getOfferMatchRules().put(OfferRuleType.ORDER.getType(),orderRule);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=0;
  for (  OrderItem item : order.getOrderItems()) {
    if (item.getOrderItemAdjustments() != null) {
      adjustmentCount+=item.getOrderItemAdjustments().size();
    }
  }
  assertTrue(adjustmentCount == 2);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 1);
  assertTrue(order.getAdjustmentPrice().equals(new Money(112.45D)));
  assertTrue(order.getSubTotal().equals(new Money(124.95D)));
  order=dataProvider.createBasicOrder();
  List<Offer> offers3=dataProvider.createOrderBasedOffer("order.subTotal.getAmount()>20",OfferDiscountType.AMOUNT_OFF);
  offers.addAll(offers3);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 2);
  order=dataProvider.createBasicOrder();
  offers.get(0).setCombinableWithOtherOffers(false);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=0;
  for (  OrderItem item : order.getOrderItems()) {
    if (item.getOrderItemAdjustments() != null) {
      adjustmentCount+=item.getOrderItemAdjustments().size();
    }
  }
  assertTrue(adjustmentCount == 2);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 1);
  assertTrue(order.getAdjustmentPrice().equals(new Money(112.45D)));
  assertTrue(order.getSubTotal().equals(new Money(124.95D)));
  order=dataProvider.createBasicOrder();
  offers.get(0).setTotalitarianOffer(true);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=0;
  for (  OrderItem item : order.getOrderItems()) {
    if (item.getOrderItemAdjustments() != null) {
      adjustmentCount+=item.getOrderItemAdjustments().size();
    }
  }
  assertTrue(adjustmentCount == 0);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 1);
  assertTrue(order.getAdjustmentPrice().equals(new Money(116.95D)));
  assertTrue(order.getSubTotal().equals(new Money(129.95D)));
  order=dataProvider.createBasicOrder();
  offers.get(0).setValue(new BigDecimal(".05"));
  offers.get(2).setValue(new BigDecimal(".01"));
  offers.get(2).setDiscountType(OfferDiscountType.PERCENT_OFF);
  offerService.applyOffersToOrder(offers,order);
  adjustmentCount=0;
  for (  OrderItem item : order.getOrderItems()) {
    if (item.getOrderItemAdjustments() != null) {
      adjustmentCount+=item.getOrderItemAdjustments().size();
    }
  }
  assertTrue(adjustmentCount == 2);
  adjustmentCount=order.getOrderAdjustments().size();
  assertTrue(adjustmentCount == 1);
  assertTrue(order.getAdjustmentPrice().equals(new Money(124.94D)));
  assertTrue(order.getSubTotal().equals(new Money(124.95D)));
  verify();
}
