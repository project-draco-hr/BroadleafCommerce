{
  int count=0;
  for (  final ItemBuilderDisplay builder : getDisplay().getTargetItemBuilderViews()) {
    if (builder.getDirty()) {
      count++;
    }
  }
  stateManager.setWatchedItem(CriteriaType.TARGET,count);
  if (type.equals("ORDER_ITEM")) {
    for (    final ItemBuilderDisplay builder : getDisplay().getTargetItemBuilderViews()) {
      if (builder.getDirty()) {
        String temper=builder.getItemQuantity().getValue().toString();
        Integer quantity=Integer.parseInt(temper);
        String mvel;
        if (builder.getIncompatibleMVEL()) {
          mvel=builder.getRawItemTextArea().getValueAsString();
        }
 else {
          mvel=TRANSLATOR.createMVEL(MVELKEYWORDMAP.get(FilterType.ORDER_ITEM),builder.getItemFilterBuilder().getCriteria(),builder.getItemFilterBuilder().getDataSource());
        }
        if (!isValidation) {
          if (builder.getRecord() != null) {
            setData(builder.getRecord(),"quantity",quantity,dirtyValues);
            setData(builder.getRecord(),"orderItemMatchRule",mvel,dirtyValues);
            presenter.getPresenterSequenceSetupManager().getDataSource("offerItemTargetCriteriaDS").updateData(builder.getRecord(),new DSCallback(){
              public void execute(              DSResponse response,              Object rawData,              DSRequest request){
                builder.setDirty(false);
                stateManager.finishWatchedItem(CriteriaType.TARGET);
              }
            }
);
          }
 else {
            final Record temp=new Record();
            temp.setAttribute("quantity",quantity);
            temp.setAttribute("orderItemMatchRule",mvel);
            temp.setAttribute("_type",new String[]{presenter.getPresenterSequenceSetupManager().getDataSource("offerItemTargetCriteriaDS").getDefaultNewEntityFullyQualifiedClassname()});
            temp.setAttribute(OfferItemTargetCriteriaListDataSourceFactory.foreignKeyName,presenter.getPresenterSequenceSetupManager().getDataSource("offerDS").getPrimaryKeyValue(selectedRecord));
            temp.setAttribute("id","");
            presenter.getPresenterSequenceSetupManager().getDataSource("offerItemTargetCriteriaDS").addData(temp,new DSCallback(){
              public void execute(              DSResponse response,              Object rawData,              DSRequest request){
                builder.setDirty(false);
                builder.setRecord(temp);
                stateManager.finishWatchedItem(CriteriaType.TARGET);
              }
            }
);
          }
        }
      }
    }
  }
 else {
    if (!isValidation) {
      ItemBuilderDisplay[] displays=new ItemBuilderDisplay[]{};
      displays=getDisplay().getTargetItemBuilderViews().toArray(displays);
      for (      final ItemBuilderDisplay builder : displays) {
        removeItemTarget(builder);
      }
    }
  }
}
