{
  RegisterCustomer registerCustomer=(RegisterCustomer)command;
  Customer customerFromDb=customerService.readCustomerByUsername(registerCustomer.getUsername());
  if (customerFromDb != null) {
    errors.rejectValue("username","username.used",null,null);
  }
  ModelAndView mav=new ModelAndView(getSuccessView(),errors.getModel());
  if (errors.hasErrors()) {
    logger.debug("Error returning back to the form");
    return showForm(request,response,errors);
  }
  Customer customer=new BroadleafCustomer();
  customer.setUsername(registerCustomer.getUsername());
  customer.setFirstName(registerCustomer.getFirstName());
  customer.setLastName(registerCustomer.getLastName());
  customer.setUnencodedPassword(registerCustomer.getPassword());
  customer.setEmailAddress(registerCustomer.getEmailAddress());
  customer.setChallengeQuestion(registerCustomer.getChallengeQuestion());
  customer.setChallengeAnswer(registerCustomer.getChallengeAnswer());
  customerService.saveCustomer(customer);
  emailService.sendEmail(customer,TEMPLATE,EMAIL_FROM,EMAIL_SUBJECT);
  mav.addObject("saved",true);
  return mav;
}
