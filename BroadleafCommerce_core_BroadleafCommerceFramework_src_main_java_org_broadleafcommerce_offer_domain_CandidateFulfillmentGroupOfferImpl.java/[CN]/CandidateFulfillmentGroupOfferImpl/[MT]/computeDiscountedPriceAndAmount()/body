{
  if (offer != null && fulfillmentGroup != null) {
    if (fulfillmentGroup.getRetailShippingPrice() != null) {
      Money priceToUse=fulfillmentGroup.getRetailShippingPrice();
      Money discountAmount=new Money(0);
      if ((offer.getApplyDiscountToSalePrice()) && (fulfillmentGroup.getSaleShippingPrice() != null)) {
        priceToUse=fulfillmentGroup.getSaleShippingPrice();
      }
      if (offer.getDiscountType().equals(OfferDiscountType.AMOUNT_OFF)) {
        discountAmount=offer.getValue();
      }
 else       if (offer.getDiscountType().equals(OfferDiscountType.FIX_PRICE)) {
        discountAmount=priceToUse.subtract(offer.getValue());
      }
 else       if (offer.getDiscountType().equals(OfferDiscountType.PERCENT_OFF)) {
        discountAmount=priceToUse.multiply(offer.getValue().getAmount().divide(new BigDecimal("100")));
      }
      if (discountAmount.greaterThan(priceToUse)) {
        discountAmount=priceToUse;
      }
      priceToUse=priceToUse.subtract(discountAmount);
      discountedPrice=priceToUse.getAmount();
      this.discountAmount=discountAmount.getAmount();
    }
  }
}
