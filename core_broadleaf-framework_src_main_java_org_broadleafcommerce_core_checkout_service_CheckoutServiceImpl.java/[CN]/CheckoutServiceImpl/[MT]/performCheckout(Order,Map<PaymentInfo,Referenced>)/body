{
  if (payments != null) {
    for (    PaymentInfo info : payments.keySet()) {
      if (info.getReferenceNumber() == null) {
        throw new CheckoutException("PaymentInfo reference number cannot be null",null);
      }
    }
    for (    Referenced referenced : payments.values()) {
      if (referenced.getReferenceNumber() == null) {
        throw new CheckoutException("Referenced reference number cannot be null",null);
      }
    }
  }
  CheckoutSeed seed=null;
  try {
    order=orderService.save(order,false);
    seed=new CheckoutSeed(order,payments,new HashMap<String,Object>());
    ProcessContext<CheckoutSeed> context=(ProcessContext<CheckoutSeed>)checkoutWorkflow.doActivities(seed);
    order=orderService.save(seed.getOrder(),false);
    order.getOrderMessages().addAll(((ActivityMessages)context).getActivityMessages());
    seed.setOrder(order);
    return seed;
  }
 catch (  PricingException e) {
    throw new CheckoutException("Unable to checkout order -- id: " + order.getId(),e,seed);
  }
catch (  WorkflowException e) {
    throw new CheckoutException("Unable to checkout order -- id: " + order.getId(),e.getRootCause(),seed);
  }
catch (  RequiredAttributeNotProvidedException e) {
    throw new CheckoutException("Unable to checkout order -- id: " + order.getId(),e.getCause(),seed);
  }
}
