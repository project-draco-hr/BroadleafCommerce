{
  Customer loggedInCustomer=customerService.readCustomerByUsername((String)authResult.getPrincipal());
  Customer anonymousCustomer=CustomerState.getCustomer(request);
  Long anonymousCartId=orderService.findCartForCustomer(anonymousCustomer) == null ? null : orderService.findCartForCustomer(anonymousCustomer).getId();
  MergeCartResponse mergeCartResponse=orderService.mergeCart(loggedInCustomer,anonymousCartId);
  if (!mergeCartResponse.getAddedItems().isEmpty()) {
    request.getSession().setAttribute(mergeCartItemsAddedKey,mergeCartResponse.getAddedItems());
  }
  if (!mergeCartResponse.getRemovedItems().isEmpty()) {
    request.getSession().setAttribute(mergeCartItemsRemovedKey,mergeCartResponse.getRemovedItems());
  }
}
