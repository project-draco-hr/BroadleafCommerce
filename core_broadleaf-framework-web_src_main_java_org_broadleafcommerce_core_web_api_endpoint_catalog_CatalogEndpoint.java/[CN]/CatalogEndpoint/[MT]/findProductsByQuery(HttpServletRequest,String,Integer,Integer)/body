{
  try {
    if (StringUtils.isNotEmpty(q)) {
      q=StringUtils.trim(q);
      q=exploitProtectionService.cleanString(q);
    }
 else {
      throw BroadleafWebServicesException.build(Response.Status.BAD_REQUEST.getStatusCode()).addMessage(BroadleafWebServicesException.SEARCH_QUERY_EMPTY);
    }
  }
 catch (  ServiceException e) {
    throw BroadleafWebServicesException.build(Response.Status.BAD_REQUEST.getStatusCode()).addMessage(BroadleafWebServicesException.SEARCH_QUERY_MALFORMED,q);
  }
  List<SearchFacetDTO> availableFacets=searchService.getSearchFacets();
  ProductSearchCriteria searchCriteria=facetService.buildSearchCriteria(request,availableFacets);
  try {
    ProductSearchResult result=null;
    result=searchService.findProductsByQuery(q,searchCriteria);
    facetService.setActiveFacetResults(result.getFacets(),request);
    SearchResultsWrapper wrapper=(SearchResultsWrapper)context.getBean(SearchResultsWrapper.class.getName());
    wrapper.wrapDetails(result,request);
    return wrapper;
  }
 catch (  ServiceException e) {
    throw BroadleafWebServicesException.build(Response.Status.INTERNAL_SERVER_ERROR.getStatusCode()).addMessage(BroadleafWebServicesException.SEARCH_ERROR);
  }
}
