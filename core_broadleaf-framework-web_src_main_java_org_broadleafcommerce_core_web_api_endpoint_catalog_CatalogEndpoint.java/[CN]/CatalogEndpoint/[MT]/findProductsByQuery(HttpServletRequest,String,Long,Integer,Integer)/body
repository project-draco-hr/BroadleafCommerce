{
  try {
    if (StringUtils.isNotEmpty(q)) {
      q=StringUtils.trim(q);
      q=exploitProtectionService.cleanString(q);
    }
  }
 catch (  ServiceException e) {
    throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).type(MediaType.TEXT_PLAIN).entity("The search query: " + q + " was incorrect or malformed.").build());
  }
  Category category=null;
  if (categoryId != null) {
    category=catalogService.findCategoryById(categoryId);
    if (category == null) {
      throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).type(MediaType.TEXT_PLAIN).entity("Category ID, " + categoryId + ", was not associated with a category.").build());
    }
  }
  List<SearchFacetDTO> availableFacets=searchService.getSearchFacets();
  ProductSearchCriteria searchCriteria=facetService.buildSearchCriteria(request,availableFacets);
  try {
    ProductSearchResult result=null;
    if (category != null) {
      result=searchService.findProductsByCategoryAndQuery(category,q,searchCriteria);
    }
 else {
      result=searchService.findProductsByQuery(q,searchCriteria);
    }
    facetService.setActiveFacetResults(result.getFacets(),request);
    SearchResultsWrapper wrapper=(SearchResultsWrapper)context.getBean(SearchResultsWrapper.class.getName());
    wrapper.wrap(result,request);
    return wrapper;
  }
 catch (  ServiceException e) {
    throw new WebApplicationException(Response.status(Response.Status.INTERNAL_SERVER_ERROR).type(MediaType.TEXT_PLAIN).entity("Problem occured executing search.").build());
  }
}
