{
synchronized (mutex) {
    Map<K,V> copy=new HashMap<K,V>();
    copy.putAll(map);
    copy.put(key,value);
    map=copy;
    return value;
  }
}
