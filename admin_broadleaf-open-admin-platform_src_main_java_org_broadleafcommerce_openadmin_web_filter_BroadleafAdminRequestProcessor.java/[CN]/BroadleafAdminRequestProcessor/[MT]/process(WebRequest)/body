{
  Site site=siteResolver.resolveSite(request);
  BroadleafRequestContext brc=new BroadleafRequestContext();
  BroadleafRequestContext.setBroadleafRequestContext(brc);
  brc.setSite(site);
  brc.setWebRequest(request);
  brc.setIgnoreSite(site == null);
  Locale locale=localeResolver.resolveLocale(request);
  brc.setLocale(locale);
  brc.setMessageSource(messageSource);
  TimeZone timeZone=broadleafTimeZoneResolver.resolveTimeZone(request);
  brc.setTimeZone(timeZone);
  AdminUser adminUser=adminRemoteSecurityService.getPersistentAdminUser();
  if (adminUser == null) {
    request.removeAttribute(BroadleafSandBoxResolver.SANDBOX_ID_VAR,WebRequest.SCOPE_GLOBAL_SESSION);
  }
 else {
    SandBox sandBox=sandBoxService.retrieveUserSandBox(null,adminUser);
    request.setAttribute(BroadleafSandBoxResolver.SANDBOX_ID_VAR,sandBox.getId(),WebRequest.SCOPE_GLOBAL_SESSION);
    brc.setSandbox(sandBox);
    brc.getAdditionalProperties().put(ADMIN_USER_PROPERTY,adminUser);
  }
}
