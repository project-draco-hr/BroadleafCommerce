{
  StringBuilder path=new StringBuilder();
  if (tempFileSystemBaseDirectory == null || "".equals(tempFileSystemBaseDirectory.trim())) {
    path=path.append(DEFAULT_STORAGE_DIRECTORY);
    if (!DEFAULT_STORAGE_DIRECTORY.endsWith("/")) {
      path=path.append('/');
    }
  }
 else {
    path=path.append(tempFileSystemBaseDirectory);
    if (!tempFileSystemBaseDirectory.endsWith("/")) {
      path=path.append('/');
    }
  }
  if (!skipSite) {
    BroadleafRequestContext brc=BroadleafRequestContext.getBroadleafRequestContext();
    if (brc.getSite() != null) {
      String siteDirectory="site-" + brc.getSite().getId();
      String siteHash=DigestUtils.md5Hex(siteDirectory);
      path=path.append(siteHash.substring(0,2)).append('/').append(siteDirectory);
    }
  }
  return path;
}
