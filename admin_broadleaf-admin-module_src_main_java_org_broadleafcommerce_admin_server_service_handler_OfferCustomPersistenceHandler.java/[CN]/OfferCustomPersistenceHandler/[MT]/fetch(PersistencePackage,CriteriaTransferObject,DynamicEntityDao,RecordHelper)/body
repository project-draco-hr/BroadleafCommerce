{
  String ceilingEntityFullyQualifiedClassname=persistencePackage.getCeilingEntityFullyQualifiedClassname();
  try {
    PersistencePerspective persistencePerspective=persistencePackage.getPersistencePerspective();
    Map<String,FieldMetadata> offerProperties=helper.getSimpleMergedProperties(Offer.class.getName(),persistencePerspective);
    BaseCtoConverter ctoConverter=helper.getCtoConverter(persistencePerspective,cto,Offer.class.getName(),offerProperties);
    PersistentEntityCriteria queryCriteria=ctoConverter.convert(cto,Offer.class.getName());
    if (!persistencePackage.getPersistencePerspective().getShowArchivedFields()) {
      SimpleFilterCriterionProvider criterionProvider=new SimpleFilterCriterionProvider(SimpleFilterCriterionProvider.FilterDataStrategy.NONE,0){
        @Override public Criterion getCriterion(        String targetPropertyName,        Object[] filterObjectValues,        Object[] directValues){
          return Restrictions.or(Restrictions.eq(targetPropertyName,'N'),Restrictions.isNull(targetPropertyName));
        }
      }
;
      FilterCriterion filterCriterion=new FilterCriterion(AssociationPath.ROOT,"archiveStatus.archived",criterionProvider);
      ((NestedPropertyCriteria)queryCriteria).add(filterCriterion);
    }
    List<Serializable> records=dynamicEntityDao.query(queryCriteria,Offer.class);
    Entity[] entities=helper.getRecords(offerProperties,records,null,null);
    for (int j=0; j < entities.length; j++) {
      Offer offer=(Offer)records.get(j);
      OfferRule orderRule=offer.getOfferMatchRules().get(OfferRuleType.ORDER.getType());
      if (orderRule != null) {
        entities[j].findProperty("appliesToOrderRules").setValue(orderRule.getMatchRule());
      }
      OfferRule customerRule=offer.getOfferMatchRules().get(OfferRuleType.CUSTOMER.getType());
      if (customerRule != null) {
        entities[j].findProperty("appliesToCustomerRules").setValue(customerRule.getMatchRule());
      }
      OfferRule fgRule=offer.getOfferMatchRules().get(OfferRuleType.FULFILLMENT_GROUP.getType());
      if (fgRule != null) {
        Property prop=new Property();
        prop.setName("appliesToFulfillmentGroupRules");
        prop.setValue(fgRule.getMatchRule());
        entities[j].addProperty(prop);
      }
      int k=0;
      Entity[] targetItemCriterias=new Entity[offer.getTargetItemCriteria().size()];
      for (      OfferItemCriteria oic : offer.getTargetItemCriteria()) {
        Property[] properties=new Property[2];
        Property mvelProperty=new Property();
        mvelProperty.setName("orderItemMatchRule");
        mvelProperty.setValue(oic.getOrderItemMatchRule());
        Property quantityProperty=new Property();
        quantityProperty.setName("quantity");
        quantityProperty.setValue(oic.getQuantity().toString());
        properties[0]=mvelProperty;
        properties[1]=quantityProperty;
        Entity criteria=new Entity();
        criteria.setProperties(properties);
        targetItemCriterias[k]=criteria;
        k++;
      }
      MVELToDataWrapperTranslator translator=new MVELToDataWrapperTranslator();
      DataWrapper wrapper=translator.createRuleData(targetItemCriterias,"orderItemMatchRule","quantity",ruleBuilderFieldServiceFactory.createInstance("ORDER_ITEM_FIELDS"));
      ObjectMapper mapper=new ObjectMapper();
      String targetItemCriteriaJson=mapper.writeValueAsString(wrapper);
      Property targetItemCriteriaJsonProp=new Property();
      targetItemCriteriaJsonProp.setName("targetItemCriteriaJson");
      targetItemCriteriaJsonProp.setValue(targetItemCriteriaJson);
      entities[j].addProperty(targetItemCriteriaJsonProp);
    }
    PersistencePerspective offerCodePersistencePerspective=new PersistencePerspective(null,new String[]{},new ForeignKey[]{new ForeignKey("offer",EntityImplementations.OFFER,null)});
    Map<String,FieldMetadata> offerCodeMergedProperties=helper.getSimpleMergedProperties(OfferCode.class.getName(),offerCodePersistencePerspective);
    for (    Entity record : entities) {
      CriteriaTransferObject offerCodeCto=new CriteriaTransferObject();
      FilterAndSortCriteria filterCriteria=offerCodeCto.get("offer");
      filterCriteria.setFilterValue(record.findProperty("id").getValue());
      BaseCtoConverter offerCodeCtoConverter=helper.getCtoConverter(offerCodePersistencePerspective,offerCodeCto,OfferCode.class.getName(),offerCodeMergedProperties);
      PersistentEntityCriteria offerCodeQueryCriteria=offerCodeCtoConverter.convert(offerCodeCto,OfferCode.class.getName());
      List<Serializable> offerCodes=dynamicEntityDao.query(offerCodeQueryCriteria,OfferCode.class);
      Entity[] offerCodeEntities=helper.getRecords(offerCodeMergedProperties,offerCodes,null,null);
      if (offerCodeEntities.length > 0) {
        Entity temp=new Entity();
        temp.setType(offerCodeEntities[0].getType());
        temp.setProperties(new Property[]{offerCodeEntities[0].findProperty("offerCode"),offerCodeEntities[0].findProperty("id")});
        record.mergeProperties("offerCode",temp);
      }
    }
    int totalRecords=helper.getTotalRecords(persistencePackage,cto,ctoConverter);
    DynamicResultSet response=new DynamicResultSet(null,entities,totalRecords);
    return response;
  }
 catch (  Exception e) {
    LOG.error("Unable to perform fetch for entity" + persistencePackage.getCeilingEntityFullyQualifiedClassname(),e);
    throw new ServiceException("Unable to perform fetch for entity: " + ceilingEntityFullyQualifiedClassname,e);
  }
}
