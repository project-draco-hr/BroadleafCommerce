{
  if (delegate.getOffer() != null && delegate.getFulfillmentGroup() != null) {
    if (delegate.getFulfillmentGroup().getRetailShippingPrice() != null) {
      Money priceToUse=delegate.getFulfillmentGroup().getRetailShippingPrice();
      discountedAmount=new Money(0);
      if ((delegate.getOffer().getApplyDiscountToSalePrice()) && (delegate.getFulfillmentGroup().getSaleShippingPrice() != null)) {
        priceToUse=delegate.getFulfillmentGroup().getSaleShippingPrice();
      }
      if (delegate.getOffer().getDiscountType().equals(OfferDiscountType.AMOUNT_OFF)) {
        discountedAmount=BroadleafCurrencyUtils.getMoney(delegate.getOffer().getValue(),delegate.getFulfillmentGroup().getOrder().getCurrency());
      }
 else       if (delegate.getOffer().getDiscountType().equals(OfferDiscountType.FIX_PRICE)) {
        discountedAmount=priceToUse.subtract(BroadleafCurrencyUtils.getMoney(delegate.getOffer().getValue(),delegate.getFulfillmentGroup().getOrder().getCurrency()));
      }
 else       if (delegate.getOffer().getDiscountType().equals(OfferDiscountType.PERCENT_OFF)) {
        discountedAmount=priceToUse.multiply(delegate.getOffer().getValue().divide(new BigDecimal("100")));
      }
      if (discountedAmount.greaterThan(priceToUse)) {
        discountedAmount=priceToUse;
      }
      priceToUse=priceToUse.subtract(discountedAmount);
      delegate.setDiscountedPrice(priceToUse);
    }
  }
}
