{
  JoinStructure joinTable=(JoinStructure)persistencePerspective.getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.JOINSTRUCTURE);
  Entity entity=super.buildEntity(record,request);
  entity.setType(new String[]{joinTable.getJoinStructureEntityClassname()});
  List<Property> properties=new ArrayList<Property>();
{
    Property property=new Property();
    property.setName(joinTable.getLinkedObjectPath() + "." + joinTable.getLinkedIdProperty());
    property.setValue(dataSource.stripDuplicateAllowSpecialCharacters(getLinkedValue()));
    properties.add(property);
  }
{
    Property property=new Property();
    property.setName(joinTable.getTargetObjectPath() + "." + joinTable.getTargetIdProperty());
    String id=dataSource.stripDuplicateAllowSpecialCharacters(dataSource.getPrimaryKeyValue(record));
    if (id == null || id.equals("")) {
      id=dataSource.stripDuplicateAllowSpecialCharacters(record.getAttribute("backup_id"));
    }
    property.setValue(id);
    properties.add(property);
  }
  if (joinTable.getSortField() != null) {
    Property property=new Property();
    property.setName(joinTable.getSortField());
    property.setValue(record.getAttribute(joinTable.getSortField()));
    properties.add(property);
  }
  List<Property> entityPropsList=new ArrayList<Property>();
  for (  Property temp : Arrays.asList(entity.getProperties())) {
    if (dataSource.getField(temp.getName()) == null) {
      entityPropsList.add(temp);
    }
 else     if (dataSource.getPolymorphicEntities().get(dataSource.getField(temp.getName()).getAttribute("inheritedFromType")) == null) {
      entityPropsList.add(temp);
    }
  }
  entity.setProperties(entityPropsList.toArray(new Property[entityPropsList.size()]));
  Property[] props=new Property[properties.size() + entity.getProperties().length];
  for (int j=0; j < properties.size(); j++) {
    props[j]=properties.get(j);
  }
  int count=properties.size();
  for (int j=0; j < entity.getProperties().length; j++) {
    props[count]=entity.getProperties()[j];
    count++;
  }
  entity.setProperties(props);
  return entity;
}
