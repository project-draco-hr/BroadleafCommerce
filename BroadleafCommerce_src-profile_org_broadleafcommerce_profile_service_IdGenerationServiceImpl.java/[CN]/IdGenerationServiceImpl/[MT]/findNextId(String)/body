{
  Id id=idTypeIdMap.get(idType);
  if (id == null || id.batchSize.equals(0L)) {
    if (logger.isDebugEnabled()) {
      logger.debug("I don't have the next id, going to the database");
    }
    IdGeneration idGeneration=idGenerationDao.findNextId(idType);
    Long nextId=idGeneration.getBatchStart();
    Long batchSize=idGeneration.getBatchSize();
    idGeneration.setBatchStart(nextId + batchSize);
    idGenerationDao.updateNextId(idGeneration);
    id=new Id(nextId,batchSize);
  }
 else {
    if (logger.isDebugEnabled()) {
      logger.debug("I already have the next id");
    }
  }
  Long retId=id.nextId++;
  id.batchSize--;
  idTypeIdMap.put(idType,id);
  return retId;
}
