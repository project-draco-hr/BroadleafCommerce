{
  Id id=idTypeIdMap.get(idType);
  IdGeneration idGeneration=null;
  if (id == null) {
synchronized (idTypeIdMap) {
      id=idTypeIdMap.get(idType);
      if (id == null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Getting the initial id from the database.");
        }
        idGeneration=idGenerationDao.findNextId(idType);
        id=new Id(idGeneration.getBatchStart(),0L);
      }
      idTypeIdMap.put(idType,id);
    }
  }
synchronized (id) {
    if (id.batchSize == 0L) {
      if (logger.isDebugEnabled()) {
        logger.debug("Updating batch size for idType " + idType);
      }
      Long prevBatchStart=idGeneration.getBatchStart();
      Long batchSize=idGeneration.getBatchSize();
      idGeneration.setBatchStart(prevBatchStart + batchSize);
      idGeneration=idGenerationDao.updateNextId(idGeneration);
      id.nextId=prevBatchStart;
    }
    Long retId=id.nextId++;
    id.batchSize--;
    return retId;
  }
}
