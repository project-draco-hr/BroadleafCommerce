{
  List<DiscreteOrderItem> itemsToRemove=new ArrayList<DiscreteOrderItem>();
  Map<String,OrderItem> gatheredItem=new HashMap<String,OrderItem>();
  for (  OrderItem orderItem : order.getOrderItems()) {
    if (orderItem instanceof BundleOrderItem) {
      for (      DiscreteOrderItem discreteOrderItem : ((BundleOrderItem)orderItem).getDiscreteOrderItems()) {
        gatherOrderLinkedDiscreteOrderItem(itemsToRemove,gatheredItem,discreteOrderItem,String.valueOf(orderItem.getId()));
      }
    }
 else {
      gatherOrderLinkedDiscreteOrderItem(itemsToRemove,gatheredItem,(DiscreteOrderItem)orderItem,null);
    }
  }
  for (  OrderItem orderItem : gatheredItem.values()) {
    orderItemService.saveOrderItem(orderItem);
  }
  for (  DiscreteOrderItem orderItem : itemsToRemove) {
    if (orderItem.getBundleOrderItem() == null) {
      cartService.removeItemFromOrder(order,orderItem,false);
    }
 else {
      cartService.removeItemFromBundle(order,orderItem.getBundleOrderItem(),orderItem,false);
    }
  }
}
