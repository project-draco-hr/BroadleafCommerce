{
  List<DiscreteOrderItem> itemsToRemove=new ArrayList<DiscreteOrderItem>();
  Map<String,OrderItem> gatheredItem=new HashMap<String,OrderItem>();
  for (  OrderItem orderItem : order.getOrderItems()) {
    if (orderItem instanceof BundleOrderItem) {
      for (      DiscreteOrderItem discreteOrderItem : ((BundleOrderItem)orderItem).getDiscreteOrderItems()) {
        gatherOrderLinkedDiscreteOrderItem(itemsToRemove,gatheredItem,discreteOrderItem,String.valueOf(orderItem.getId()));
      }
    }
 else {
      gatherOrderLinkedDiscreteOrderItem(itemsToRemove,gatheredItem,(DiscreteOrderItem)orderItem,null);
    }
  }
  for (  OrderItem orderItem : gatheredItem.values()) {
    orderItemService.saveOrderItem(orderItem);
  }
  for (  DiscreteOrderItem orderItem : itemsToRemove) {
    if (orderItem.getBundleOrderItem() == null) {
      OrderItemRequest orderItemRequest=new OrderItemRequest();
      orderItemRequest.setOrderItemId(orderItem.getId());
      try {
        orderService.removeItem(order,orderItemRequest,false);
      }
 catch (      ItemNotFoundException e) {
        throw new PricingException("Could not remove item",e);
      }
    }
 else {
      orderService.removeItemFromBundle(order,orderItem.getBundleOrderItem(),orderItem,false);
    }
  }
}
