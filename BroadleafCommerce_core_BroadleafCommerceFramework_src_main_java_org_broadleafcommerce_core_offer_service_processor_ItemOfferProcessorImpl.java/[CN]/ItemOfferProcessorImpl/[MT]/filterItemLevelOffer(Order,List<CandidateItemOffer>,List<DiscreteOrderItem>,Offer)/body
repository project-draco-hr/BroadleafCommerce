{
  boolean isNewFormat=(offer.getQualifyingItemCriteria() != null && offer.getQualifyingItemCriteria().size() > 0) || offer.getTargetItemCriteria() != null;
  boolean itemLevelQualification=false;
  boolean offerCreated=false;
  for (  OrderItem discreteOrderItem : discreteOrderItems) {
    if (couldOfferApplyToOrder(offer,order,discreteOrderItem)) {
      if (!isNewFormat) {
        CandidateQualifiedOffer candidate=createCandidateItemOffer(qualifiedItemOffers,offer,discreteOrderItem);
        if (!candidate.getCandidateTargets().contains(discreteOrderItem)) {
          candidate.getCandidateTargets().add(discreteOrderItem);
        }
        offerCreated=true;
        continue;
      }
      itemLevelQualification=true;
      break;
    }
    for (    FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
      if (couldOfferApplyToOrder(offer,order,discreteOrderItem,fulfillmentGroup)) {
        if (!isNewFormat) {
          CandidateQualifiedOffer candidate=createCandidateItemOffer(qualifiedItemOffers,offer,discreteOrderItem);
          if (!candidate.getCandidateTargets().contains(discreteOrderItem)) {
            candidate.getCandidateTargets().add(discreteOrderItem);
          }
          offerCreated=true;
          continue;
        }
        itemLevelQualification=true;
        break;
      }
    }
  }
  if (itemLevelQualification && !offerCreated) {
    CandidatePromotionItems candidates=couldOfferApplyToOrderItems(offer,discreteOrderItems);
    CandidateQualifiedOffer candidateOffer=null;
    if (candidates.isMatchedQualifier()) {
      candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null);
      candidateOffer.getCandidateQualifiersMap().putAll(candidates.getCandidateQualifiersMap());
    }
    if (candidates.isMatchedTarget()) {
      if (candidateOffer == null) {
        candidateOffer=createCandidateItemOffer(qualifiedItemOffers,offer,null);
      }
      for (      OrderItem candidateItem : candidates.getCandidateTargets()) {
        CandidateItemOffer itemOffer=((CandidateItemOffer)candidateOffer).clone();
        itemOffer.setOrderItem(candidateItem);
        candidateItem.getCandidateItemOffers().add(itemOffer);
      }
      candidateOffer.getCandidateTargets().addAll(candidates.getCandidateTargets());
    }
  }
}
