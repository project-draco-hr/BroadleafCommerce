{
  Offer promotion=itemOffer.getOffer();
  OrderItemPriceComparator priceComparator=new OrderItemPriceComparator(promotion);
  boolean matchFound=false;
  do {
    matchFound=false;
    int totalQualifiersNeeded=0;
    for (    OfferItemCriteria itemCriteria : itemOffer.getCandidateQualifiersMap().keySet()) {
      totalQualifiersNeeded+=itemCriteria.getQuantity();
    }
    int receiveQtyNeeded=promotion.getTargetItemCriteria().getQuantity();
    checkAll: {
      for (      OfferItemCriteria itemCriteria : itemOffer.getCandidateQualifiersMap().keySet()) {
        List<OrderItem> chargeableItems=itemOffer.getCandidateQualifiersMap().get(itemCriteria);
        Collections.sort(chargeableItems,priceComparator);
        int qualifierQtyNeeded=itemCriteria.getQuantity();
        for (        OrderItem chargeableItem : chargeableItems) {
          if (qualifierQtyNeeded > 0) {
            int itemQtyAvailableToBeUsedAsQualifier=chargeableItem.getQuantityAvailableToBeUsedAsQualifier(promotion);
            if (itemQtyAvailableToBeUsedAsQualifier > 0) {
              int qtyToMarkAsQualifier=Math.min(qualifierQtyNeeded,itemQtyAvailableToBeUsedAsQualifier);
              qualifierQtyNeeded-=qtyToMarkAsQualifier;
              chargeableItem.addPromotionQualifier(itemOffer,itemCriteria,qtyToMarkAsQualifier);
            }
          }
          if (qualifierQtyNeeded == 0) {
            totalQualifiersNeeded-=itemCriteria.getQuantity();
            break;
          }
        }
        if (qualifierQtyNeeded != 0) {
          break checkAll;
        }
      }
      checkTargets: {
        List<OrderItem> chargeableItems=itemOffer.getCandidateTargets();
        Collections.sort(chargeableItems,priceComparator);
        for (        OrderItem chargeableItem : chargeableItems) {
          if (receiveQtyNeeded > 0) {
            int itemQtyAvailableToBeUsedAsTarget=chargeableItem.getQuantityAvailableToBeUsedAsTarget(promotion);
            if (itemQtyAvailableToBeUsedAsTarget > 0) {
              int qtyToMarkAsTarget=Math.min(receiveQtyNeeded,itemQtyAvailableToBeUsedAsTarget);
              receiveQtyNeeded-=qtyToMarkAsTarget;
              chargeableItem.addPromotionDiscount(itemOffer,itemOffer.getOffer().getTargetItemCriteria(),qtyToMarkAsTarget);
            }
          }
          if (receiveQtyNeeded == 0) {
            break checkTargets;
          }
        }
      }
    }
    boolean criteriaMatched=true;
    if (receiveQtyNeeded != 0 || totalQualifiersNeeded != 0) {
      for (      OfferItemCriteria itemCriteria : itemOffer.getCandidateQualifiersMap().keySet()) {
        List<OrderItem> chargeableItems=itemOffer.getCandidateQualifiersMap().get(itemCriteria);
        clearAllNonFinalizedQuantities(chargeableItems);
      }
      clearAllNonFinalizedQuantities(itemOffer.getCandidateTargets());
      criteriaMatched=false;
    }
    if (criteriaMatched) {
      matchFound=true;
      finalizeQuantities(discreteOrderItems);
    }
  }
 while (matchFound);
  if (order.getSplitItems().size() == 0) {
    order.getSplitItems().addAll(order.getOrderItems());
  }
  Iterator<OrderItem> chargeableItemsIterator=order.getSplitItems().iterator();
  List<OrderItem> splitChargeableItems=new ArrayList<OrderItem>();
  while (chargeableItemsIterator.hasNext()) {
    OrderItem chargeableItem=chargeableItemsIterator.next();
    if (itemOffer.getCandidateTargets().contains(chargeableItem)) {
      List<OrderItem> splitItems=chargeableItem.split();
      if (splitItems != null && splitItems.size() > 0) {
        chargeableItemsIterator.remove();
        splitChargeableItems.addAll(splitItems);
      }
    }
  }
  order.getSplitItems().addAll(splitChargeableItems);
}
