{
  ClassMetadata cmd=getClassMetadata(className);
  BasicCollectionMetadata fmd=null;
  for (  Property p : cmd.getProperties()) {
    if (p.getName().equals(fieldName) && p.getMetadata() instanceof BasicCollectionMetadata) {
      fmd=(BasicCollectionMetadata)p.getMetadata();
    }
  }
  Property[] properties=new Property[entityForm.getFields().size() + 1];
  int i=0;
  for (  Entry<String,Field> entry : entityForm.getFields().entrySet()) {
    Property p=new Property();
    p.setName(entry.getKey());
    p.setValue(entry.getValue().getValue());
    properties[i++]=p;
  }
  ForeignKey foreignField=(ForeignKey)fmd.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY);
  Property p=new Property();
  p.setName(foreignField.getManyToField());
  p.setValue(parentId);
  properties[i++]=p;
  Entity entity=new Entity();
  entity.setProperties(properties);
  entity.setType(new String[]{entityForm.getEntityType()});
  return add(entity,fmd.getCollectionCeilingEntity(),new ForeignKey[]{foreignField},null);
}
