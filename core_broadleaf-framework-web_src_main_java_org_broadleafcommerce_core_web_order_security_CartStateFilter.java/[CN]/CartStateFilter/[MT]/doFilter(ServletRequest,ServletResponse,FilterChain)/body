{
  cartStateProcessor.process(new ServletWebRequest((HttpServletRequest)request,(HttpServletResponse)response));
  if (!requestRequiresLock(request)) {
    chain.doFilter(request,response);
    return;
  }
  Order order=CartState.getCart();
  if (LOG.isTraceEnabled()) {
    LOG.trace("Thread[" + Thread.currentThread().getId() + "] attempting to lock order["+ order.getId()+ "]");
  }
  Object lockObject=null;
  try {
    lockObject=orderLockManager.acquireLock(order);
    if (LOG.isTraceEnabled()) {
      LOG.trace("Thread[" + Thread.currentThread().getId() + "] grabbed lock for order["+ order.getId()+ "]");
    }
    CartState.setCart(orderService.reloadOrder(order));
    chain.doFilter(request,response);
  }
  finally {
    orderLockManager.releaseLock(lockObject);
    if (LOG.isTraceEnabled()) {
      LOG.trace("Thread[" + Thread.currentThread().getId() + "] released lock for order["+ order.getId()+ "]");
    }
  }
}
