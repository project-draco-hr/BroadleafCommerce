{
  Customer customer=(Customer)request.getAttribute(CustomerStateFilter.getCustomerRequestAttributeName());
  if (customer != null) {
    if (LOG.isTraceEnabled()) {
      LOG.trace("Looking up cart for customer " + customer.getId());
    }
    Order cart=orderService.findCartForCustomer(customer);
    if (cart == null) {
      cart=orderService.getNullOrder();
    }
 else {
      try {
        updateCartService.validateCart(cart);
      }
 catch (      IllegalArgumentException e) {
        if (copyCartToNewLocaleAndPricelist) {
          UpdateCartResponse updateCartResponse=updateCartService.copyCartToNewLocaleAndPricelist(cart);
          request.setAttribute("updateCartResponse",updateCartResponse);
        }
 else {
          BroadleafRequestContext brc=BroadleafRequestContext.getBroadleafRequestContext();
          orderService.cancelOrder(cart);
          cart=orderService.createNewCartForCustomer(customer,brc.getPriceList(),brc.getLocale());
        }
      }
    }
    request.setAttribute(cartRequestAttributeName,cart);
    Map<String,Object> ruleMap=(Map<String,Object>)request.getAttribute(BLC_RULE_MAP_PARAM);
    if (ruleMap == null) {
      ruleMap=new HashMap<String,Object>();
    }
    ruleMap.put("cart",cart);
    request.setAttribute(BLC_RULE_MAP_PARAM,ruleMap);
  }
  chain.doFilter(request,response);
}
