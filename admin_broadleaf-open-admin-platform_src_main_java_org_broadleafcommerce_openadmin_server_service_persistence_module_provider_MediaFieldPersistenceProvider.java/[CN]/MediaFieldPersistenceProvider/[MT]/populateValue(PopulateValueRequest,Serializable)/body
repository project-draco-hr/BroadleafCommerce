{
  if (!canHandlePersistence(populateValueRequest,instance)) {
    return FieldProviderResponse.NOT_HANDLED;
  }
  FieldProviderResponse response=FieldProviderResponse.HANDLED;
  boolean dirty;
  try {
    setNonDisplayableValues(populateValueRequest);
    Class<?> startingValueType=getStartingValueType(populateValueRequest);
    Class<?> valueType=getValueType(populateValueRequest,startingValueType);
    if (Media.class.isAssignableFrom(valueType)) {
      Media newMedia=convertJsonToMedia(populateValueRequest.getProperty().getUnHtmlEncodedValue());
      boolean persist=false;
      Object parent;
      Media media;
      try {
        parent=populateValueRequest.getFieldManager().getFieldValue(instance,populateValueRequest.getProperty().getName());
        if (parent == null) {
          parent=startingValueType.newInstance();
          if (!startingValueType.equals(valueType)) {
            setupJoinEntityParent(populateValueRequest,instance,valueType,parent);
          }
          populateValueRequest.getFieldManager().setFieldValue(instance,populateValueRequest.getProperty().getName(),parent);
          persist=true;
        }
        media=establishMedia(populateValueRequest,parent);
      }
 catch (      FieldNotAvailableException e) {
        throw new IllegalArgumentException(e);
      }
      populateValueRequest.getProperty().setOriginalValue(convertMediaToJson(media));
      dirty=establishDirtyState(newMedia,media);
      if (dirty) {
        updateMedia(populateValueRequest,newMedia,persist,parent,media);
        response=FieldProviderResponse.HANDLED_BREAK;
      }
    }
 else {
      throw new UnsupportedOperationException("MediaFields only work with Media types.");
    }
  }
 catch (  Exception e) {
    throw new PersistenceException(e);
  }
  populateValueRequest.getProperty().setIsDirty(dirty);
  return response;
}
