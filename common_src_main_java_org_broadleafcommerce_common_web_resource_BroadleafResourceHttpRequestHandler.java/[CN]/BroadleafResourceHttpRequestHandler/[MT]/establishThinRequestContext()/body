{
  BroadleafRequestContext oldBrc=BroadleafRequestContext.getBroadleafRequestContext();
  if (oldBrc == null || oldBrc.getSite() == null || oldBrc.getTheme() == null) {
    HttpServletRequest req=((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getRequest();
    HttpSession session=req.getSession(false);
    SecurityContext ctx=readSecurityContextFromSession(session);
    if (ctx != null) {
      SecurityContextHolder.setContext(ctx);
    }
    BroadleafRequestContext newBrc=new BroadleafRequestContext();
    ServletWebRequest swr=new ServletWebRequest(req);
    newBrc.setSite(siteResolver.resolveSite(swr,true));
    newBrc.setSandBox(sbResolver.resolveSandBox(swr,newBrc.getSite()));
    BroadleafRequestContext.setBroadleafRequestContext(newBrc);
    newBrc.setTheme(themeResolver.resolveTheme(swr));
  }
}
