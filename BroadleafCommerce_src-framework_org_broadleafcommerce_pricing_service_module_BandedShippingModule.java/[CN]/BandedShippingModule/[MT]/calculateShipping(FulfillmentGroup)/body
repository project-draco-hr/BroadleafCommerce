{
  Address address=fulfillmentGroup.getAddress();
  String state=(address != null && address.getState() != null) ? address.getState().getAbbreviation() : null;
  BigDecimal retailTotal=new BigDecimal(0);
  String feeType=feeTypeMapping.get(fulfillmentGroup.getMethod());
  String feeSubType=((feeSubTypeMapping.get(state) == null) ? feeSubTypeMapping.get("ALL") : feeSubTypeMapping.get(state));
  for (  FulfillmentGroupItem fulfillmentGroupItem : fulfillmentGroup.getFulfillmentGroupItems()) {
    BigDecimal price=(fulfillmentGroupItem.getRetailPrice() != null) ? fulfillmentGroupItem.getRetailPrice().getAmount().multiply(BigDecimal.valueOf(fulfillmentGroupItem.getQuantity())) : null;
    if (price == null) {
      price=fulfillmentGroupItem.getOrderItem().getRetailPrice().getAmount().multiply(BigDecimal.valueOf(fulfillmentGroupItem.getQuantity()));
    }
    retailTotal=retailTotal.add(price);
  }
  ShippingRate sr=shippingRateDao.readShippingRateByFeeTypesUnityQty(feeType,feeSubType,retailTotal);
  if (sr == null) {
    throw new NotImplementedException("Shipping rate " + fulfillmentGroup.getMethod() + " not supported");
  }
  BigDecimal shippingPrice=new BigDecimal(0);
  if (sr.getBandResultPercent().compareTo(0) > 0) {
    BigDecimal percent=new BigDecimal(sr.getBandResultPercent() / 100);
    shippingPrice=retailTotal.multiply(percent);
  }
 else {
    shippingPrice=sr.getBandResultQuantity();
  }
  fulfillmentGroup.setShippingPrice(new Money(shippingPrice));
}
