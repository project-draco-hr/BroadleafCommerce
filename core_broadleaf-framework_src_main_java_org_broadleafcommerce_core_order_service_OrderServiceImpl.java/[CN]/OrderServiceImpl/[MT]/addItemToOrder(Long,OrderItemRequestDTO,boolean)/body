{
  if (orderItemRequestDTO.getQuantity() == 0) {
    LOG.debug("Not adding item to order because quantity is zero.");
    return null;
  }
  Order order=validateOrder(orderId);
  Product product=validateProduct(orderItemRequestDTO.getProductId());
  Sku sku=determineSku(product,orderItemRequestDTO.getSkuId(),orderItemRequestDTO.getItemAttributes());
  Category category=determineCategory(product,orderItemRequestDTO.getCategoryId());
  if (!(product instanceof ProductBundle)) {
    DiscreteOrderItem item=createDiscreteOrderItem(sku,product,category,orderItemRequestDTO.getQuantity(),orderItemRequestDTO.getItemAttributes());
    return addOrderItemToOrder(order,item,priceOrder);
  }
 else {
    ProductBundle bundle=(ProductBundle)product;
    BundleOrderItem bundleOrderItem=(BundleOrderItem)orderItemDao.create(OrderItemType.BUNDLE);
    bundleOrderItem.setQuantity(orderItemRequestDTO.getQuantity());
    bundleOrderItem.setCategory(category);
    bundleOrderItem.setSku(sku);
    bundleOrderItem.setName(sku.getName());
    bundleOrderItem.setProductBundle(bundle);
    for (    SkuBundleItem skuBundleItem : bundle.getSkuBundleItems()) {
      Product bundleProduct=skuBundleItem.getBundle();
      Sku bundleSku=skuBundleItem.getSku();
      Category bundleCategory=determineCategory(bundleProduct,orderItemRequestDTO.getCategoryId());
      DiscreteOrderItem bundleDiscreteItem=createDiscreteOrderItem(bundleSku,bundleProduct,bundleCategory,skuBundleItem.getQuantity(),orderItemRequestDTO.getItemAttributes());
      bundleDiscreteItem.setSkuBundleItem(skuBundleItem);
      bundleDiscreteItem.setBundleOrderItem(bundleOrderItem);
      bundleOrderItem.getDiscreteOrderItems().add(bundleDiscreteItem);
    }
    bundleOrderItem.updatePrices();
    bundleOrderItem.assignFinalPrice();
    return addOrderItemToOrder(order,bundleOrderItem,priceOrder);
  }
}
