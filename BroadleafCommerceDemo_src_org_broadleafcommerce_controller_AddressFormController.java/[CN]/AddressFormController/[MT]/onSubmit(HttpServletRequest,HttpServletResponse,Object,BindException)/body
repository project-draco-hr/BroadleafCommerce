{
  Authentication auth=SecurityContextHolder.getContext().getAuthentication();
  Address addressFromDB=new BroadleafCustomerAddress();
  Address address=(Address)command;
  Customer customer=customerService.readCustomerByUsername(auth.getName());
  if (request.getParameter("addressId") != null) {
    addressFromDB=addressService.readAddressById(Long.valueOf(request.getParameter("addressId")));
  }
 else {
    List<Address> addressList=addressService.readAddressByUserId(customer.getId());
    for (Iterator<Address> itr=addressList.iterator(); itr.hasNext(); ) {
      Address addressItr=itr.next();
      if (address.getAddressName().equalsIgnoreCase(addressItr.getAddressName())) {
        errors.rejectValue("addressName","addressName.duplicate",new Object[]{new String(address.getAddressName())},null);
      }
    }
  }
  if (!errors.hasErrors()) {
    AddressStandarizationResponse standardizedResponse=addressStandardizationService.standardizeAddress(address);
    if (standardizedResponse.isErrorDetected()) {
      logger.debug("Address verification Failed. Please check the address and try again");
      address.setStandardized(false);
      errors.rejectValue("zipCode","addressVerification.failed",null,null);
    }
 else {
      address.setStandardized(true);
      standardizedResponse.getAddress().setAddressName(address.getAddressName());
      if (addressFromDB.getId() != null) {
        standardizedResponse.getAddress().setId(addressFromDB.getId());
      }
      addressFromDB=standardizedResponse.getAddress();
      addressFromDB.setCustomer(customer);
    }
  }
  ModelAndView mav=new ModelAndView(getSuccessView(),errors.getModel());
  if (errors.hasErrors()) {
    logger.debug("Error returning back to the form");
    return showForm(request,response,errors);
  }
  addressService.saveAddress(addressFromDB);
  mav.addObject("saved",true);
  return mav;
}
