{
  if (offer != null && orderItem != null) {
    Money priceToUse=orderItem.getRetailPrice();
    Money discountAmount=new Money(0);
    if ((offer.getApplyDiscountToSalePrice()) && (orderItem.getSalePrice() != null)) {
      priceToUse=orderItem.getSalePrice();
    }
    if (offer.getDiscountType().equals(OfferDiscountType.AMOUNT_OFF)) {
      discountAmount=offer.getValue();
    }
 else     if (offer.getDiscountType().equals(OfferDiscountType.FIX_PRICE)) {
      discountAmount=priceToUse.subtract(offer.getValue());
    }
 else     if (offer.getDiscountType().equals(OfferDiscountType.PERCENT_OFF)) {
      discountAmount=priceToUse.multiply(offer.getValue().divide(new BigDecimal("100")).getAmount());
    }
    if (discountAmount.greaterThan(priceToUse)) {
      discountAmount=priceToUse;
    }
    priceToUse=priceToUse.subtract(discountAmount);
    discountedPrice=priceToUse.getAmount();
    this.discountAmount=discountAmount.getAmount();
  }
}
