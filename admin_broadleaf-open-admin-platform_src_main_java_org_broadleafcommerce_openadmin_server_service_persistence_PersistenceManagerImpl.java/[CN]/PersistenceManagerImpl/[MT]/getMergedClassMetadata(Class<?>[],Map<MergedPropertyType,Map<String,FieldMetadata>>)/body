{
  ClassMetadata classMetadata=new ClassMetadata();
  classMetadata.setPolymorphicEntities(dynamicEntityDao.getClassTree(entities));
  List<Property> propertiesList=new ArrayList<Property>();
  for (  PersistenceModule module : modules) {
    module.extractProperties(mergedProperties,propertiesList);
  }
  for (int i=0; i < entities.length - 1; i++) {
    for (    Property myProperty : propertiesList) {
      if (myProperty.getMetadata().getInheritedFromType().equals(entities[i].getName()) && myProperty.getMetadata().getOrder() != null) {
        for (        Property property : propertiesList) {
          if (!property.getMetadata().getInheritedFromType().equals(entities[i].getName()) && property.getMetadata().getOrder() != null && property.getMetadata().getOrder() >= myProperty.getMetadata().getOrder()) {
            property.getMetadata().setOrder(property.getMetadata().getOrder() + 1);
          }
        }
      }
    }
  }
  Property[] properties=new Property[propertiesList.size()];
  properties=propertiesList.toArray(properties);
  Arrays.sort(properties,new Comparator<Property>(){
    public int compare(    Property o1,    Property o2){
      if (o1.getMetadata().getOrder() != null && o2.getMetadata().getOrder() != null) {
        return o1.getMetadata().getOrder().compareTo(o2.getMetadata().getOrder());
      }
 else       if (o1.getMetadata().getOrder() != null && o2.getMetadata().getOrder() == null) {
        return -1;
      }
 else       if (o1.getMetadata().getOrder() == null && o2.getMetadata().getOrder() != null) {
        return 1;
      }
 else       if (o1.getMetadata().getFriendlyName() != null && o2.getMetadata().getFriendlyName() != null) {
        return o1.getMetadata().getFriendlyName().compareTo(o2.getMetadata().getFriendlyName());
      }
 else {
        return o1.getName().compareTo(o2.getName());
      }
    }
  }
);
  classMetadata.setProperties(properties);
  classMetadata.setCurrencyCode(Money.defaultCurrency().getCurrencyCode());
  return classMetadata;
}
