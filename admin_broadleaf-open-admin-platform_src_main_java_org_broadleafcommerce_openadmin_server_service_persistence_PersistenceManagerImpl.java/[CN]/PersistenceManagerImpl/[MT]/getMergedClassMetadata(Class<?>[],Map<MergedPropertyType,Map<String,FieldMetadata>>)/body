{
  ClassMetadata classMetadata=new ClassMetadata();
  classMetadata.setPolymorphicEntities(dynamicEntityDao.getClassTree(entities));
  List<Property> propertiesList=new ArrayList<Property>();
  for (  PersistenceModule module : modules) {
    module.extractProperties(entities,mergedProperties,propertiesList);
  }
  for (int i=0; i < entities.length - 1; i++) {
    for (    Property myProperty : propertiesList) {
      if (myProperty.getMetadata().getInheritedFromType().equals(entities[i].getName()) && myProperty.getMetadata().getOrder() != null) {
        for (        Property property : propertiesList) {
          if (!property.getMetadata().getInheritedFromType().equals(entities[i].getName()) && property.getMetadata().getOrder() != null && property.getMetadata().getOrder() >= myProperty.getMetadata().getOrder()) {
            property.getMetadata().setOrder(property.getMetadata().getOrder() + 1);
          }
        }
      }
    }
  }
  Property[] properties=new Property[propertiesList.size()];
  properties=propertiesList.toArray(properties);
  Arrays.sort(properties,new Comparator<Property>(){
    public int compare(    Property o1,    Property o2){
      Integer order1;
      Integer order2;
      String friendlyName1;
      String friendlyName2;
      String name1;
      String name2;
      if (o1.getMetadata() instanceof BasicFieldMetadata) {
        BasicFieldMetadata b1=(BasicFieldMetadata)o1.getMetadata();
        order1=b1.getGroupOrder() == null ? 99999 : b1.getGroupOrder();
      }
 else {
        order1=99999;
      }
      if (o2.getMetadata() instanceof BasicFieldMetadata) {
        BasicFieldMetadata b2=(BasicFieldMetadata)o2.getMetadata();
        order2=b2.getGroupOrder() == null ? 99999 : b2.getGroupOrder();
      }
 else {
        order2=99999;
      }
      order1+=o1.getMetadata().getOrder() == null ? 99999 : o1.getMetadata().getOrder();
      order2+=o2.getMetadata().getOrder() == null ? 99999 : o2.getMetadata().getOrder();
      friendlyName1=o1.getMetadata().getFriendlyName() == null ? "zzzzz" : o1.getMetadata().getFriendlyName();
      friendlyName2=o2.getMetadata().getFriendlyName() == null ? "zzzzz" : o2.getMetadata().getFriendlyName();
      name1=o1.getName() == null ? "zzzzz" : o1.getName();
      name2=o2.getName() == null ? "zzzzz" : o2.getName();
      int c=order1.compareTo(order2);
      if (c == 0) {
        c=friendlyName1.compareTo(friendlyName2);
        if (c == 0) {
          c=name1.compareTo(name2);
        }
      }
      return c;
    }
  }
);
  classMetadata.setProperties(properties);
  classMetadata.setCurrencyCode(Money.defaultCurrency().getCurrencyCode());
  return classMetadata;
}
