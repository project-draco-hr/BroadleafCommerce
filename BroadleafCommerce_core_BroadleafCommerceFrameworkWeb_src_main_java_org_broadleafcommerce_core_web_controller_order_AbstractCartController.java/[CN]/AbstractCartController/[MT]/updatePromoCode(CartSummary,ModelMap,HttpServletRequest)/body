{
  Order currentCartOrder=retrieveCartOrder(request,model);
  if (cartSummary.getPromoCode() != null) {
    OfferCode code=offerService.lookupOfferCodeByCode(cartSummary.getPromoCode());
    if (code != null) {
      currentCartOrder.addOfferCode(code);
      List<Offer> offers=offerService.buildOfferListForOrder(currentCartOrder);
      offerService.applyOffersToOrder(offers,currentCartOrder);
      currentCartOrder=updateFulfillmentGroups(cartSummary,currentCartOrder);
      cartSummary.setOrderDiscounts(currentCartOrder.getTotalAdjustmentsValue().getAmount());
    }
 else {
      model.addAttribute("promoError","Invalid promo code entered.");
    }
  }
  if (currentCartOrder.getOrderItems() != null) {
    cartSummary.getRows().clear();
    for (    OrderItem orderItem : currentCartOrder.getOrderItems()) {
      CartOrderItem cartOrderItem=new CartOrderItem();
      cartOrderItem.setOrderItem(orderItem);
      cartOrderItem.setQuantity(orderItem.getQuantity());
      cartSummary.getRows().add(cartOrderItem);
    }
  }
  cartSummary.setPromoCode(null);
  model.addAttribute("currentCartOrder",currentCartOrder);
  model.addAttribute("cartSummary",cartSummary);
  return cartView;
}
