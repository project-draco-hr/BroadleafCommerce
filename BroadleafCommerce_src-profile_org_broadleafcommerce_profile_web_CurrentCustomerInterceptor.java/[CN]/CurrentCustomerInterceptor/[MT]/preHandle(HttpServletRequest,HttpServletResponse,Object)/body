{
  WebApplicationContext applicationContext=WebApplicationContextUtils.getWebApplicationContext(request.getSession().getServletContext());
  CustomerState customerState=(CustomerState)applicationContext.getBean("blCustomerState");
  Customer requestCustomer=null;
  checkSession: {
    Customer sessionCustomer=customerState.getCustomer(request);
    if (sessionCustomer != null) {
      requestCustomer=sessionCustomer;
      break checkSession;
    }
    String cookieCustomerIdVal=CookieUtils.getCookieValue(request,CookieUtils.CUSTOMER_COOKIE_NAME);
    Long cookieCustomerId=null;
    if (cookieCustomerIdVal != null) {
      cookieCustomerId=new Long(cookieCustomerIdVal);
    }
    CustomerService customerService=(CustomerService)applicationContext.getBean("blCustomerService");
    if (cookieCustomerId != null) {
      Customer cookieCustomer=customerService.createCustomerFromId(cookieCustomerId);
      customerState.setCustomer(cookieCustomer,request);
      requestCustomer=cookieCustomer;
      break checkSession;
    }
 else {
      Customer firstTimeCustomer=customerService.createCustomerFromId(null);
      CookieUtils.setCookieValue(response,CookieUtils.CUSTOMER_COOKIE_NAME,firstTimeCustomer.getId() + "","/",604800);
      customerState.setCustomer(firstTimeCustomer,request);
      requestCustomer=firstTimeCustomer;
      break checkSession;
    }
  }
  request.setAttribute(CUSTOMER_REQUEST_ATTR_NAME,requestCustomer);
  return true;
}
