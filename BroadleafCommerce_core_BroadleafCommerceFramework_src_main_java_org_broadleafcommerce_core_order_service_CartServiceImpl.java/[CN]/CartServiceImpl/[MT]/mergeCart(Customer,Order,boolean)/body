{
  MergeCartResponse mergeCartResponse=new MergeCartResponse();
  ReconstructCartResponse reconstructCartResponse=reconstructCart(customer,priceOrder);
  mergeCartResponse.setRemovedItems(reconstructCartResponse.getRemovedItems());
  Order customerCart=reconstructCartResponse.getOrder();
  if (anonymousCart != null && customerCart != null && anonymousCart.getId().equals(customerCart.getId())) {
    mergeCartResponse.setMerged(false);
  }
 else {
    mergeCartResponse.setMerged(customerCart != null && customerCart.getOrderItems().size() > 0);
  }
  if (anonymousCart != null && (customerCart == null || !customerCart.getId().equals(anonymousCart.getId()))) {
    if (anonymousCart != null && anonymousCart.getOrderItems() != null && !anonymousCart.getOrderItems().isEmpty()) {
      if (customerCart == null) {
        customerCart=createNewCartForCustomer(customer);
      }
      for (      OrderItem orderItem : anonymousCart.getOrderItems()) {
        if (orderItem instanceof DiscreteOrderItem) {
          orderItem.removeAllAdjustments();
          orderItem.removeAllCandidateItemOffers();
          DiscreteOrderItem discreteOrderItem=(DiscreteOrderItem)orderItem;
          if (discreteOrderItem.getSku().isActive(discreteOrderItem.getProduct(),orderItem.getCategory())) {
            DiscreteOrderItemRequest itemRequest=createDiscreteOrderItemRequest(discreteOrderItem);
            addDiscreteItemToOrder(customerCart,itemRequest,priceOrder);
            mergeCartResponse.getAddedItems().add(orderItem);
          }
 else {
            mergeCartResponse.getRemovedItems().add(orderItem);
          }
        }
 else         if (orderItem instanceof BundleOrderItem) {
          BundleOrderItem bundleOrderItem=(BundleOrderItem)orderItem;
          orderItem.removeAllAdjustments();
          orderItem.removeAllCandidateItemOffers();
          boolean removeBundle=false;
          List<DiscreteOrderItemRequest> discreteOrderItemRequests=new ArrayList<DiscreteOrderItemRequest>();
          for (          DiscreteOrderItem discreteOrderItem : bundleOrderItem.getDiscreteOrderItems()) {
            discreteOrderItem.removeAllAdjustments();
            discreteOrderItem.removeAllCandidateItemOffers();
            DiscreteOrderItemRequest itemRequest=createDiscreteOrderItemRequest(discreteOrderItem);
            discreteOrderItemRequests.add(itemRequest);
            if (!discreteOrderItem.getSku().isActive(discreteOrderItem.getProduct(),orderItem.getCategory())) {
              removeBundle=true;
            }
          }
          BundleOrderItemRequest bundleOrderItemRequest=createBundleOrderItemRequest(bundleOrderItem,discreteOrderItemRequests);
          if (!removeBundle) {
            addBundleItemToOrder(customerCart,bundleOrderItemRequest,priceOrder);
            mergeCartResponse.getAddedItems().add(orderItem);
          }
 else {
            mergeCartResponse.getRemovedItems().add(orderItem);
          }
        }
      }
      Map<String,OfferCode> customerOffersMap=new HashMap<String,OfferCode>();
      for (      OfferCode customerOffer : customerCart.getAddedOfferCodes()) {
        customerOffersMap.put(customerOffer.getOfferCode(),customerOffer);
      }
      for (      OfferCode anonymousOffer : anonymousCart.getAddedOfferCodes()) {
        if (!customerOffersMap.containsKey(anonymousOffer.getOfferCode())) {
          OfferCode transferredCode=offerService.lookupOfferCodeByCode(anonymousOffer.getOfferCode());
          OfferInfo info=anonymousCart.getAdditionalOfferInformation().get(anonymousOffer.getOffer());
          OfferInfo offerInfo=offerDao.createOfferInfo();
          for (          String key : info.getFieldValues().keySet()) {
            offerInfo.getFieldValues().put(key,info.getFieldValues().get(key));
          }
          customerCart.getAdditionalOfferInformation().put(transferredCode.getOffer(),offerInfo);
          customerCart.addOfferCode(transferredCode);
        }
      }
      customerCart=save(customerCart,true);
      cancelOrder(anonymousCart);
    }
  }
  mergeCartResponse.setOrder(customerCart);
  return mergeCartResponse;
}
