{
  if (this.type != null) {
    if (this.flavor == PersistenceContextFlavor.JPA) {
      return (this.type == PersistenceContextType.EXTENDED ? resolveExtendedEntityManager(target,requestingBeanName) : resolveEntityManager(requestingBeanName,this.unitName));
    }
 else {
      EntityManager standardManager=resolveEntityManager(requestingBeanName,this.unitName);
      EntityManager sandboxManager=resolveEntityManager(requestingBeanName,this.sandBoxUnitName);
      BroadleafEntityManagerInvocationHandler handler=new BroadleafEntityManagerInvocationHandler((HibernateEntityManager)standardManager,(HibernateEntityManager)sandboxManager,(HibernateCleaner)getBeanFactory().getBean("blHibernateCleaner"));
      HibernateEntityManager proxy=(HibernateEntityManager)Proxy.newProxyInstance(getClass().getClassLoader(),new Class[]{HibernateEntityManager.class,DualEntityManager.class},handler);
      return proxy;
    }
  }
 else {
    return resolveEntityManagerFactory(requestingBeanName);
  }
}
