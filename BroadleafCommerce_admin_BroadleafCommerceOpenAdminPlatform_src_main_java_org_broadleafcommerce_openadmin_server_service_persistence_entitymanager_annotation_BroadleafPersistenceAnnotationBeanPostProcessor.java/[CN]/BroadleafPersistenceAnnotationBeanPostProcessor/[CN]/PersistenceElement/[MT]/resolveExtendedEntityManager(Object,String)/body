{
  EntityManager em=getPersistenceContext(this.unitName,true);
  if (em == null) {
    EntityManagerFactory emf=getPersistenceUnit(this.unitName);
    if (emf == null) {
      emf=findEntityManagerFactory(this.unitName,requestingBeanName);
    }
    em=ExtendedEntityManagerCreator.createContainerManagedEntityManager(emf,this.properties);
  }
  if (em instanceof EntityManagerProxy && getBeanFactory() != null && !getBeanFactory().isPrototype(requestingBeanName)) {
    getExtendedEntityManagersToClose().put(target,((EntityManagerProxy)em).getTargetEntityManager());
  }
  return em;
}
