{
  int j=0;
  for (  String propertyName : propertyNames) {
    final Type type=propertyTypes.get(j);
    boolean isPropertyForeignKey=testForeignProperty(foreignField,prefix,propertyName);
    int additionalForeignKeyIndexPosition=findAdditionalForeignKeyIndex(additionalForeignFields,prefix,propertyName);
    j++;
    Field myField=FieldManager.getSingleField(targetClass,propertyName);
    if (!type.isAnyType() && !type.isCollectionType() || isPropertyForeignKey || additionalForeignKeyIndexPosition >= 0 || presentationAttributes.containsKey(propertyName)) {
      if (myField != null && (myField.getAnnotation(AdminPresentationCollection.class) != null || myField.getAnnotation(AdminPresentationAdornedTargetCollection.class) != null || myField.getAnnotation(AdminPresentationMap.class) != null)) {
        final CollectionMetadata fieldMetadata=(CollectionMetadata)presentationAttributes.get(propertyName);
        setExcludedBasedOnShowIfProperty(fieldMetadata);
        fieldMetadata.setInheritedFromType(targetClass.getName());
        fieldMetadata.setAvailableToTypes(new String[]{targetClass.getName()});
        fields.put(propertyName,fieldMetadata);
        fieldMetadata.accept(new MetadataVisitorAdapter(){
          @Override public void visit(          AdornedTargetCollectionMetadata metadata){
            if (StringUtils.isEmpty(fieldMetadata.getCollectionCeilingEntity())) {
              fieldMetadata.setCollectionCeilingEntity(type.getReturnedClass().getName());
              AdornedTargetList targetList=((AdornedTargetList)metadata.getPersistencePerspective().getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.ADORNEDTARGETLIST));
              targetList.setAdornedTargetEntityClassname(metadata.getCollectionCeilingEntity());
            }
          }
          @Override public void visit(          BasicCollectionMetadata metadata){
          }
          @Override public void visit(          MapMetadata metadata){
          }
        }
);
      }
 else {
        FieldMetadata presentationAttribute=presentationAttributes.get(propertyName);
        Boolean amIExcluded=isParentExcluded || !testPropertyInclusion(presentationAttribute);
        Boolean includeField=testPropertyRecursion(prefix,parentClasses,propertyName,targetClass,ceilingEntityFullyQualifiedClassname);
        SupportedFieldType explicitType=null;
        if (presentationAttribute != null && presentationAttribute instanceof BasicFieldMetadata) {
          explicitType=((BasicFieldMetadata)presentationAttribute).getExplicitFieldType();
        }
        Class<?> returnedClass=type.getReturnedClass();
        checkProp: {
          if (type.isComponentType() && includeField) {
            buildComponentProperties(targetClass,foreignField,additionalForeignFields,additionalNonPersistentProperties,mergedPropertyType,fields,idProperty,populateManyToOneFields,includeFields,excludeFields,configurationKey,ceilingEntityFullyQualifiedClassname,propertyName,type,returnedClass,parentClasses,amIExcluded,prefix);
            break checkProp;
          }
          if (type.isEntityType() && !returnedClass.isAssignableFrom(targetClass) && populateManyToOneFields&& includeField) {
            buildEntityProperties(fields,foreignField,additionalForeignFields,additionalNonPersistentProperties,populateManyToOneFields,includeFields,excludeFields,configurationKey,ceilingEntityFullyQualifiedClassname,propertyName,returnedClass,targetClass,parentClasses,prefix,amIExcluded);
            break checkProp;
          }
        }
        if (includeField || isPropertyForeignKey || additionalForeignKeyIndexPosition >= 0) {
          buildProperty(targetClass,foreignField,additionalForeignFields,mergedPropertyType,componentProperties,fields,idProperty,prefix,propertyName,type,isPropertyForeignKey,additionalForeignKeyIndexPosition,presentationAttribute,explicitType,returnedClass);
        }
      }
    }
  }
}
