{
  Class<?>[] cache;
synchronized (LOCK_OBJECT) {
    cache=POLYMORPHIC_ENTITY_CACHE.get(ceilingClass);
    if (cache == null) {
      List<Class<?>> entities=new ArrayList<Class<?>>();
      for (      Object item : getSessionFactory().getAllClassMetadata().values()) {
        ClassMetadata metadata=(ClassMetadata)item;
        Class<?> mappedClass=metadata.getMappedClass();
        if (mappedClass != null && ceilingClass.isAssignableFrom(mappedClass)) {
          AdminPresentationClass adminPresentationClass=mappedClass.getAnnotation(AdminPresentationClass.class);
          if (adminPresentationClass == null || !adminPresentationClass.excludeFromPolymorphism()) {
            entities.add(mappedClass);
          }
        }
      }
      Class<?>[] sortedEntities=sortEntities(ceilingClass,entities);
      cache=sortedEntities;
      POLYMORPHIC_ENTITY_CACHE.put(ceilingClass,sortedEntities);
    }
  }
  return cache;
}
