{
  CommerceRequestStateImpl requestState=(CommerceRequestStateImpl)CommerceRequestStateImpl.getRequestState(request);
  String productId=request.getParameter("productId");
  if (requestState.getCategory() != null) {
    if (productId != null) {
      try {
        Product item=catalogService.findProductById(new Long(productId));
        if (item != null) {
          List<Sku> skus=catalogService.findSkusForProductId(item.getId());
          ProductSkus productSkus=new ProductSkus(item,skus);
          Map<Object,Object> model=new HashMap<Object,Object>();
          model.put("productSkus",productSkus);
          return new ModelAndView(getDefaultProductView(),model);
        }
      }
 catch (      NumberFormatException e) {
        logger.error("Unable to parse productId: " + e.getMessage());
      }
    }
 else {
      List<Category> subCategories=catalogService.findAllSubCategories(requestState.getCategory());
      Map<Object,Object> model=new HashMap<Object,Object>();
      model.put("subCategories",subCategories);
      model.put("category",requestState.getCategory());
      return new ModelAndView(getDefaultView(),model);
    }
  }
  return null;
}
