{
  if (getOffer() != null && getOrder() != null) {
    if (getOrder().getSubTotal() != null) {
      Money priceToUse=getOrder().getSubTotal();
      Money discountAmount=BroadleafCurrencyUtils.getMoney(BigDecimal.ZERO,getOrder().getDelegate().getCurrency());
      if (getOffer().getDiscountType().equals(OfferDiscountType.AMOUNT_OFF)) {
        discountAmount=BroadleafCurrencyUtils.getMoney(getOffer().getValue(),getOrder().getDelegate().getCurrency());
      }
 else       if (getOffer().getDiscountType().equals(OfferDiscountType.FIX_PRICE)) {
        discountAmount=priceToUse.subtract(BroadleafCurrencyUtils.getMoney(getOffer().getValue(),getOrder().getDelegate().getCurrency()));
      }
 else       if (getOffer().getDiscountType().equals(OfferDiscountType.PERCENT_OFF)) {
        discountAmount=priceToUse.multiply(getOffer().getValue().divide(new BigDecimal("100")));
      }
      if (discountAmount.greaterThan(priceToUse)) {
        discountAmount=priceToUse;
      }
      priceToUse=priceToUse.subtract(discountAmount);
      setDiscountedPrice(priceToUse);
    }
  }
}
