{
  LOG.info("Rebuilding the solr index...");
  StopWatch s=new StopWatch();
  List<Product> products=productDao.readAllActiveProducts(SystemTime.asDate());
  List<Field> fields=fieldDao.readAllProductFields();
  List<Locale> locales=getAllLocales();
  List<PriceList> priceLists=getAllPriceLists();
  Collection<SolrInputDocument> documents=new ArrayList<SolrInputDocument>();
  for (  Product product : products) {
    documents.add(buildDocument(product,fields,locales,priceLists));
  }
  if (LOG.isTraceEnabled()) {
    for (    SolrInputDocument document : documents) {
      LOG.trace(document);
    }
  }
  try {
    String deleteQuery=getNamespaceFieldName() + ":" + getCurrentNamespace();
    LOG.trace("Deleting by query: " + deleteQuery);
    server.deleteByQuery(deleteQuery);
    server.commit();
    server.add(documents);
    server.commit();
  }
 catch (  SolrServerException e) {
    throw new ServiceException("Could not rebuild index",e);
  }
  LOG.info("Finished rebuilding the solr index in " + s.toLapString());
}
