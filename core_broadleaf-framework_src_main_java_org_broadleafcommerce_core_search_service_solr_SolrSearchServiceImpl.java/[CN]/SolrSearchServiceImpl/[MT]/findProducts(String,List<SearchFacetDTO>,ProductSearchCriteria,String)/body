{
  Map<String,SearchFacetDTO> namedFacetMap=getNamedFacetMap(facets,searchCriteria);
  SolrQuery solrQuery=new SolrQuery().setQuery(qualifiedSolrQuery).setFields("id").setRows(searchCriteria.getPageSize()).setStart((searchCriteria.getPage() - 1) * searchCriteria.getPageSize());
  attachSortClause(solrQuery,searchCriteria,defaultSort);
  attachActiveFacetFilters(solrQuery,namedFacetMap,searchCriteria);
  attachFacets(solrQuery,namedFacetMap);
  QueryResponse response;
  try {
    response=server.query(solrQuery);
  }
 catch (  SolrServerException e) {
    throw new ServiceException("Could not perform search",e);
  }
  setFacetResults(namedFacetMap,response);
  sortFacetResults(namedFacetMap);
  List<Product> products=getProducts(response);
  ProductSearchResult result=new ProductSearchResult();
  result.setFacets(facets);
  result.setProducts(products);
  setPagingAttributes(result,response,searchCriteria);
  return result;
}
