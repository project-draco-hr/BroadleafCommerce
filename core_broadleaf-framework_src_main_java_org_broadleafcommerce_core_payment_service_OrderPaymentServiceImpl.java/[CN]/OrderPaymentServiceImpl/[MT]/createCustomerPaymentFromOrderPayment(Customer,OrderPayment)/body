{
  String cardType=null;
  String expDate=null;
  String lastFour=null;
  String token=null;
  for (  PaymentTransaction paymentTransaction : orderPayment.getTransactions()) {
    if (cardType == null) {
      cardType=paymentTransaction.getAdditionalFields().get(PaymentAdditionalFieldType.CARD_TYPE.getType());
    }
    if (expDate == null) {
      expDate=paymentTransaction.getAdditionalFields().get(PaymentAdditionalFieldType.EXP_DATE.getType());
    }
    if (lastFour == null) {
      lastFour=paymentTransaction.getAdditionalFields().get(PaymentAdditionalFieldType.LAST_FOUR.getType());
    }
    if (token == null) {
      token=paymentTransaction.getAdditionalFields().get(PaymentAdditionalFieldType.TOKEN.getType());
    }
  }
  CustomerPayment customerPayment=customerPaymentService.readCustomerPaymentByToken(token);
  if (customerPayment == null) {
    customerPayment=customerPaymentService.create();
  }
 else {
    return customerPayment;
  }
  customerPayment.setCustomer(customer);
  customerPayment.setBillingAddress(orderPayment.getBillingAddress());
  customerPayment.setPaymentGatewayType(orderPayment.getGatewayType());
  if (expDate != null) {
    customerPayment.setExpirationDate(expDate);
  }
  customerPayment.setCardType(cardType);
  customerPayment.setLastFour(lastFour);
  customerPayment.setPaymentToken(token);
  String paymentName=orderPayment.getPaymentName();
  if (paymentName == null || paymentName.isEmpty()) {
    if (customerPayment.getCardType() != null && customerPayment.getLastFour() != null) {
      paymentName=customerPayment.getCardType() + " ending in " + customerPayment.getLastFour();
    }
 else {
      paymentName="Payment #" + customer.getCustomerPayments().size();
    }
  }
  customerPayment.setPaymentName(paymentName);
  return customerPaymentService.saveCustomerPayment(customerPayment);
}
