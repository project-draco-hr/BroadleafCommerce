{
  List<DiscreteOrderItem> itemsToRemove=new ArrayList<DiscreteOrderItem>();
  List<FulfillmentGroupItem> fgItemsToRemove=new ArrayList<FulfillmentGroupItem>();
  Map<Long,Map<String,Object[]>> gatherMap=new HashMap<Long,Map<String,Object[]>>();
  for (  FulfillmentGroup group : order.getFulfillmentGroups()) {
    Map<String,Object[]> gatheredItem=gatherMap.get(group.getId());
    if (gatheredItem == null) {
      gatheredItem=new HashMap<String,Object[]>();
      gatherMap.put(group.getId(),gatheredItem);
    }
    for (    FulfillmentGroupItem fgItem : group.getFulfillmentGroupItems()) {
      OrderItem orderItem=fgItem.getOrderItem();
      if (orderItem instanceof BundleOrderItem) {
        for (        DiscreteOrderItem discreteOrderItem : ((BundleOrderItem)orderItem).getDiscreteOrderItems()) {
          if (CollectionUtils.isEmpty(orderItem.getOrderItemAdjustments())) {
            gatherFulfillmentGroupLinkedDiscreteOrderItem(itemsToRemove,fgItemsToRemove,gatheredItem,fgItem,discreteOrderItem,String.valueOf(orderItem.getId()),options,true);
          }
        }
      }
 else       if (CollectionUtils.isEmpty(orderItem.getOrderItemAdjustments())) {
        gatherFulfillmentGroupLinkedDiscreteOrderItem(itemsToRemove,fgItemsToRemove,gatheredItem,fgItem,(DiscreteOrderItem)orderItem,null,options,true);
      }
    }
  }
  for (  Map<String,Object[]> values : gatherMap.values()) {
    for (    Object[] item : values.values()) {
      orderItemService.saveOrderItem((OrderItem)item[0]);
      fulfillmentGroupItemDao.save((FulfillmentGroupItem)item[1]);
    }
  }
  for (  FulfillmentGroupItem fgItem : fgItemsToRemove) {
    FulfillmentGroup fg=fgItem.getFulfillmentGroup();
    fg.getFulfillmentGroupItems().remove(fgItem);
    fulfillmentGroupItemDao.delete(fgItem);
    if (fg.getFulfillmentGroupItems().isEmpty()) {
      order.getFulfillmentGroups().remove(fg);
      fg.setOrder(null);
    }
  }
  for (  DiscreteOrderItem orderItem : itemsToRemove) {
    if (orderItem.getBundleOrderItem() == null) {
      orderItem.getOrder().getOrderItems().remove(orderItem);
      orderItem.setOrder(null);
    }
 else {
      BundleOrderItem bundleOrderItem=orderItem.getBundleOrderItem();
      bundleOrderItem.getDiscreteOrderItems().remove(orderItem);
      orderItem.setBundleOrderItem(null);
      orderItemService.saveOrderItem(bundleOrderItem);
    }
  }
}
