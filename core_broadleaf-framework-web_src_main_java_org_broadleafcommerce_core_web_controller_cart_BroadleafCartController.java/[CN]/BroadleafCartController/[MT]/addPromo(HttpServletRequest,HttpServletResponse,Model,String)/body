{
  Order cart=CartState.getCart();
  Boolean promoAdded=false;
  String exception="";
  if (cart != null && !(cart instanceof NullOrderImpl)) {
    OfferCode offerCode=offerService.lookupOfferCodeByCode(customerOffer);
    if (offerCode != null) {
      try {
        orderService.addOfferCode(cart,offerCode,false);
        promoAdded=true;
        cart=orderService.save(cart,true);
      }
 catch (      OfferMaxUseExceededException e) {
        exception="Use Limit Exceeded";
      }
    }
 else {
      exception="Invalid Code";
    }
  }
 else {
    exception="Invalid cart";
  }
  if (isAjaxRequest(request)) {
    Map<String,Object> extraData=new HashMap<String,Object>();
    extraData.put("promoAdded",promoAdded);
    extraData.put("exception",exception);
    model.addAttribute("blcextradata",new ObjectMapper().writeValueAsString(extraData));
    return getCartView();
  }
 else {
    model.addAttribute("exception",exception);
    return getCartView();
  }
}
