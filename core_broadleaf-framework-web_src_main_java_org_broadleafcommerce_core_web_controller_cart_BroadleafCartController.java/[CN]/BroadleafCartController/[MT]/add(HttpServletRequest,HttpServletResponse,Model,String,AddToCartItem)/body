{
  Order cart=CartState.getCart(request);
  if (cart == null || cart.equals(cartService.getNullOrder())) {
    cart=cartService.createNewCartForCustomer(CustomerState.getCustomer(request));
  }
  cartService.addItemToOrder(cart.getId(),itemRequest,false);
  cart=cartService.save(cart,true);
  Map<String,Object> responseMap=new HashMap<String,Object>();
  responseMap.put("productId",itemRequest.getProductId());
  responseMap.put("productName",catalogService.findProductById(itemRequest.getProductId()).getName());
  responseMap.put("quantityAdded",itemRequest.getQuantity());
  responseMap.put("cartItemCount",String.valueOf(cart.getItemCount()));
  if (isAjaxRequest(request)) {
    return responseMap;
  }
 else {
    sendRedirect(request,response,nonAjaxSuccessUrl);
  }
  return null;
}
