{
  SearchQuery input=new SearchQuery();
  input.setQueryString(queryString);
  SearchIntercept intercept=searchService.getInterceptForTerm(queryString);
  if (intercept != null) {
    return "redirect:" + intercept.getRedirect();
  }
  List<Product> products=null;
  products=searchService.performSearch(input.getQueryString());
  SearchFilterUtil.filterProducts(products,request.getParameterMap(),new String[]{"manufacturer","defaultCategory.id","sku.salePrice"});
  model.addAttribute("queryString",input.getQueryString());
  model.addAttribute("products",products);
  List<Category> categories=new ArrayList<Category>();
  Map<Long,List<Product>> categoryGroups=new HashMap<Long,List<Product>>();
  for (  Product prod : products) {
    Category cat=prod.getDefaultCategory();
    if (!categoryGroups.containsKey(cat.getId())) {
      categories.add(cat);
      categoryGroups.put(cat.getId(),new ArrayList<Product>());
    }
    categoryGroups.get(cat.getId()).add(prod);
  }
  model.addAttribute("categories",categories);
  model.addAttribute("categoryGroups",categoryGroups);
  if (ajax == null || !ajax.booleanValue() || (originalQueryString != null && !originalQueryString.equals(queryString))) {
    return "search";
  }
 else {
    return "searchAjax";
  }
}
