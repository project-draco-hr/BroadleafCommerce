{
  Map<FulfillmentGroupOfferPotential,List<PromotableCandidateFulfillmentGroupOffer>> offerMap=new HashMap<FulfillmentGroupOfferPotential,List<PromotableCandidateFulfillmentGroupOffer>>();
  for (  PromotableCandidateFulfillmentGroupOffer candidate : qualifiedFGOffers) {
    FulfillmentGroupOfferPotential potential=new FulfillmentGroupOfferPotential();
    potential.setOffer(candidate.getOffer());
    if (offerMap.get(potential) == null) {
      offerMap.put(potential,new ArrayList<PromotableCandidateFulfillmentGroupOffer>());
    }
    offerMap.get(potential).add(candidate);
  }
  List<FulfillmentGroupOfferPotential> potentials=new ArrayList<FulfillmentGroupOfferPotential>();
  for (  FulfillmentGroupOfferPotential potential : offerMap.keySet()) {
    List<PromotableCandidateFulfillmentGroupOffer> fgOffers=offerMap.get(potential);
    Collections.sort(fgOffers,new ReverseComparator(new BeanComparator("discountedAmount",new NullComparator())));
    Collections.sort(fgOffers,new BeanComparator("priority",new NullComparator()));
    if (potential.getOffer().getMaxUses() > 0 && fgOffers.size() > potential.getOffer().getMaxUses()) {
      for (int j=potential.getOffer().getMaxUses(); j < fgOffers.size(); j++) {
        fgOffers.remove(j);
      }
    }
    for (    PromotableCandidateFulfillmentGroupOffer candidate : fgOffers) {
      if (potential.getTotalSavings().getAmount() == BankersRounding.zeroAmount()) {
        potential.setTotalSavings(new Money(candidate.getFulfillmentGroup().getDelegate().getOrder().getCurrency().getCurrencyCode()));
      }
      potential.setTotalSavings(potential.getTotalSavings().add(candidate.getFulfillmentGroup().getPriceBeforeAdjustments(candidate.getOffer().getApplyDiscountToSalePrice()).subtract(candidate.getDiscountedPrice())));
      potential.setPriority(candidate.getOffer().getPriority());
    }
    potentials.add(potential);
  }
  Collections.sort(potentials,new BeanComparator("totalSavings",Collections.reverseOrder()));
  Collections.sort(potentials,new BeanComparator("priority"));
  potentials=removeTrailingNotCombinableFulfillmentGroupOffers(potentials);
  boolean fgOfferApplied=false;
  for (  FulfillmentGroupOfferPotential potential : potentials) {
    Offer offer=potential.getOffer();
    if (offer.getTreatAsNewFormat() == null || !offer.getTreatAsNewFormat()) {
      if ((offer.isStackable()) || !fgOfferApplied) {
        boolean alreadyContainsNotCombinableOfferAtAnyLevel=order.isNotCombinableOfferAppliedAtAnyLevel();
        List<PromotableCandidateFulfillmentGroupOffer> candidates=offerMap.get(potential);
        for (        PromotableCandidateFulfillmentGroupOffer candidate : candidates) {
          applyFulfillmentGroupOffer(candidate);
          fgOfferApplied=true;
        }
        if (!offer.isCombinableWithOtherOffers() || alreadyContainsNotCombinableOfferAtAnyLevel) {
          fgOfferApplied=compareAndAdjustFulfillmentGroupOffers(order,fgOfferApplied);
          if (fgOfferApplied) {
            break;
          }
        }
      }
    }
 else {
      if (!order.containsNotStackableFulfillmentGroupOffer() || !fgOfferApplied) {
        boolean alreadyContainsTotalitarianOffer=order.isTotalitarianOfferApplied();
        List<PromotableCandidateFulfillmentGroupOffer> candidates=offerMap.get(potential);
        for (        PromotableCandidateFulfillmentGroupOffer candidate : candidates) {
          applyFulfillmentGroupOffer(candidate);
          fgOfferApplied=true;
        }
        if ((offer.isTotalitarianOffer() != null && offer.isTotalitarianOffer()) || alreadyContainsTotalitarianOffer) {
          fgOfferApplied=compareAndAdjustFulfillmentGroupOffers(order,fgOfferApplied);
          if (fgOfferApplied) {
            break;
          }
        }
 else         if (!offer.isCombinableWithOtherOffers()) {
          break;
        }
      }
    }
  }
  return fgOfferApplied;
}
