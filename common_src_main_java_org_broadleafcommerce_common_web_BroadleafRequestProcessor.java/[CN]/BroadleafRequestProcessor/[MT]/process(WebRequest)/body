{
  Site site=siteResolver.resolveSite(request);
  BroadleafRequestContext brc=new BroadleafRequestContext();
  brc.setSite(site);
  brc.setWebRequest(request);
  if (site == null) {
    brc.setIgnoreSite(true);
  }
  BroadleafRequestContext.setBroadleafRequestContext(brc);
  Locale locale=localeResolver.resolveLocale(request);
  TimeZone timeZone=broadleafTimeZoneResolver.resolveTimeZone(request);
  BroadleafCurrency currency=currencyResolver.resolveCurrency(request);
  RequestDTO requestDTO=(RequestDTO)request.getAttribute(REQUEST_DTO_PARAM_NAME,WebRequest.SCOPE_REQUEST);
  if (requestDTO == null) {
    requestDTO=new RequestDTOImpl(request);
  }
  SandBox currentSandbox=sandboxResolver.resolveSandBox(request,site);
  if (currentSandbox != null) {
    SandBoxContext previewSandBoxContext=new SandBoxContext();
    previewSandBoxContext.setSandBoxId(currentSandbox.getId());
    previewSandBoxContext.setPreviewMode(true);
    SandBoxContext.setSandBoxContext(previewSandBoxContext);
  }
  Theme theme=themeResolver.resolveTheme(request);
  brc.setLocale(locale);
  brc.setBroadleafCurrency(currency);
  brc.setSandbox(currentSandbox);
  brc.setTheme(theme);
  brc.setMessageSource(messageSource);
  brc.setTimeZone(timeZone);
  brc.setRequestDTO(requestDTO);
  Map<String,Object> ruleMap=(Map<String,Object>)request.getAttribute("blRuleMap",WebRequest.SCOPE_REQUEST);
  if (ruleMap == null) {
    LOG.trace("Creating ruleMap and adding in Locale.");
    ruleMap=new HashMap<String,Object>();
    request.setAttribute("blRuleMap",ruleMap,WebRequest.SCOPE_REQUEST);
  }
 else {
    LOG.trace("Using pre-existing ruleMap - added by non standard BLC process.");
  }
  ruleMap.put("locale",locale);
}
