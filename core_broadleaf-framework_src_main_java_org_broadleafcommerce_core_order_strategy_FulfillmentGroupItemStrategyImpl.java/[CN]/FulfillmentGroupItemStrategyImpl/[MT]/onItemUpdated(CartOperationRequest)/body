{
  Order order=request.getOrder();
  OrderItem orderItem=request.getAddedOrderItem();
  Integer orderItemQuantityDelta=request.getOrderItemQuantityDelta();
  if (orderItemQuantityDelta == 0) {
    return request;
  }
 else {
    if (orderItem instanceof BundleOrderItem) {
      List<OrderItem> itemsToUpdate=new ArrayList<OrderItem>(((BundleOrderItem)orderItem).getDiscreteOrderItems());
      for (      OrderItem oi : itemsToUpdate) {
        int qtyMultiplier=oi.getQuantity() / orderItem.getQuantity();
        order=updateItemQuantity(order,oi,(qtyMultiplier * orderItemQuantityDelta));
      }
    }
 else {
      order=updateItemQuantity(order,orderItem,orderItemQuantityDelta);
    }
  }
  request.setOrder(order);
  return request;
}
