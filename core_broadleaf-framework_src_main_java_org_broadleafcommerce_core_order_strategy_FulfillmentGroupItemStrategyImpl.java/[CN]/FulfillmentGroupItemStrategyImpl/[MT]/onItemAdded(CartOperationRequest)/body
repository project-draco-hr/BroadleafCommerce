{
  Order order=request.getOrder();
  OrderItem orderItem=request.getAddedOrderItem();
  FulfillmentGroup fulfillmentGroup=null;
  if (order.getFulfillmentGroups().size() == 0) {
    fulfillmentGroup=fulfillmentGroupService.createEmptyFulfillmentGroup();
    fulfillmentGroup.setOrder(order);
    fulfillmentGroup=fulfillmentGroupService.save(fulfillmentGroup);
    order.getFulfillmentGroups().add(fulfillmentGroup);
  }
 else {
    fulfillmentGroup=order.getFulfillmentGroups().get(0);
  }
  if (orderItem instanceof BundleOrderItem) {
    List<OrderItem> itemsToAdd=new ArrayList<OrderItem>(((BundleOrderItem)orderItem).getDiscreteOrderItems());
    for (    OrderItem oi : itemsToAdd) {
      fulfillmentGroup=addItemToFulfillmentGroup(order,oi,fulfillmentGroup);
    }
  }
 else {
    fulfillmentGroup=addItemToFulfillmentGroup(order,orderItem,fulfillmentGroup);
  }
  order=fulfillmentGroup.getOrder();
  request.setOrder(order);
  return request;
}
