{
  Order cart=CartState.getCart();
  if (cart != null) {
    Map<PaymentInfo,Referenced> payments=new HashMap<PaymentInfo,Referenced>();
    orderService.removePaymentsFromOrder(cart,PaymentInfoType.CREDIT_CARD);
    if (billingForm.isUseShippingAddress()) {
      copyShippingAddressToBillingAddress(cart,billingForm);
    }
    billingInfoFormValidator.validate(billingForm,result);
    if (result.hasErrors()) {
      populateModelWithShippingReferenceData(request,model);
      return getCheckoutView();
    }
    PaymentInfo ccInfo=creditCardPaymentInfoFactory.constructPaymentInfo(cart);
    ccInfo.setAddress(billingForm.getAddress());
    cart.getPaymentInfos().add(ccInfo);
    CreditCardPaymentInfo ccReference=(CreditCardPaymentInfo)securePaymentInfoService.create(PaymentInfoType.CREDIT_CARD);
    ccReference.setNameOnCard(billingForm.getCreditCardName());
    ccReference.setReferenceNumber(ccInfo.getReferenceNumber());
    ccReference.setPan(billingForm.getCreditCardNumber());
    ccReference.setCvvCode(billingForm.getCreditCardCvvCode());
    ccReference.setExpirationMonth(Integer.parseInt(billingForm.getCreditCardExpMonth()));
    ccReference.setExpirationYear(Integer.parseInt(billingForm.getCreditCardExpYear()));
    payments.put(ccInfo,ccReference);
    CheckoutResponse checkoutResponse=null;
    boolean checkoutError=false;
    try {
      checkoutResponse=checkoutService.performCheckout(cart,payments);
    }
 catch (    CheckoutException ex) {
      checkoutError=true;
    }
    if (checkoutError || (checkoutResponse != null && !checkoutResponse.getPaymentResponse().getResponseItems().get(ccInfo).getTransactionSuccess())) {
      populateModelWithShippingReferenceData(request,model);
      result.rejectValue("creditCardNumber","payment.exception",null,null);
      return getCheckoutView();
    }
    return getConfirmationView(cart.getOrderNumber());
  }
  return getCartPageRedirect();
}
