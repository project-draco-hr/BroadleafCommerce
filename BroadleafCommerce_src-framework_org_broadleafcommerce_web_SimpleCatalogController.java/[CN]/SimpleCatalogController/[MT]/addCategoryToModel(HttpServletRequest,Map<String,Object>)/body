{
  Category rootCategory=null;
  if (getRootCategoryId() != null) {
    rootCategory=catalogService.findCategoryById(getRootCategoryId());
  }
  if (rootCategory == null) {
    throw new IllegalStateException("Catalog Controller configured incorrectly - root category not found: " + rootCategoryId);
  }
  String categoryId=request.getParameter("categoryId");
  Category category=null;
  if (categoryId != null) {
    category=catalogService.findCategoryById(new Long(categoryId));
  }
  if (category == null) {
    model.put("categoryError",true);
  }
  model.put("rootCategory",rootCategory);
  if (category != null) {
    model.put("currentCategory",category);
  }
 else {
    model.put("currentCategory",rootCategory);
  }
}
