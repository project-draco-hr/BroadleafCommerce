{
  OfferContext offerContext=OfferContext.getOfferContext();
  if (offerContext == null || offerContext.executePromotionCalculation) {
    PromotableOrder promotableOrder=promotableItemFactory.createPromotableOrder(order);
    List<Offer> filteredOffers=orderOfferProcessor.filterOffers(offers,order.getCustomer());
    if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
      if (LOG.isTraceEnabled()) {
        LOG.trace("No offers applicable to this order.");
      }
      orderOfferProcessor.clearAllOfferAdjustmentsAndFinalizePrice(order);
      return;
    }
 else {
      List<PromotableCandidateOrderOffer> qualifiedOrderOffers=new ArrayList<PromotableCandidateOrderOffer>();
      List<PromotableCandidateItemOffer> qualifiedItemOffers=new ArrayList<PromotableCandidateItemOffer>();
      itemOfferProcessor.filterOffers(promotableOrder,filteredOffers,qualifiedOrderOffers,qualifiedItemOffers);
      if ((qualifiedItemOffers.isEmpty()) && (qualifiedOrderOffers.isEmpty())) {
        orderOfferProcessor.clearAllOfferAdjustmentsAndFinalizePrice(order);
      }
 else {
        itemOfferProcessor.applyAndCompareOrderAndItemOffers(promotableOrder,qualifiedOrderOffers,qualifiedItemOffers);
      }
    }
    orderService.save(order,false);
  }
}
