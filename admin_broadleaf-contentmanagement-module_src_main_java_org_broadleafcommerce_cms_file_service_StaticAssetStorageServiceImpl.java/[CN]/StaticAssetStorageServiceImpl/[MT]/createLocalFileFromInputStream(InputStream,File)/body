{
  FileWorkArea workArea=null;
  try {
    if (!baseLocalFile.getParentFile().exists()) {
      boolean directoriesCreated=false;
      if (!baseLocalFile.getParentFile().exists()) {
        directoriesCreated=baseLocalFile.getParentFile().mkdirs();
        if (!directoriesCreated) {
          if (!baseLocalFile.getParentFile().exists()) {
            throw new RuntimeException("Unable to create middle directories for file: " + baseLocalFile.getAbsolutePath());
          }
        }
      }
    }
    workArea=broadleafFileService.initializeWorkArea();
    File tmpFile=new File(workArea.getFilePathLocation(),baseLocalFile.getName());
    FileOutputStream tos=new FileOutputStream(tmpFile);
    IOUtils.copy(is,tos);
    IOUtils.closeQuietly(is);
    IOUtils.closeQuietly(tos);
    FileUtils.moveFile(tmpFile,baseLocalFile);
  }
  finally {
    try {
      if (workArea != null) {
        broadleafFileService.closeWorkArea(workArea);
      }
    }
 catch (    Throwable e) {
    }
  }
}
