{
  String baseDirectory=getBaseDirectory();
  StringBuilder fileName=new StringBuilder(fixPath(baseDirectory));
  BroadleafRequestContext brc=BroadleafRequestContext.getBroadleafRequestContext();
  if (brc != null) {
    Site site=brc.getSite();
    if (site != null && !useSharedFile) {
      String siteDirectory="/site-" + site.getId();
      String siteHash=DigestUtils.md5Hex(siteDirectory);
      fileName=fileName.append("/").append(siteHash.substring(0,2)).append(siteDirectory);
    }
  }
  String fileHash=DigestUtils.md5Hex(fullUrl);
  for (int i=0; i < assetServerMaxGeneratedDirectories; i++) {
    if (i == 4) {
      LOG.warn("Property assetServerMaxGeneratedDirectories set to high, ignoring values past 4 - value set to" + assetServerMaxGeneratedDirectories);
      break;
    }
    fileName=fileName.append("/").append(fileHash.substring(i * 2,(i + 1) * 2));
  }
  int pos=fullUrl.lastIndexOf("/");
  if (pos >= 0) {
    fileName=fileName.append(fullUrl.substring(pos));
  }
 else {
    fileName=fileName.append("/").append(fullUrl);
  }
  return fileName.toString();
}
