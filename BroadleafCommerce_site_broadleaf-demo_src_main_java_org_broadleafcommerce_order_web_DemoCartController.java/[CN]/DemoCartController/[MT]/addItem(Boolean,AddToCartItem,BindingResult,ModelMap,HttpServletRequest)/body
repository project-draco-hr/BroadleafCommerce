{
  if (ajax == null) {
    ajax=false;
  }
  Order currentCartOrder=retrieveCartOrder(request,model);
  List<OrderItem> orderItemsAdded=new ArrayList<OrderItem>();
  if (addToCartItem.getQuantity() > 0) {
    try {
      OrderItem orderItem;
      if (addToCartItem.getSkuId() == 180) {
        BundleOrderItemRequest itemRequest=new BundleOrderItemRequest();
        DiscreteOrderItemRequest discreteRequest1=cartService.createDiscreteOrderItemRequest(addToCartItem.getSkuId(),addToCartItem.getProductId(),addToCartItem.getCategoryId(),addToCartItem.getQuantity());
        DiscreteOrderItemRequest discreteRequest2=cartService.createDiscreteOrderItemRequest(11L,null,null,addToCartItem.getQuantity());
        itemRequest.getDiscreteOrderItems().add(discreteRequest1);
        itemRequest.getDiscreteOrderItems().add(discreteRequest2);
        itemRequest.setName("Havaletta Bundle");
        itemRequest.setQuantity(1);
        if (addToCartItem.getOrderId() != null) {
          orderItem=cartService.addBundleItemToOrder(cartService.findOrderById(addToCartItem.getOrderId()),itemRequest);
        }
 else {
          orderItem=cartService.addBundleItemToOrder(currentCartOrder,itemRequest);
        }
      }
 else {
        if (addToCartItem.getOrderId() != null) {
          orderItem=cartService.addSkuToOrder(addToCartItem.getOrderId(),addToCartItem.getSkuId(),addToCartItem.getProductId(),addToCartItem.getCategoryId(),addToCartItem.getQuantity());
        }
 else {
          orderItem=cartService.addSkuToOrder(currentCartOrder.getId(),addToCartItem.getSkuId(),addToCartItem.getProductId(),addToCartItem.getCategoryId(),addToCartItem.getQuantity());
        }
      }
      orderItemsAdded.add(orderItem);
    }
 catch (    PricingException e) {
      LOG.error("Unable to price the order: (" + currentCartOrder.getId() + ")",e);
    }
  }
  model.addAttribute("orderItemsAdded",orderItemsAdded);
  if (!ajax) {
    return addItemViewRedirect ? "redirect:" + addItemView : addItemView;
  }
 else {
    return "catalog/fragments/addToCartModal";
  }
}
