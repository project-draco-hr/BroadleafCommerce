{
  Customer customer;
  customer=(Customer)request.getAttribute(getAnonymousCustomerSessionAttributeName(),WebRequest.SCOPE_GLOBAL_SESSION);
  if (customer == null) {
    Long customerId=(Long)request.getAttribute(getAnonymousCustomerIdSessionAttributeName(),WebRequest.SCOPE_GLOBAL_SESSION);
    if (customerId != null) {
      customer=customerService.readCustomerById(customerId);
    }
    if (customer == null) {
      customer=customerService.createNewCustomer();
      request.setAttribute(getAnonymousCustomerSessionAttributeName(),customer,WebRequest.SCOPE_GLOBAL_SESSION);
    }
  }
  customer.setAnonymous(true);
  return customer;
}
