{
  customer.setRegistered(true);
  if (customer.getId() == null) {
    customer.setId(idGenerationService.findNextId("org.broadleafcommerce.profile.core.domain.Customer"));
  }
  customer.setUnencodedPassword(password);
  Customer retCustomer=saveCustomer(customer);
  Role role=roleDao.readRoleByName("ROLE_USER");
  CustomerRole customerRole=new CustomerRoleImpl();
  customerRole.setRole(role);
  customerRole.setCustomer(retCustomer);
  roleDao.addRoleToCustomer(customerRole);
  HashMap<String,Object> vars=new HashMap<String,Object>();
  vars.put("customer",retCustomer);
  emailService.sendTemplateEmail(customer.getEmailAddress(),getRegistrationEmailInfo(),vars);
  notifyPostRegisterListeners(retCustomer);
  return retCustomer;
}
