{
  clearOffersandAdjustments(order);
  List<Offer> filteredOffers=filterOffers(offers,order.getCustomer());
  if ((filteredOffers == null) || (filteredOffers.isEmpty())) {
    order.assignOrderItemsFinalPrice();
    order.setSubTotal(order.calculateOrderItemsFinalPrice());
  }
 else {
    List<CandidateOrderOffer> qualifiedOrderOffers=new ArrayList<CandidateOrderOffer>();
    List<CandidateFulfillmentGroupOffer> qualifiedFGOffers=new ArrayList<CandidateFulfillmentGroupOffer>();
    List<CandidateItemOffer> qualifiedItemOffers=new ArrayList<CandidateItemOffer>();
    order.setSubTotal(order.calculateOrderItemsCurrentPrice());
    List<OrderItem> discreteOrderItems=order.getDiscountableDiscreteOrderItems();
    for (    Offer offer : filteredOffers) {
      if (offer.getType().equals(OfferType.ORDER)) {
        orderOfferProcessor.filterOrderLevelOffer(order,qualifiedOrderOffers,discreteOrderItems,offer);
      }
 else       if (offer.getType().equals(OfferType.ORDER_ITEM)) {
        itemOfferProcessor.filterItemLevelOffer(order,qualifiedItemOffers,discreteOrderItems,offer);
      }
 else       if (offer.getType().equals(OfferType.FULFILLMENT_GROUP)) {
        fulfillmentGroupOfferProcessor.filterFulfillmentGroupLevelOffer(order,qualifiedFGOffers,discreteOrderItems,offer);
      }
    }
    if ((qualifiedItemOffers.isEmpty()) && (qualifiedOrderOffers.isEmpty())) {
      order.assignOrderItemsFinalPrice();
      order.setSubTotal(order.calculateOrderItemsFinalPrice());
    }
 else {
      if (!qualifiedItemOffers.isEmpty()) {
        Collections.sort(qualifiedItemOffers,OfferComparator.INSTANCE);
        itemOfferProcessor.applyAllItemOffers(qualifiedItemOffers,discreteOrderItems);
      }
      if (!qualifiedOrderOffers.isEmpty()) {
        Collections.sort(qualifiedOrderOffers,new BeanComparator("discountAmount",Collections.reverseOrder()));
        Collections.sort(qualifiedOrderOffers,new BeanComparator("priority"));
        qualifiedOrderOffers=removeTrailingNotCombinableOrderOffers(qualifiedOrderOffers);
        applyAllOrderOffers(qualifiedOrderOffers,order);
      }
      order.assignOrderItemsFinalPrice();
      order.setSubTotal(order.calculateOrderItemsFinalPrice());
      if ((!qualifiedOrderOffers.isEmpty()) && (!qualifiedItemOffers.isEmpty())) {
        List<CandidateOrderOffer> finalQualifiedOrderOffers=new ArrayList<CandidateOrderOffer>();
        order.removeAllOrderAdjustments();
        for (        CandidateOrderOffer condidateOrderOffer : qualifiedOrderOffers) {
        }
        Collections.sort(finalQualifiedOrderOffers,new BeanComparator("discountedPrice"));
        Collections.sort(finalQualifiedOrderOffers,new BeanComparator("priority"));
        if (!finalQualifiedOrderOffers.isEmpty()) {
          applyAllOrderOffers(finalQualifiedOrderOffers,order);
        }
      }
    }
  }
}
