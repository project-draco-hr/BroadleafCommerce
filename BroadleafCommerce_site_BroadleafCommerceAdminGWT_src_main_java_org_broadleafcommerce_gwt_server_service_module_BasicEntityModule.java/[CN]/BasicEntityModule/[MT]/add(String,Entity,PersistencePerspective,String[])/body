{
  try {
    for (    CustomPersistenceHandler handler : customPersistenceHandlers) {
      if (handler.canHandleAdd(entity.getType()[0],customCriteria)) {
        Entity response=handler.add(entity,persistencePerspective,customCriteria,dynamicEntityDao,this);
        return response;
      }
    }
    Class<?>[] entities=dynamicEntityRemoteService.getPolymorphicEntities(entity.getType()[0]);
    Map<String,FieldMetadata> mergedProperties=dynamicEntityDao.getMergedProperties(entity.getType()[0],entities,(ForeignKey)persistencePerspective.getPersistencePerspectiveItems().get(PersistencePerspectiveItemType.FOREIGNKEY),persistencePerspective.getAdditionalNonPersistentProperties(),persistencePerspective.getAdditionalForeignKeys(),MergedPropertyType.PRIMARY,persistencePerspective.getPopulateManyToOneFields(),persistencePerspective.getIncludeFields(),persistencePerspective.getExcludeFields(),null);
    String idProperty=null;
    for (    String property : mergedProperties.keySet()) {
      if (mergedProperties.get(property).getFieldType().equals(SupportedFieldType.ID)) {
        idProperty=property;
        break;
      }
    }
    if (idProperty == null) {
      throw new RuntimeException("Could not find a primary key property in the passed entity with type: " + entity.getType());
    }
    Object primaryKey=null;
    for (    Property property : entity.getProperties()) {
      if (property.getName().equals(idProperty)) {
        if (!StringUtils.isEmpty(property.getValue())) {
          primaryKey=property.getValue();
        }
        break;
      }
    }
    if (primaryKey == null) {
      Serializable instance=(Serializable)Class.forName(entity.getType()[0]).newInstance();
      instance=createPopulatedInstance(instance,entity,mergedProperties,false);
      instance=dynamicEntityDao.persist(instance);
      List<Serializable> entityList=new ArrayList<Serializable>();
      entityList.add(instance);
      return getRecords(mergedProperties,entityList,null,null)[0];
    }
 else {
      return update(entity,primaryKey,persistencePerspective,customCriteria);
    }
  }
 catch (  ServiceException e) {
    LOG.error("Problem adding new entity",e);
    throw e;
  }
catch (  Exception e) {
    LOG.error("Problem adding new entity",e);
    throw new ServiceException("Problem adding new entity : " + e.getMessage(),e);
  }
}
