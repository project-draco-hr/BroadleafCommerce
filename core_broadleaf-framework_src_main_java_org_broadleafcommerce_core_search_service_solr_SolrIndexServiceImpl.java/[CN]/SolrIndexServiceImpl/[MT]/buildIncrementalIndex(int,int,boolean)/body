{
  TransactionStatus status=TransactionUtils.createTransaction("readItemsToIndex",TransactionDefinition.PROPAGATION_REQUIRED,transactionManager,true);
  if (LOG.isDebugEnabled()) {
    LOG.debug(String.format("Building index - page: [%s], pageSize: [%s]",page,pageSize));
  }
  StopWatch s=new StopWatch();
  try {
    Collection<SolrInputDocument> documents=new ArrayList<SolrInputDocument>();
    List<Locale> locales=getAllLocales();
    if (useSku) {
      List<Sku> skus=readAllActiveSkus(page,pageSize);
    }
 else {
      List<Product> products=readAllActiveProducts(page,pageSize);
      List<Field> fields=fieldDao.readAllProductFields();
      for (      Product product : products) {
        SolrInputDocument doc=buildDocument(product,fields,locales);
        if (doc != null) {
          documents.add(doc);
        }
      }
    }
    logDocuments(documents);
    if (!CollectionUtils.isEmpty(documents)) {
      SolrServer server=useReindexServer ? SolrContext.getReindexServer() : SolrContext.getServer();
      server.add(documents);
      server.commit();
    }
    TransactionUtils.finalizeTransaction(status,transactionManager,false);
  }
 catch (  SolrServerException e) {
    TransactionUtils.finalizeTransaction(status,transactionManager,true);
    throw new ServiceException("Could not rebuild index",e);
  }
catch (  IOException e) {
    TransactionUtils.finalizeTransaction(status,transactionManager,true);
    throw new ServiceException("Could not rebuild index",e);
  }
catch (  RuntimeException e) {
    TransactionUtils.finalizeTransaction(status,transactionManager,true);
    throw e;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug(String.format("Built index - page: [%s], pageSize: [%s] in [%s]",page,pageSize,s.toLapString()));
  }
}
