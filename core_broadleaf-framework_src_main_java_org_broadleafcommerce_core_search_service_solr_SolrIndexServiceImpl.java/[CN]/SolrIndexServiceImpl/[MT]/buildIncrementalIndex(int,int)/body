{
  DefaultTransactionDefinition def=new DefaultTransactionDefinition();
  def.setName("saveOrder");
  def.setReadOnly(true);
  def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
  TransactionStatus status=transactionManager.getTransaction(def);
  LOG.trace(String.format("Building index - page: [%s], pageSize: [%s]",page,pageSize));
  StopWatch s=new StopWatch();
  try {
    List<Product> products=readAllActiveProducts(page,pageSize);
    List<Field> fields=fieldDao.readAllProductFields();
    List<Locale> locales=getAllLocales();
    Collection<SolrInputDocument> documents=new ArrayList<SolrInputDocument>();
    for (    Product product : products) {
      documents.add(buildDocument(product,fields,locales));
    }
    if (LOG.isTraceEnabled()) {
      for (      SolrInputDocument document : documents) {
        LOG.trace(document);
      }
    }
    if (!CollectionUtils.isEmpty(documents)) {
      SolrContext.getReindexServer().add(documents);
      SolrContext.getReindexServer().commit();
    }
    finalizeTransaction(status,false);
  }
 catch (  SolrServerException e) {
    finalizeTransaction(status,true);
    throw new ServiceException("Could not rebuild index",e);
  }
catch (  IOException e) {
    finalizeTransaction(status,true);
    throw new ServiceException("Could not rebuild index",e);
  }
catch (  RuntimeException e) {
    finalizeTransaction(status,true);
    throw e;
  }
  LOG.trace(String.format("Built index - page: [%s], pageSize: [%s] in [%s]",page,pageSize,s.toLapString()));
}
