{
  LOG.info("Rebuilding the solr index...");
  StopWatch s=new StopWatch();
  if (SolrContext.isSingleCoreMode()) {
    SolrIndexServiceImpl.this.deleteAllDocuments();
  }
  Object[] pack=saveState();
  try {
    final Long numItemsToIndex;
    if (useSku) {
      numItemsToIndex=skuDao.readCountAllActiveSkus();
    }
 else {
      numItemsToIndex=productDao.readCountAllActiveProducts();
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("There are at most " + numItemsToIndex + " items to index");
    }
    performCachedOperation(new SolrIndexCachedOperation.CacheOperation(){
      @Override public void execute() throws ServiceException {
        int page=0;
        while ((page * pageSize) < numItemsToIndex) {
          buildIncrementalIndex(page,pageSize);
          page++;
        }
      }
    }
);
    optimizeIndex(SolrContext.getReindexServer());
  }
  finally {
    restoreState(pack);
  }
  shs.swapActiveCores();
  if (!SolrContext.isSingleCoreMode()) {
    deleteAllDocuments();
  }
  LOG.info(String.format("Finished building index in %s",s.toLapString()));
}
