{
  boolean legacy=parentCategoryLegacyModeService.isLegacyMode();
  if (!legacy) {
    FilterAndSortCriteria fsc=cto.getCriteriaMap().get("defaultCategory");
    if (fsc != null) {
      List<String> filterValues=fsc.getFilterValues();
      cto.getCriteriaMap().remove("defaultCategory");
      FilterMapping filterMapping=new FilterMapping().withFieldPath(new FieldPath().withTargetProperty("allParentCategoryXrefs.category.id")).withDirectFilterValues(filterValues).withRestriction(new Restriction().withPredicateProvider(new PredicateProvider(){
        @Override public Predicate buildPredicate(        CriteriaBuilder builder,        FieldPathBuilder fieldPathBuilder,        From root,        String ceilingEntity,        String fullPropertyName,        Path explicitPath,        List directValues){
          Subquery<Long> sub=fieldPathBuilder.getCriteria().subquery(Long.class);
          Root<CategoryProductXrefImpl> subRoot=sub.from(CategoryProductXrefImpl.class);
          sub.select(subRoot.get("category").get("id").as(Long.class));
          List<Predicate> subRestrictions=new ArrayList<Predicate>();
          subRestrictions.add(builder.equal(subRoot.get("defaultReference"),Boolean.TRUE));
          subRestrictions.add(subRoot.get("category").get("id").in(directValues));
          sub.where(subRestrictions.toArray(new Predicate[subRestrictions.size()]));
          return explicitPath.in(sub);
        }
      }
));
      cto.getAdditionalFilterMappings().add(filterMapping);
    }
  }
  cto.getNonCountAdditionalFilterMappings().add(new FilterMapping().withDirectFilterValues(new EmptyFilterValues()).withRestriction(new Restriction().withPredicateProvider(new PredicateProvider(){
    public Predicate buildPredicate(    CriteriaBuilder builder,    FieldPathBuilder fieldPathBuilder,    From root,    String ceilingEntity,    String fullPropertyName,    Path explicitPath,    List directValues){
      root.fetch("defaultSku",JoinType.LEFT);
      root.fetch("defaultCategory",JoinType.LEFT);
      return null;
    }
  }
)));
  return helper.getCompatibleModule(OperationType.BASIC).fetch(persistencePackage,cto);
}
