{
  for (  FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
    for (    FulfillmentGroupItem fgItem : fulfillmentGroup.getFulfillmentGroupItems()) {
      if (isItemTaxable(fgItem)) {
        Double factor=determineItemTaxRate(fulfillmentGroup.getAddress());
        if (factor != null && factor.compareTo(0d) != 0) {
          TaxDetail tax;
          checkDetail: {
            for (            TaxDetail detail : fgItem.getTaxes()) {
              if (detail.getType().equals(TaxType.COMBINED)) {
                tax=detail;
                break checkDetail;
              }
            }
            tax=new TaxDetailImpl();
            tax.setType(TaxType.COMBINED);
            fgItem.getTaxes().add(tax);
          }
          tax.setRate(new BigDecimal(factor));
          tax.setAmount(fgItem.getTotalItemTaxableAmount().multiply(factor));
        }
      }
    }
    for (    FulfillmentGroupFee fgFee : fulfillmentGroup.getFulfillmentGroupFees()) {
      if (isFeeTaxable(fgFee)) {
        Double factor=determineItemTaxRate(fulfillmentGroup.getAddress());
        if (factor != null && factor.compareTo(0d) != 0) {
          TaxDetail tax;
          checkDetail: {
            for (            TaxDetail detail : fgFee.getTaxes()) {
              if (detail.getType().equals(TaxType.COMBINED)) {
                tax=detail;
                break checkDetail;
              }
            }
            tax=new TaxDetailImpl();
            tax.setType(TaxType.COMBINED);
            fgFee.getTaxes().add(tax);
          }
          tax.setRate(new BigDecimal(factor));
          tax.setAmount(fgFee.getAmount().multiply(factor));
        }
      }
    }
    Double factor=determineTaxRateForFulfillmentGroup(fulfillmentGroup);
    if (factor != null && factor.compareTo(0d) != 0) {
      TaxDetail tax;
      checkDetail: {
        for (        TaxDetail detail : fulfillmentGroup.getTaxes()) {
          if (detail.getType().equals(TaxType.COMBINED)) {
            tax=detail;
            break checkDetail;
          }
        }
        tax=new TaxDetailImpl();
        tax.setType(TaxType.COMBINED);
        fulfillmentGroup.getTaxes().add(tax);
      }
      tax.setRate(new BigDecimal(factor));
      tax.setAmount(fulfillmentGroup.getFulfillmentPrice().multiply(factor));
    }
  }
  return order;
}
