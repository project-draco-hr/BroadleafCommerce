{
  Money subTotal=order.calculateOrderItemsFinalPrice(false);
  for (  FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
    for (    FulfillmentGroupFee fulfillmentGroupFee : fulfillmentGroup.getFulfillmentGroupFees()) {
      if (fulfillmentGroupFee.isTaxable()) {
        subTotal=subTotal.add(fulfillmentGroupFee.getAmount());
      }
    }
  }
  Money totalTax=subTotal.multiply(factor);
  for (  FulfillmentGroup fulfillmentGroup : order.getFulfillmentGroups()) {
    Money fgTotalTax;
    if (fulfillmentGroup.isShippingPriceTaxable() == null || fulfillmentGroup.isShippingPriceTaxable()) {
      fgTotalTax=fulfillmentGroup.getShippingPrice().multiply(factor);
    }
 else {
      fgTotalTax=new Money(0D);
    }
    fulfillmentGroup.setTotalTax(fgTotalTax);
    fulfillmentGroup.setCityTax(new Money(0D));
    fulfillmentGroup.setStateTax(new Money(0D));
    fulfillmentGroup.setDistrictTax(new Money(0D));
    fulfillmentGroup.setCountyTax(new Money(0D));
    fulfillmentGroup.setCountryTax(new Money(0D));
    totalTax=totalTax.add(fgTotalTax);
  }
  order.setCityTax(new Money(0D));
  order.setStateTax(new Money(0D));
  order.setDistrictTax(new Money(0D));
  order.setCountyTax(new Money(0D));
  order.setCountryTax(new Money(0D));
  order.setTotalTax(totalTax);
  return order;
}
