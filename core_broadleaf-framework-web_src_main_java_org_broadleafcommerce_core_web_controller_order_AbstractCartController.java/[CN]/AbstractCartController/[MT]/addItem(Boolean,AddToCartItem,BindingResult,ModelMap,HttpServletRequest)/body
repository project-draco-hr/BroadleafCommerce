{
  if (ajax == null) {
    ajax=false;
  }
  Order currentCartOrder=retrieveCartOrder(request,model);
  List<OrderItem> orderItemsAdded=new ArrayList<OrderItem>();
  if (addToCartItem.getQuantity() > 0) {
    try {
      OrderItem orderItem;
      if (addToCartItem.getOrderId() != null) {
        orderItem=cartService.addSkuToOrder(addToCartItem.getOrderId(),addToCartItem.getSkuId(),addToCartItem.getProductId(),addToCartItem.getCategoryId(),addToCartItem.getQuantity(),addToCartItem.getAdditionalAttributes());
      }
 else {
        orderItem=cartService.addSkuToOrder(currentCartOrder.getId(),addToCartItem.getSkuId(),addToCartItem.getProductId(),addToCartItem.getCategoryId(),addToCartItem.getQuantity(),addToCartItem.getAdditionalAttributes());
      }
      orderItemsAdded.add(orderItem);
    }
 catch (    PricingException e) {
      LOG.error("Unable to price the order: (" + currentCartOrder.getId() + ")",e);
    }
  }
  model.addAttribute("orderItemsAdded",orderItemsAdded);
  if (!ajax) {
    return addItemViewRedirect ? "redirect:" + addItemView : addItemView;
  }
 else {
    return "catalog/fragments/addToCartModal";
  }
}
