{
  if (ajax == null) {
    ajax=false;
  }
  Order currentCartOrder=retrieveCartOrder(request,model);
  if (addToCartItem.getQuantity() != null && addToCartItem.getQuantity() > 0) {
    try {
      Order order;
      if (addToCartItem.getOrderId() != null) {
        order=cartService.addItemToOrder(addToCartItem.getOrderId(),addToCartItem,true);
      }
 else {
        order=cartService.addItemToOrder(currentCartOrder.getId(),addToCartItem,true);
      }
      model.addAttribute("order",order);
    }
 catch (    PricingException e) {
      LOG.error("Unable to price the order: (" + currentCartOrder.getId() + ")",e);
    }
  }
  if (!ajax) {
    return addItemViewRedirect ? "redirect:" + addItemView : addItemView;
  }
 else {
    return "catalog/fragments/addToCartModal";
  }
}
