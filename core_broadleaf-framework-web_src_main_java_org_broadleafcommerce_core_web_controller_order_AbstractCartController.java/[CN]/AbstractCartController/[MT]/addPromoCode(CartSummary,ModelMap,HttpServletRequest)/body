{
  Order currentCartOrder=retrieveCartOrder(request,model);
  if (cartSummary.getPromoCode() != null) {
    OfferCode code=offerService.lookupOfferCodeByCode(cartSummary.getPromoCode());
    if (code != null) {
      try {
        currentCartOrder=cartService.addOfferCode(currentCartOrder,code,true);
      }
 catch (      OfferMaxUseExceededException e) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Customer exceeded max uses for offer code " + code);
        }
        model.addAttribute("promoError","That offer code has been used the maximum allowed number of times.");
      }
      currentCartOrder=updateFulfillmentGroups(cartSummary,currentCartOrder);
    }
 else {
      model.addAttribute("promoError","Invalid promo code entered.");
    }
  }
  if (currentCartOrder.getOrderItems() != null) {
    cartSummary.getRows().clear();
    for (    OrderItem orderItem : currentCartOrder.getOrderItems()) {
      CartOrderItem cartOrderItem=new CartOrderItem();
      cartOrderItem.setOrderItem(orderItem);
      cartOrderItem.setQuantity(orderItem.getQuantity());
      cartSummary.getRows().add(cartOrderItem);
    }
  }
  cartSummary.setPromoCode(null);
  model.addAttribute("currentCartOrder",currentCartOrder);
  model.addAttribute("cartSummary",cartSummary);
  return "redirect:/basket/viewCart.htm";
}
